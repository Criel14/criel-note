ç”²è›™2306é¡¹ç›®å­¦ä¹ ç¬”è®°ï¼Œä¸­é—´ä»¶éƒ¨åˆ†ç»“åˆäº†é»‘é©¬å•†åŸé‡Œçš„æ•™å­¦å†…å®¹ï¼Œä¸­é—´ä»¶éƒ¨åˆ†æ˜¯ä»å…¶ä»–åœ°æ–¹æ•´ç†çš„



# è®¾è®¡

## æ¦‚è¦

### æŠ€æœ¯

- åç«¯ï¼šSpringboot3ï¼ˆJDK17ï¼‰
- å‰ç«¯ï¼šVue CLI5 + Vue3
- é«˜å¹¶å‘æŠ€æœ¯ï¼š
  - å‰ç«¯ï¼šCDNåˆ†æµï¼›
  - åç«¯ï¼šåˆ†å¸ƒå¼ç¼“å­˜ï¼›
  - å‰åç«¯ä¸¤å±‚éªŒè¯ç ï¼›
  - é™æµæŠ€æœ¯ã€ä»¤ç‰ŒæŠ€æœ¯ã€åˆ†å¸ƒé”ã€å¼‚æ­¥å‰Šå³°ã€æ’é˜Ÿæœºåˆ¶ã€åˆ†å¸ƒå¼äº‹åŠ¡

### é¡¹ç›®ç‰¹ç‚¹

- ç‰¹ç‚¹

  - åŠ¨æ€åº“å­˜
    - ä¸€æ®µè·¯å¯èƒ½å–å¤šå¼ ç¥¨

  - é€‰åº§

  - çº¿ä¸Šå’Œçº¿ä¸‹è´­ä¹°

  - é«˜å¹¶å‘è®¾è®¡
    - æŒç»­åˆ·ç¥¨ï¼Œæ²¡ç¥¨ä¹Ÿä¼šæœ‰å¾ˆé«˜çš„å¹¶å‘æ€§
    - æœç»è¶…å–

  - ä¸€å¤©å¤šæ¬¡æ”¾ç¥¨ï¼Œå¤šæ¬¡é«˜å³°

- è§£å†³å¿™ç¢Œ
  - æé«˜QPS/TPS
    - ç¡¬ä»¶
    - Gemfireï¼ˆä¸€ä¸ªåˆ†å¸ƒå¼å†…å­˜æ•°æ®åº“ï¼‰
    - æ”¹è¿›ç®—æ³•
  - å‰Šå³°
    - ä¸šåŠ¡
      - éªŒè¯ç 
      - åˆ†æ—¶æ®µæ”¾ç¥¨
      - æ’é˜Ÿ
    - æŠ€æœ¯
      - é™æµ
      - å¼‚æ­¥



### æ¨¡å‹è®¾è®¡ï¼Ÿ

- ä½™ç¥¨æŸ¥è¯¢ï¼ˆåŸå­æ€§ï¼‰

  - è®°å½•ç«™toç«™ä½™ç¥¨
    - 5ä¸ªç«™æœ‰$C_{5}^{2} = 10$ä¸ªç«™toç«™ç¥¨
    - ä¾‹å¦‚ABCDEç«™æœ‰2å¼ ç¥¨ï¼Œé€‰äº†ABï¼Œå†é€‰ADå°±åªè¦1å¼ ç¥¨äº†ï¼Œå¦‚æœå†é€‰DEåˆ™æœ‰2å¼ ç¥¨ï¼›æ³¨æ„é€‰äº†ABå’ŒDEåï¼Œè¿˜å¯ä»¥å†é€‰AD...
    - ä¸èƒ½å•çº¯åœ°æŠŠä¹°äº†ä¹‹åæ‰€åœ¨çš„åŒºé—´çš„åº“å­˜-1ï¼Œå¯èƒ½ä¼šå¯¼è‡´å°‘å–

- åº§ä½è´­ä¹°ï¼ˆåŸå­æ€§ï¼‰

  - è®°å½•æ¯ä¸ªåº§ä½çš„é”€å”®è¯¦æƒ…
    - ä¾‹å¦‚ABCEDç«™ï¼Œ4ä¸ªåŒºé—´ï¼Œéƒ½æœ‰ç¥¨åˆ™å¯ä»¥è®°ä¸º0000

  

### æ ¸å¿ƒåŠŸèƒ½

![](image/æ ¸å¿ƒåŠŸèƒ½.png)



### æ¨¡å—åˆ’åˆ†

- **gatway** ç½‘å…³æ¨¡å—
  - è·¯ç”±è½¬å‘
  - ç™»å½•æ ¡éªŒ
- **member** ä¼šå‘˜æ¨¡å—
  - ä¼šå‘˜ã€ä¹˜å®¢ã€å·²è´­ä¹°çš„è½¦ç¥¨
- **business** ä¸šåŠ¡æ¨¡å—
  - æ‰€æœ‰çš„è½¦æ¬¡æ•°æ®
  - ä½™ç¥¨ä¿¡æ¯
- **batch** è·‘æ‰¹æ¨¡å—ï¼ˆå®šæ—¶ä»»åŠ¡æ¨¡å—ï¼‰
  - ç®¡ç†å®šæ—¶ä»»åŠ¡ï¼Œç•Œé¢å¯åœ
- web æ¨¡å—
  - ä¼šå‘˜ç›¸å…³ç•Œé¢
- admin æ¨¡å—
  - ç®¡ç†å‘˜ç›¸å…³ç•Œé¢

æ ¸å¿ƒï¼šä½™ç¥¨æŸ¥è¯¢ï¼Œå¯ä»¥è€ƒè™‘åšä¸€ä¸ªæ¨¡å—ï¼Œä¸ºå…¶åˆ†é…æ›´å¤šèµ„æºï¼ˆæœ¬é¡¹ç›®æ²¡æœ‰ï¼‰



### ç³»ç»Ÿæ¶æ„è®¾è®¡

- ä¼šå‘˜ã€ä¸šåŠ¡ã€è·‘æ‰¹åˆ†åˆ«å¯¹åº”ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åº“

- ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå3ä¸ªéƒ½æ˜¯SpringCloud Alibabaçš„å¾®æœåŠ¡ç»„ä»¶ï¼‰
  - redis - ç¼“å­˜
  - rocketmq - å¼‚æ­¥å‰Šå³°
  - nacos - é…ç½®ä¸­å¿ƒ
  - seata - åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¾‹å¦‚åŒæ—¶åœ¨2ä¸ªä¸åŒæ¨¡å—ä¿å­˜ä¸€æ®µæ•°æ®ï¼‰
  - sentinel - é™æµ

![](image/ç³»ç»Ÿæ¶æ„.png)



### æŒç»­ç§’æ€é«˜å¹¶å‘

- å‰ç«¯
  - CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰
    - ä¸åŒç”¨æˆ·ä»ä¸åŒåœ°åŒºçš„ç»“ç‚¹è·å–èµ„æº
  - é¡µé¢é™æ€åŒ–
  - å€’è®¡æ—¶
    - å‡å°‘ç”¨æˆ·ä¸æ–­åˆ·æ–°é¡µé¢çš„è¡Œä¸º
  - Loadingç•Œé¢
    - é˜²æ­¢ç”¨æˆ·ç‚¹å‡»æäº¤æŒ‰é’®ååœ¨åŠ è½½è¿‡ç¨‹ä¸­ä¸æ–­ç‚¹å‡»æäº¤æŒ‰é’®
  - éªŒè¯ç å‰Šå³° 
    - ä¸åŒäººåšéªŒè¯ç çš„æ—¶é—´ä¸ä¸€æ ·
- åç«¯
  - å¾®æœåŠ¡-æœåŠ¡æ‹†åˆ†
    - æŒ‰æ¨¡å—æ‹†åˆ†
    - çƒ­ç‚¹æ¥å£åšæˆå•ç‹¬æœåŠ¡ï¼Œä¾‹å¦‚çœŸæ­£12306çš„ä½™ç¥¨æŸ¥è¯¢
  - è´Ÿè½½å‡è¡¡
    - å¤šä¸ªç»“ç‚¹
  - é™æµé™çº§
    - é™åˆ¶æµé‡+åå¤‡æœåŠ¡æ–¹æ¡ˆé˜²æ­¢æŸä¸ªæœåŠ¡ä¸å¯ç”¨
  - ç¼“å­˜
    - æœ¬åœ°ç¼“å­˜
    - åˆ†å¸ƒå¼ç¼“å­˜
    - éœ€æ³¨æ„â€œç¼“å­˜å‡»ç©¿ã€ç¼“å­˜ç©¿é€ã€ç¼“å­˜é›ªå´©â€
  - ä»¤ç‰Œ
    - é˜²æœºå™¨äºº
  - å¼‚æ­¥å¤„ç†
- æ•°æ®åº“
  - åˆ†åº“
    - ä¸šåŠ¡åˆ†åº“
    - è¯»å†™åˆ†ç¦»ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰
  - åˆ†è¡¨
    - æ¨ªå‘åˆ†è¡¨ï¼šæŒ‰åœ°åŒºã€æ—¶é—´ç­‰åˆ†
    - çºµå‘åˆ†è¡¨ï¼šåˆ‡å¼€è¡¨
  - å†—ä½™è®¾è®¡ï¼ˆåèŒƒå¼ï¼‰
    - ç©ºé—´æ¢æ—¶é—´
  - åˆ†å¸ƒå¼æ•°æ®åº“
    - ä¾‹å¦‚çœŸæ­£12306çš„Gemfire
- å…¶ä»–
  - åˆ†æ—¶æ®µç§’æ€
  - å¼¹æ€§æ‰©å®¹
  - å€™è¡¥+æ’é˜Ÿ



## æ•°æ®åº“è¡¨è®¾è®¡
### æ•°æ®åº“è¡¨

éƒ¨åˆ†å†…å®¹åšäº†å†—ä½™ï¼Œå¯ä»¥æ–¹ä¾¿ä¸ç”¨ä¸€æ¬¡æŸ¥è¯¢å¤šå¼ è¡¨

![](image/æ•°æ®åº“è¡¨1.png)

![](image/æ•°æ®åº“è¡¨2.png)

çº¦å®šï¼šæ•°æ®åº“ä¸­çš„åºå·ï¼Œå¦‚ç«™åºã€åº§ä½åœ¨è½¦å¢å†…çš„åºå·ç­‰ï¼Œéƒ½æ˜¯**ä»1å¼€å§‹**

- æ•°æ®åº“**train_member**
  - ä¹˜è½¦äººè¡¨
    - passenger
  - ç”¨æˆ·è¡¨
    - member
  - è´­ç¥¨ä¿¡æ¯ï¼ˆå·²è´­è½¦ç¥¨ï¼‰
    - ticket
- æ•°æ®åº“**train_business**
  - æ¯æ—¥æ•°æ®è¡¨
    - daily_train æ¯æ—¥è½¦æ¬¡
    - daily_train_carriage æ¯æ—¥è½¦å¢
    - daily_train_station æ¯æ—¥è½¦æ¬¡å¯¹åº”è½¦ç«™
    - daily_train_seat æ¯æ—¥åº§ä½
      - **sell**åˆ—ï¼Œç”¨0å’Œ1è¡¨ç¤ºæ¯ä¸ªåŒºé—´æ˜¯å¦å·²ç»å”®å‡ºï¼Œä¾‹å¦‚5ä¸ªç«™ï¼Œåˆ™4ä¸ªåŒºé—´ï¼Œè‹¥ä¸€äºŒç«™åŒºé—´å”®å‡ºäº†ï¼Œé‚£ä¹ˆå°±æ˜¯**â€1000â€œ**
    - daily_train_ticket æ¯æ—¥ä½™ç¥¨
      - è®°å½•äº†æŸæ—¥æŸè½¦æ¬¡ï¼Œä»æŸç«™åˆ°æŸç«™è¿™ä¸ªåŒºé—´ï¼ŒæŸä¸ªç±»å‹è¿˜æœ‰å¤šå°‘ä½™ç¥¨ï¼ˆ**åŒºé—´å†…çš„ä½™ç¥¨ä¿¡æ¯**ï¼‰
      - ç›¸å½“äºå¯¹daily_train_seatä¸­çš„sellåˆ—å•ç‹¬åšäº†ä¸€å¼ è¡¨ï¼ˆè¡Œè½¬åˆ—ï¼‰ï¼Œå®é™…ä¸Šæ˜¯ç¼“å­˜çš„åŠŸèƒ½ï¼ŒçœŸæ­£çš„12306å°†ç±»ä¼¼è¿™ä¸ªè¡¨çš„ä¿¡æ¯æ”¾åœ¨Gemfireä¸­ï¼ˆç›¸å½“äºå†…å­˜ç‰ˆçš„mysqlï¼‰
      - redisåšä¸åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ”¾åœ¨mysqlé‡Œé¢äº†
  - åŸºæœ¬æ•°æ®è¡¨
    - train è½¦æ¬¡
    - station è½¦ç«™ 
    - train_carriage è½¦å¢
    - train_seat åº§ä½
    - train_station è½¦æ¬¡å¯¹åº”è½¦ç«™
  - è®¢å•è¡¨
    - confirm_order ç”¨æˆ·æäº¤çš„è®¢å•
      - åŒ…å«è®¢å•çŠ¶æ€ï¼Œé»˜è®¤æœªæˆåŠŸ
      - å…³è”ä¸Šdaily_train_ticket
      - å¯ç”¨äºç»Ÿè®¡ï¼Œç»Ÿè®¡ä»€ä¹ˆæ—¶æ®µæ˜¯é«˜å³°æœŸï¼Œä»€ä¹ˆè½¦æ¬¡ä¹°çš„äººå¤šç­‰



## Quartzå®šæ—¶ä»»åŠ¡è®¾è®¡

å®šæ—¶ä»»åŠ¡ç”¨äºç”Ÿæˆ15æ—¥åçš„æ•°æ®ï¼ŒåŸºæœ¬åŠŸèƒ½æ˜¯**æ ¹æ®æŒ‡å®šæ—¥æœŸç”Ÿæˆæ•°æ®**ï¼Œæœ‰ä»¥ä¸‹2ç§æƒ…å†µ

- é»˜è®¤ç”Ÿæˆ15å¤©åçš„æ•°æ®
- å‰ç«¯æŒ‡å®šæ—¥æœŸç”Ÿæˆ



## å‰åç«¯é€‰åº§è´­ç¥¨

### é€»è¾‘

é€‰åˆ™åº§ä½ä½ç½®çš„æ¡ä»¶ï¼š

- åªæœ‰å…¨éƒ¨æ˜¯ä¸€ç­‰åº§æˆ–å…¨éƒ¨æ˜¯äºŒç­‰åº§æ‰æ”¯æŒé€‰åº§ï¼ˆåŒ12306ï¼‰
- ä½™ç¥¨å°äºä¸€å®šæ•°é‡ï¼ˆæœ¬é¡¹ç›®ä¸­ä¸º20ï¼‰æ—¶ï¼Œä¸å…è®¸é€‰åº§

å‰ç«¯é€‰åº§ï¼š

![](image/å‰ç«¯é€‰åº§.png)

å¾—åˆ°çš„æ•°æ®å¦‚ä¸‹ï¼ˆä¸€ç­‰åº§ä¸ºä¾‹ï¼‰ï¼š

```javascript
{
    A1: false, C1: true, D1: false, F1: false,
    A2: false, C2: false. D2: true, F2: false
}
```

éœ€è¦è¯»å–å…¶trueçš„éƒ¨åˆ†æäº¤ç»™åç«¯

æœ€ç»ˆ**è´­ç¥¨ä¿¡æ¯**æäº¤ç»™åç«¯çš„æ•°æ®å¦‚ä¸‹ï¼š

```javascript
{
    passengerId: 123,
    passengerType: "1",
    passengerName: "å¼ ä¸‰",
    passengerIdCard: "12323132132",
    seatTypeCode: "1",
    seat: "C1" // å¯ä¸ºç©º
}
```

**åç«¯**å¯¹äºæ¯ä¸ªè½¦å¢ï¼Œéœ€è¦æœ‰å½¢å¦‚ä¸‹å›¾çš„æ•°æ®ï¼š

![](image/åº§ä½å”®å–è¯¦æƒ….png)

åº§ä½çš„`sell`å­—æ®µæ˜¯å½¢å¦‚`011001`è¿™æ ·çš„ï¼Œé‚£ä¹ˆåªéœ€è¦åˆ¤æ–­ç”¨æˆ·æ‰€é€‰çš„è½¦ç«™åŒºé—´å†…æ˜¯å¦æœ‰`1`ï¼Œå…¨ä¸º`0`åˆ™è¡¨ç¤ºè¯¥åº§ä½å¯å–ã€‚ç¡®å®šå¥½æ•°æ®åï¼Œå°±éå†è½¦å¢é‡Œçš„åº§ä½ï¼Œåˆé€‚çš„ä½ç½®é€‰ä¸­å³å¯ã€‚



### ä»£ç ç»†èŠ‚

åç«¯çš„éå†æ“ä½œä¸­ï¼šå‡è®¾æœ‰2ä¸ªåº§ä½ï¼Œåªéœ€è¦ç¡®å®š2ä¸ªåº§ä½ä¹‹é—´çš„**åç§»å€¼**å³å¯ï¼ˆæ¯ä¸ªåº§ä½æœ‰å¯¹åº”çš„åºå·ï¼‰ï¼Œä¾‹å¦‚é€‰äº†`A1`å’Œ`C2`ï¼Œé‚£ä¹ˆ`C2çš„åºå· = A1çš„åºå· + 5`

å‰åç«¯æ ¡éªŒï¼šå‰ç«¯åœ¨**è®¢å•é¡µé¢**å¯ä»¥é€‰æ‹©å¤šä¸ªä¹˜è½¦äººï¼Œè‹¥æ­¤æ—¶ä¸€ç­‰åº§ä½™ç¥¨ä¸º2ï¼Œé€‰äº†3ä¸ªä¹˜è½¦äººåä¸€ç­‰åº§ï¼Œåˆ™é€šè¿‡**å‰ç«¯æ ¡éªŒ**ç›´æ¥å¼¹å‡ºæç¤ºè¯´ä½™ç¥¨ä¸è¶³ï¼Œå‰ç«¯æ ¡éªŒé€šè¿‡åï¼Œæäº¤æ•°æ®åˆ°åç«¯å†åœ¨**åç«¯æ ¡éªŒ**



## ä»¤ç‰Œå¤§é—¸é˜²åˆ·ç¥¨

åˆ›å»ºä»¤ç‰Œè¡¨ï¼Œè®°å½•æŸæ—¥æœŸï¼ŒæŸè½¦æ¬¡çš„ä»¤ç‰Œä½™é‡

```sql
create table sk_token
(
    id          bigint      not null comment 'id'
        primary key,
    date        date        not null comment 'æ—¥æœŸ',
    train_code  varchar(20) not null comment 'è½¦æ¬¡ç¼–å·',
    count       int         not null comment 'ä»¤ç‰Œä½™é‡',
    create_time datetime(3) null comment 'æ–°å¢æ—¶é—´',
    update_time datetime(3) null comment 'ä¿®æ”¹æ—¶é—´',
    constraint date_train_code_unique
        unique (date, train_code)
)
    comment 'ç§’æ€ä»¤ç‰Œ';
```

ç”Ÿæˆå¯¹åº”çš„controller,serviceç­‰ï¼Œæ–°å¢ç”Ÿæˆæ¯æ—¥ä»¤ç‰Œçš„æ–¹æ³•ï¼Œç„¶ååœ¨ç”Ÿæˆæ¯æ—¥æ•°æ®çš„æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ç”Ÿæˆä»¤ç‰Œçš„æ–¹æ³•ï¼›



## é˜²ç¼“å­˜å‡»ç©¿&ç©¿é€

è‡ªå·±è®¾è®¡çš„ï¼Œç”¨é€»è¾‘è¿‡æœŸ + å¸ƒéš†è¿‡æ»¤å™¨çš„æ–¹å¼ï¼Œåœ¨ç”¨æˆ·åšè½¦ç¥¨åˆ†é¡µæŸ¥è¯¢çš„æ—¶å€™ä½¿ç”¨ã€‚

é¦–å…ˆç”¨æˆ·å‘èµ·çš„è½¦ç¥¨æŸ¥è¯¢è¯·æ±‚åŒ…æ‹¬3ä¸ªå­—æ®µï¼š**æ—¥æœŸï¼Œå‡ºå‘ç«™ï¼Œåˆ°è¾¾ç«™**ï¼Œè€Œä¸”ç”±äºè¿™ä¸‰ä¸ªæ•°æ®ç¡®å®šåçš„è½¦æ¬¡æ•°é‡ä¸ä¼šè¶…è¿‡å‡ ç™¾ï¼Œå› æ­¤ç›´æ¥è®¾ç½®ç¼“å­˜çš„keyä¸º**`daily:ticket:{date}:from:{start}:to:{end}`**ï¼Œè™½ç„¶æ˜¯åˆ†é¡µæŸ¥è¯¢ï¼Œä½†æ˜¯ç¼“å­˜é‡Œé¢ç¼“å­˜å®Œæ•´çš„æ•°æ®ï¼Œåç«¯è¿”å›çš„æ—¶å€™å†å»å°è£…`PageResp`å¯¹è±¡ã€‚

ç”±äºæ•°æ®ä¼šå¿«é€Ÿåœ°è¢«ä¿®æ”¹ï¼Œé€»è¾‘è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º**5s**ï¼Œredisæ•°æ®æœ¬èº«ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚

å…³äºå¸ƒéš†è¿‡æ»¤å™¨ï¼š

- ä¸ºäº†ä¿è¯åœ¨æ”¾ç¥¨é¢„çƒ­æ—¶å’Œåç»­æŸ¥è¯¢æ—¶éƒ½èƒ½ä½¿ç”¨åŒä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ï¼Œéœ€è¦å°†å¸ƒéš†è¿‡æ»¤å™¨å°è£…åœ¨ä¸€ä¸ª Spring ç®¡ç†çš„ Serviceï¼ˆä¾‹å¦‚` BloomFilterService`ï¼‰ä¸­ï¼Œåœ¨æ”¾ç¥¨é¢„çƒ­çš„ç±»ä¸­æ³¨å…¥è¯¥ Serviceï¼Œå°† Key æ·»åŠ è¿›å»ï¼›æŸ¥è¯¢æ¥å£åŒæ ·æ³¨å…¥è¯¥ Service è°ƒç”¨ contains æ–¹æ³•æ¥åˆ¤æ–­ã€‚
- åœ¨ä½¿ç”¨ Redisson çš„ RBloomFilter æ—¶ï¼Œå…¶åº•å±‚æ•°æ®å®é™…ä¸Šå­˜å‚¨åœ¨ Redis ä¸­ï¼Œæ‰€ä»¥åªè¦ Redis é…ç½®äº†æŒä¹…åŒ–ï¼ˆä¾‹å¦‚ RDB æˆ– AOFï¼‰ï¼Œå¸ƒéš†è¿‡æ»¤å™¨çš„æ•°æ®å°±ä¼šä¿å­˜åœ¨ Redis ä¸­ï¼Œ**ä¸ä¼šå› ä¸ºåº”ç”¨é‡å¯è€Œä¸¢å¤±**ã€‚ä½†å¦‚æœ Redis æ•°æ®ä¸¢å¤±æˆ–è¢«æ¸…ç©ºï¼Œå¸ƒéš†è¿‡æ»¤å™¨è‡ªç„¶ä¹Ÿä¼šå¤±æ•ˆã€‚

**å…·ä½“æµç¨‹**ï¼š

- æå‰å‡†å¤‡æ•°æ®ï¼šé¦–å…ˆç¨‹åºåœ¨æ¯å¤©çš„æ”¾ç¥¨é˜¶æ®µï¼Œéœ€è¦å°†æ‰€æœ‰æ•°æ®ç¼“å­˜åˆ°redisä¸­ï¼Œå¹¶åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼Œè¿™äº›åšæˆå®šæ—¶ä»»åŠ¡ï¼ˆé¡¹ç›®é‡Œå°±å†™æˆä¸€ä¸ªåœ¨æ§å°æ‰‹åŠ¨æ§åˆ¶çš„æ–¹æ³•äº†ï¼‰

- æ•°æ®è¯·æ±‚

  - å½“æ•°æ®ä¸ºç©ºæ—¶ï¼Œè¢«å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿæ‹’ç»ï¼Œè¿”å›ç©ºçš„PageResp;
  - å½“æ•°æ®å­˜åœ¨æ—¶ï¼Œç›´æ¥è¿”å›æ•°æ®ï¼›

  - å½“æ•°æ®è¿‡æœŸæ—¶ï¼Œä¹Ÿç›´æ¥è¿”å›æ•°æ®ï¼Œç„¶åå…ˆè·å–åˆ†å¸ƒå¼é”ï¼Œç”¨**çº¿ç¨‹æ± **æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œå»æŸ¥æ•°æ®åº“å¹¶æ›´æ–°ç¼“å­˜ï¼›

- åœ¨ç”¨æˆ·æäº¤è®¢å•æ—¶ï¼Œä¼šæ›´æ–°æ•°æ®åº“ä¸­çš„ä½™ç¥¨ä¿¡æ¯ï¼Œæ›´æ–°å®Œåè¦æ›´æ–°redis



## æ’é˜Ÿè´­ç¥¨

1. å‰ç«¯æäº¤è´­ç¥¨ç”³è¯·ï¼Œåç«¯æ¥æ”¶åˆ°åç”Ÿæˆä¸€ä¸ªè®¢å•ï¼Œè®¢å•çŠ¶æ€è®¾ä¸º`INITåˆå§‹åŒ–`å¹¶ä¿å­˜ï¼›

2. æ¥ç€å‘**MQ**ä¼ é€’ä¿¡æ¯ï¼Œå†…å®¹ä¸ºï¼š`dateæ—¥æœŸ` + `trainCodeè½¦æ¬¡ç¼–å·`

3. **MQ**æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯ï¼ŒæŒ‰ç…§`date` + `trainCode`æ¥å¤„ç†è®¢å•

   - é¦–å…ˆæ¶ˆè´¹è€…çº¿ç¨‹æŠ¢å **åˆ†å¸ƒå¼é”**ï¼Œ`key`å†…å®¹ç”±`date` + `trainCode`æ„é€ ï¼Œä¹Ÿå°±æ˜¯ç›¸åŒæ—¥æœŸç›¸åŒè½¦æ¬¡çš„çº¿ç¨‹ä¸­ï¼ŒåŒä¸€æ—¶é—´å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›å…¥ï¼Œ**å®ƒä¼šæŠŠæ‰€æœ‰çš„å¯¹åº”æ—¥æœŸè½¦æ¬¡çš„è®¢å•éƒ½å¤„ç†å®Œ**ï¼›

     - å¤±è´¥åˆ™ç›´æ¥returnï¼ŒæˆåŠŸåˆ™ç»§ç»­æ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š
     - éœ€è¦æŸ¥å‡º`confirm_order`è®¢å•è¡¨ä¸­æ‰€æœ‰æ—¥æœŸä¸º`date`ï¼Œè½¦æ¬¡ç¼–å·ä¸º`trainCode`ï¼ŒçŠ¶æ€ä¸º`INIT`çš„è®¢å•ï¼Œå¾—åˆ°`confirmOrderList`

   - ä½¿ç”¨`while(true)`å¾ªç¯ï¼Œæ¯æ¬¡æŸ¥å‡ºä¸€å®šæ•°ç›®çš„è®¢å•ï¼Œä¾‹å¦‚ï¼š

     - ```java
       // æ¯æ¬¡å¾ªç¯æœ€å¤šæŸ¥è¯¢5æ¡æ•°æ®
       PageHelper.startPage(1, 5);
       List<ConfirmOrder> confirmOrderList = confirmOrderMapper.selectByExampleWithBLOBs(confirmOrderExample);
       ```

   - é’ˆå¯¹`confirmOrderList`ä¸­çš„æ¯ä¸€æ¡æ•°æ®ï¼Œä¾æ¬¡æ‰§è¡Œè´­ç¥¨é€»è¾‘ï¼ˆåŒ…æ‹¬æ ¡éªŒåº“å­˜ï¼Œæ›´æ–°è®¢å•çŠ¶æ€ï¼Œæ›´æ–°daily_train_ticketç­‰ï¼‰

4. å‰ç«¯åœ¨è´­ç¥¨è¯·æ±‚åï¼ŒæŒ‰ç…§ä¸€å®šçš„æ—¶é—´é—´éš”è½®è¯¢è®¢å•çŠ¶æ€

   - å½“è®¢å•çŠ¶æ€ä¸º`SUCCESS`ã€`FAILURE`ã€`EMPTYæ— ç¥¨`ç­‰æœ€ç»ˆçŠ¶æ€æ—¶ç»“æŸï¼›
   - å½“è®¢å•çŠ¶æ€ä¸º`INITåˆå§‹åŒ–`ã€`PENDINGå¤„ç†ä¸­`ç­‰ä¸­é—´çŠ¶æ€æ—¶ï¼Œè¿”å›å½“å‰æ’é˜Ÿäººæ•°/ï¼›

**å…³äºåˆ†å¸ƒå¼é”ï¼š**

- å¦‚æœä¸åŠ é”ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹å¯èƒ½å»æŸ¥åˆ°ç›¸åŒçš„è®¢å•æ•°æ®ï¼Œå¯¹åŒä¸€ä¸ªè®¢å•åšäº†ä¹°ç¥¨æ“ä½œï¼Œå°±å¯èƒ½å‡ºç°è¶…å–ï¼›
- ç”±äºé”æ˜¯åŠ åœ¨åŒä¸€æ—¥æœŸåŒä¸€è½¦æ¬¡ä¸Šçš„ï¼Œæ‰€ä»¥ä¸åŒè½¦æ¬¡ä¹‹é—´å…¶å®æ˜¯ä¸å½±å“çš„ï¼›





# æŠ€æœ¯ç›¸å…³

## æ—¥å¿—æ ¼å¼

åœ¨resourcesä¸‹åˆ›å»ºlogback-spring.xmlï¼Œå…·ä½“å†…å®¹ä¸€èˆ¬å¤åˆ¶å°±è¡Œäº†

- å¯ä»¥é…ç½®æ§åˆ¶å°è¾“å‡ºæ—¥å¿—çš„æ ¼å¼
- å¯ä»¥å°†æ—¥å¿—ç”Ÿæˆåœ¨æŒ‡å®šç›®å½•ä¸‹ï¼Œä¾‹å¦‚`./log/æ¨¡å—å/`



## HttpClient

åˆ›å»ºä¸€ä¸ª`.http`æ–‡ä»¶ï¼Œå†…å®¹ä¾‹å¦‚ï¼š

```
GET http://localhost:8001/member/hello
Accept: application/json

###

GET http://localhost:8000/member/hello
Accept: application/json

###
```

åœ¨IDEAæä¾›çš„å·¥å…·ä¸­ï¼Œå¯ä»¥ç›´æ¥ç‚¹å‡»æ‰€å†™åœ°å€å‘é€è¯·æ±‚ï¼ˆä½é…postman?ï¼‰



## æ¨¡å—ç®¡ç†ï¼ˆéƒ¨åˆ†å†…å®¹ï¼‰

### æ ¹ç›®å½•pom

é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„`pom.xml`ç”¨æ¥ç®¡ç†ï¼Œä¸»è¦æŠŠä¾èµ–æ”¾åœ¨dependencyManagementä¸­ï¼š

```xml
<dependencyManagement>
	<dependency>
		...
	</dependency>
</dependencyManagement>
```

ä¸è¿‡æŒ‰ç…§æ•™ç¨‹ï¼Œå„æ¨¡å—ä¹Ÿè¦å¼•å…¥ç›¸åŒçš„ä¾èµ–ï¼Œåªæ˜¯ä¸éœ€è¦å†™ç‰ˆæœ¬å·



### commonæ¨¡å—

å°†å…¬å…±éœ€è¦ç”¨åˆ°çš„ä¾èµ–å…¨æ”¾åœ¨commonçš„pomé‡Œé¢ï¼Œç„¶åå…¶ä»–æ¨¡å—å¼•å…¥commonï¼ŒåŒ…æ‹¬æ ¹ç›®å½•çš„pomï¼ˆä¸è¿‡æ ¹ç›®å½•çš„éœ€è¦åŠ ç‰ˆæœ¬å·ï¼Œå…¶ä»–çš„ä¸ç”¨ï¼‰

```xml
<!-- å¼•å…¥commonæ¨¡å— -->
<dependency>
    <groupId>com.criel</groupId>
    <artifactId>common</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
```

è¿™æ ·å…¶ä»–æ¨¡å—å°±å¯ä»¥ä½¿ç”¨commoné‡Œæ·»åŠ çš„ä¾èµ–ï¼Œä½¿ç”¨commoné‡Œçš„ç±»ã€é…ç½®ç­‰



### generatoræ¨¡å—

ä½¿ç”¨mybatiså®˜æ–¹ä»£ç ç”Ÿæˆå™¨ï¼Œè¿æ¥æ•°æ®åº“åå¯ä»¥è‡ªåŠ¨ç”ŸæˆCRUDæ–¹æ³•ã€‚

- å¼•å…¥ä¾èµ–ï¼ˆæ˜¯ä¸€ä¸ªæ’ä»¶ï¼‰ï¼š

  - ```xml
    <build>
        <plugins>
            <!-- mybatis generator è‡ªåŠ¨ç”Ÿæˆä»£ç æ’ä»¶ -->
            <plugin>
                <groupId>org.mybatis.generator</groupId>
                <artifactId>mybatis-generator-maven-plugin</artifactId>
                <version>1.4.0</version>
                <configuration>
                    <configurationFile>src/main/resources/generator-config-member.xml</configurationFile>
                    <!--<configurationFile>src/main/resources/generator-config-batch.xml</configurationFile>-->
                    <!--<configurationFile>src/main/resources/generator-config-business.xml</configurationFile>-->
                    <overwrite>true</overwrite>
                    <verbose>true</verbose>
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>mysql</groupId>
                        <artifactId>mysql-connector-java</artifactId>
                        <version>8.0.30</version>
                    </dependency>
                </dependencies>
            </plugin>
        </plugins>
    </build>
    ```

- åˆ›å»ºé…ç½®æ–‡ä»¶`resources/generator-config-member.xml`
  - åœ¨é‡Œé¢é…ç½®æ•°æ®åº“è¿æ¥ï¼ˆåœ°å€ã€ç”¨æˆ·åã€å¯†ç ç­‰ï¼‰
  - é…ç½®ç±»ã€mapperï¼Œxmlæ–‡ä»¶ç”Ÿæˆçš„ä½ç½®ç­‰....

- å¯åŠ¨ï¼š

  - ![](image/mybatis-generator.png)




## é…ç½®æ–‡ä»¶çš„åŠ è½½

å¦‚æœå¼•ç”¨äº†ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯åˆ«çš„jaråŒ…ï¼Œé‚£ä¹ˆå…¶ä¸­çš„`application.properties`ä¹Ÿå°†å‘æŒ¥ä½œç”¨ï¼Œè¿™æ—¶å°±æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§éœ€è¦è€ƒè™‘ï¼š

1. `file:./config/`ï¼ˆå¤–éƒ¨ config ç›®å½•ï¼‰
2. `file:./`ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
3. `classpath:/config/`ï¼ˆå³ resources/config/ï¼‰
4. `classpath:/`ï¼ˆå³ resources/ï¼‰

å¹¶ä¸”æœ‰ä»¥ä¸‹è§„åˆ™ï¼š

- å¤šä¸ª `application.properties` ä¼šè¢«åˆå¹¶ï¼Œè€Œä¸æ˜¯åªå–å…¶ä¸­ä¸€ä¸ª
- ç›¸åŒçš„é…ç½®é¡¹ï¼Œä¼˜å…ˆçº§é«˜çš„ä¼šè¦†ç›–ä¼˜å…ˆçº§ä½çš„
- ä¸åŒçš„é…ç½®é¡¹éƒ½ä¼šä¿ç•™ï¼Œæœ€ç»ˆå½¢æˆå®Œæ•´çš„é…ç½®



## é…ç½®æ—¥å¿—çº§åˆ«

```properties
# æŠŠmapperåŒ…çš„æ—¥å¿—çº§åˆ«æ”¹æˆtrace
logging.level.com.criel.train.business.mapper=trace
```

è¿™ä¸ªé…ç½®ä¼šä½¿ `com.criel.train.business.mapper` åŒ…å†…çš„æ‰€æœ‰æ—¥å¿—è®°å½•ï¼ˆåŒ…æ‹¬ traceã€debugã€info ç­‰ï¼‰ä¸­ï¼Œæœ€è¯¦ç»†çš„ trace ä¿¡æ¯éƒ½è¢«è¾“å‡ºï¼Œä»è€Œå¸®åŠ©å¼€å‘äººå‘˜æ›´å¥½åœ°ç†è§£å’Œè°ƒè¯•ä»£ç æ‰§è¡Œè¿‡ç¨‹ã€‚



## é€šç”¨è¿”å›å¯¹è±¡

é¡¹ç›®é‡Œç”¨çš„æ˜¯`public class CommonResp<T>`ï¼Œå…¶å®å°±æ˜¯`Result<T>`ï¼Œæ•™ç¨‹é‡Œå¤ªéº»çƒ¦äº†ï¼Œæ”¹äº†ä¸€ä¸‹ï¼ŒåŠ äº†3ä¸ªé™æ€æ–¹æ³•



## å¼‚å¸¸å¤„ç†

### ç»Ÿä¸€å¼‚å¸¸å¤„ç†

- åˆ›å»ºä¸€ä¸ªç±»ï¼ŒåŠ ä¸Š`@ControllerAdvice`æ³¨è§£ï¼Œå…¶ä¼šæ‹¦æˆªå¸¦æœ‰`@Controller`æˆ–`@RestController`çš„ç±»é‡Œé¢æŠ›å‡ºçš„å¼‚å¸¸ï¼›
- ç”¨`@@ExceptionHandler(value = Exception.class)`æ³¨è§£å¤„ç†å¯¹åº”çš„å¼‚å¸¸ç±»

```java
@ExceptionHandler(value = Exception.class)
@ResponseBody
public CommonResp exceptionHandler(Exception e) {
    LOG.error("ç³»ç»Ÿå¼‚å¸¸ï¼š", e);
    return CommonResp.error("ç³»ç»Ÿå‡ºç°å¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
}
```



### è‡ªå®šä¹‰å¼‚å¸¸

å…¶å®æ„Ÿè§‰æ•™ç¨‹é‡Œä¸å¤Ÿè§„èŒƒï¼Œä¸è¿‡å…ˆæŒ‰ç…§æ•™ç¨‹æ¥å§

å®šä¹‰**ä¸šåŠ¡å¼‚å¸¸**æšä¸¾ç±»ï¼š

```java
public enum BusinessExceptionEnum {

    MOBILE_IS_EXIST("æ‰‹æœºå·å·²è¢«æ³¨å†Œ");
    // å¢åŠ å…¶ä»–å¼‚å¸¸æƒ…å†µ

    private String desc;

    BusinessExceptionEnum(String desc) {
        this.desc = desc;
    }

    public String getDesc() {
        return desc;
    }
}
```

å®šä¹‰ä¸šåŠ¡å¼‚å¸¸ç±»ï¼Œç”¨æ¥æŠ›å‡ºå¼‚å¸¸ï¼š

```java
@EqualsAndHashCode(callSuper = true) // è§ä¸‹é¢çš„tip
@Data
public class BusinessException extends RuntimeException{

    private BusinessExceptionEnum anEnum;

    public BusinessException(BusinessExceptionEnum anEnum) {
        this.anEnum = anEnum;
    }
}
```

tipï¼šå¼‚å¸¸ç±»ç»§æ‰¿äº† `Exception` æˆ– `RuntimeException`ï¼Œè€Œ `@Data` é»˜è®¤ä¼šä¸º `equals()` å’Œ `hashCode()` æ–¹æ³•é‡æ–°ç”Ÿæˆå®ç°ï¼Œä½†ä¸ä¼šè°ƒç”¨çˆ¶ç±»ï¼ˆ`Exception`ï¼‰çš„æ–¹æ³•ã€‚ è¿™æ ·å¯èƒ½å¯¼è‡´ å¼‚å¸¸å¯¹è±¡çš„æ¯”è¾ƒå’Œå“ˆå¸Œè®¡ç®—ä¸¢å¤±äº†çˆ¶ç±»çš„é€»è¾‘

æŠ›å‡ºå¼‚å¸¸ï¼š

```java
throw new BusinessException(BusinessExceptionEnum.MOBILE_IS_EXIST);
```



## æ ¡éªŒæ¡†æ¶Validation

ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

å¯¹VOç±»çš„ç‰¹å®šå­—æ®µæ·»åŠ æ³¨è§£

```java
@Data
public class MemberRegisterReq {
    @NotBlank(message = "æ‰‹æœºå·ä¸èƒ½ä¸ºç©º")
    String mobile;
}
```

è¯·æ±‚å‚æ•°åŠ ä¸Šæ³¨è§£`@Valid`ï¼ˆåœ¨çº¯ Java ç¯å¢ƒä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ `ValidatorFactory` ä¸ `Validator` æ¥æ‰‹åŠ¨è§¦å‘æ ¡éªŒï¼›è€Œåœ¨ Spring Boot ä¸­ï¼Œé€šè¿‡ `@Valid` æˆ– `@Validated` æ³¨è§£è‡ªåŠ¨é›†æˆã€‚ï¼‰

```java
@PostMapping("/register")
public CommonResp<Long>  register(@Valid MemberRegisterReq req) {
    Long memberId = memberService.register(req);
    return CommonResp.success(memberId);
}
```



## é›ªèŠ±ç®—æ³•ç”ŸæˆUID

é›ªèŠ±ç®—æ³•åˆ©ç”¨ä½è¿ç®—å°†æ—¶é—´æˆ³ã€æœºå™¨æ ‡è¯†å’Œåºåˆ—å·ç»„åˆæˆä¸€ä¸ª 64 ä½é•¿æ•´å‹ IDï¼Œèƒ½åœ¨**åˆ†å¸ƒå¼ç¯å¢ƒ**ä¸‹é«˜æ•ˆç”Ÿæˆå…¨å±€å”¯ä¸€ä¸”å¤§è‡´æœ‰åºçš„ IDã€‚

- é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ ID é€šå¸¸ç”±å››éƒ¨åˆ†ç»„æˆï¼š

  - **ç¬¦å·ä½ï¼ˆ1 ä½ï¼‰**
    - å›ºå®šä¸º 0ï¼Œä¿è¯ç”Ÿæˆçš„ ID ä¸ºæ­£æ•°ã€‚

  - **æ—¶é—´æˆ³ï¼ˆ41 ä½ï¼‰**
    - è¡¨ç¤ºä»æŸä¸ªå›ºå®šèµ·å§‹æ—¶é—´ï¼ˆçºªå…ƒï¼‰åˆ°å½“å‰æ—¶é—´çš„æ¯«ç§’æ•°ã€‚è¿™ 41 ä½èƒ½è¦†ç›–çº¦ 69 å¹´çš„æ—¶é—´èŒƒå›´ï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†ç”Ÿæˆçš„ ID éšæ—¶é—´å•è°ƒé€’å¢ã€‚

  - **æœºå™¨æ ‡è¯†ï¼ˆ10 ä½ï¼‰**
    - é€šå¸¸åˆ†ä¸ºæ•°æ®ä¸­å¿ƒ ID å’Œæœºå™¨ IDï¼ˆå„ 5 ä½ï¼‰ï¼Œè¿™æ„å‘³ç€å¯ä»¥æ”¯æŒæœ€å¤š 1024 ä¸ªä¸åŒèŠ‚ç‚¹ã€‚é€šè¿‡ä¸ºæ¯å°æœºå™¨é…ç½®å”¯ä¸€çš„æ ‡è¯†ï¼Œä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å„èŠ‚ç‚¹ç”Ÿæˆçš„ ID ä¸ä¼šå†²çªã€‚

  - **åºåˆ—å·ï¼ˆ12 ä½ï¼‰**
    - åœ¨åŒä¸€æ¯«ç§’å†…ï¼ŒåŒä¸€èŠ‚ç‚¹å¯ç”Ÿæˆæœ€å¤š 4096 ä¸ªä¸åŒçš„ IDã€‚å½“åŒä¸€æ¯«ç§’å†…ç”Ÿæˆçš„ ID è¶…è¿‡æœ€å¤§åºåˆ—æ•°æ—¶ï¼Œç®—æ³•ä¼šç­‰å¾…åˆ°ä¸‹ä¸€æ¯«ç§’ã€‚

- è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†å…¨å±€å”¯ä¸€æ€§ï¼Œä¹Ÿèƒ½åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¿æŒè¾ƒé«˜çš„ç”Ÿæˆæ€§èƒ½ä¸é¡ºåºæ€§

ä½¿ç”¨**hutool**æä¾›çš„æ–¹æ³•å¯ä»¥ç›´æ¥ç”Ÿæˆï¼š

```java
IdUtil.getSnowflake(workerId, dataCenterId).nextId()
```

å…¶ä¸­ï¼Œæœºå™¨idå’Œæ•°æ®ä¸­å¿ƒidä¸€èˆ¬ä½¿ç”¨æ•°æ®åº“æˆ–redisæ¥æï¼Œæ¯å°æœºå™¨éƒ½è¦ä¸ä¸€æ ·ï¼ˆæ•™ç¨‹è¿˜æ²¡å¼„ï¼‰



## é…ç½®è·¨åŸŸè¯·æ±‚

åœ¨gatewayæ¨¡å—çš„é…ç½®æ–‡ä»¶æ·»åŠ å¦‚ä¸‹é…ç½®å³å¯ï¼š

```properties
# å…è®¸è¯·æ±‚æ¥æºï¼ˆè€ç‰ˆæœ¬å«allowedOriginï¼‰
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowedOriginPatterns=*
# å…è®¸æºå¸¦çš„å¤´ä¿¡æ¯
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowedHeaders=*
# å…è®¸çš„è¯·æ±‚æ–¹å¼
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowedMethods=*
# æ˜¯å¦å…è®¸æºå¸¦cookie
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowCredentials=true
# è·¨åŸŸæ£€æµ‹çš„æœ‰æ•ˆæœŸï¼ˆåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œæµè§ˆå™¨ä¸ä¼šå¯¹åŒä¸€è·¨åŸŸè¯·æ±‚å†æ¬¡å‘èµ·é¢„æ£€è¯·æ±‚ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ç»“æœè¿›è¡Œåç»­çš„è¯·æ±‚æ“ä½œï¼‰
spring.cloud.gateway.globalcors.cors-configurations.[/**].maxAge=3600
```



## JWT

JSON Web Token ç®€å•ç‚¹è¯´JWTå°±æ˜¯ä¸€ç§ç½‘ç»œèº«ä»½è®¤è¯å’Œä¿¡æ¯äº¤æ¢æ ¼å¼ã€‚

å…·ä½“è®²è§£çœ‹https://javaguide.cn/system-design/security/jwt-intro.html

**ç»“æ„ï¼š**

- `Header` å¤´éƒ¨ä¿¡æ¯ï¼Œä¸»è¦å£°æ˜äº†JWTçš„ç­¾åç®—æ³•ç­‰ä¿¡æ¯

  - ```json
    {
      "alg": "HS256", // ç­¾åç®—æ³•
      "typ": "JWT" // ä»¤ç‰Œç±»å‹
    }
    ```

- `Payload` è½½è·ä¿¡æ¯ï¼ˆè´Ÿè½½ä¿¡æ¯ï¼‰ï¼Œä¸»è¦æ‰¿è½½äº†å„ç§å£°æ˜å¹¶ä¼ é€’æ˜æ–‡æ•°æ®
- `Signature` ç­¾åï¼Œæ‹¥æœ‰è¯¥éƒ¨åˆ†çš„JWTè¢«ç§°ä¸ºJWSï¼Œä¹Ÿå°±æ˜¯ç­¾äº†åçš„JWTï¼Œç”¨äºæ ¡éªŒæ•°æ®

  - æœåŠ¡å™¨é€šè¿‡ `Payload`ã€`Header` å’Œä¸€ä¸ªå¯†é’¥`secret`ï¼Œä½¿ç”¨ Header é‡Œé¢æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æ˜¯ HMAC SHA256ï¼‰ç”Ÿæˆ

  - ```java
    HMACSHA256(
      base64UrlEncode(header) + "." +
      base64UrlEncode(payload),
      secret);
    ```


æ•´ä½“ç»“æ„æ˜¯ï¼š

```text
header.payload.signature
```

é¡¹ç›®ä½¿ç”¨hutoolæä¾›çš„æ–¹æ³•ï¼Œå…·ä½“çœ‹https://doc.hutool.cn/pages/jwt/#jwt%E7%94%9F%E6%88%90

åˆ›å»ºè‡ªå·±çš„å·¥å…·ç±»`JwtUtil`ï¼Œé‡Œé¢ä½¿ç”¨hutoolçš„`JWTUtil`ï¼Œä¼ å…¥mapã€ç­¾åã€è¿‡æœŸæ—¶é—´

```java
/**
 * ç”Ÿæˆtoken
 * @param payload æ•°æ®ï¼Œä¾‹å¦‚ï¼š"id": 123
 * @param key ç­¾åkey
 * @param exp è¿‡æœŸæ—¶é—´
 * @return
 */
public static String createToken(Map<String, Object> payload, String key, int exp) {
    DateTime now = DateTime.now();
    // è¿‡æœŸæ—¶é—´
    DateTime expTime = now.offsetNew(DateField.MILLISECOND, exp);
    // è®¾ç½®ç­¾å‘æ—¶é—´
    payload.put(JWTPayload.ISSUED_AT, now);
    // è®¾ç½®è¿‡æœŸæ—¶é—´
    payload.put(JWTPayload.EXPIRES_AT, expTime);
    // è®¾ç½®ç”Ÿæ•ˆæ—¶é—´
    payload.put(JWTPayload.NOT_BEFORE, now);
    String token = JWTUtil.createToken(payload, key.getBytes());
    return token;
}

/**
 * æ ¡éªŒtoken
 * @param token
 * @param key
 * @return
 */
public static boolean validate(String token, String key) {
    try {
        JWT jwt = JWTUtil.parseToken(token).setKey(key.getBytes());
        // validateåŒ…å«äº†verify
        boolean validate = jwt.validate(0);
        return validate;
    } catch (Exception e) {
        return false;
    }
}

/**
 * æ ¹æ®tokenè·å–åŸå§‹å†…å®¹
 * @param token
 * @param key
 * @return
 */
public static JSONObject getJSONObject(String token, String key) {
    JWT jwt = JWTUtil.parseToken(token).setKey(key.getBytes());
    JSONObject payloads = jwt.getPayloads();
    payloads.remove(JWTPayload.ISSUED_AT);
    payloads.remove(JWTPayload.EXPIRES_AT);
    payloads.remove(JWTPayload.NOT_BEFORE);
    return payloads;
}
```

ä½¿ç”¨æ‹¦æˆªå™¨ï¼Œè·å–jwtä¸­çš„ä¿¡æ¯ï¼Œå­˜å‚¨ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal

```java
/**
 * åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰è¿›è¡Œè°ƒç”¨ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal
 */
@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    // è·å–headerçš„tokenå‚æ•°
    String token = request.getHeader("token");
    if (StrUtil.isNotBlank(token)) {
        LOG.info("è·å–ä¼šå‘˜ç™»å½•tokenï¼š{}", token);
        
        JSONObject loginMember = JwtUtil.getJSONObject(token, jwtProperties.getMemberSecretKey());
        
        LOG.info("å½“å‰ç™»å½•ä¼šå‘˜ï¼š{}", loginMember);
        
        MemberLoginResp memberLoginResp = JSONUtil.toBean(loginMember, MemberLoginResp.class);
        LoginMemberContext.setMember(memberLoginResp);
    }
    return true;
}
```

åœ¨ç½‘å…³åˆ›å»ºjwtæ‹¦æˆªå™¨ï¼Œå¯ä»¥ä»è¯·æ±‚å¤´ä¸­è·å–å‰ç«¯ä¼ æ¥çš„token

```java
/**
 * ç™»å½•ä¼šå‘˜jwtæ‹¦æˆªå™¨
 */
@Component
public class LoginMemberFilter implements Ordered, GlobalFilter {

    private static final Logger LOG = LoggerFactory.getLogger(LoginMemberFilter.class);

    @Autowired
    private JwtProperties jwtProperties;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String path = exchange.getRequest().getURI().getPath();

        // æ’é™¤ä¸éœ€è¦æ‹¦æˆªçš„è¯·æ±‚ï¼šç®¡ç†å‘˜ã€æµ‹è¯•æ¥å£ã€ç™»å½•æ¥å£ã€è·å–éªŒè¯ç æ¥å£
        if (path.contains("/admin")
                || path.contains("/test-connect")
                || path.contains("/member/member/login")
                || path.contains("/member/member/code")) {
            LOG.info("æ’é™¤ä¸éœ€è¦ç™»å½•éªŒè¯çš„è¯·æ±‚ï¼š{}", path);
            return chain.filter(exchange);
        } else {
            LOG.info("æ‹¦æˆªåˆ°éœ€è¦ç™»å½•éªŒè¯çš„è¯·æ±‚ï¼š{}", path);
        }
        
        // è·å–headerçš„tokenå‚æ•°
        String token = exchange.getRequest().getHeaders().getFirst("token");
        LOG.info("ä¼šå‘˜ç™»å½•éªŒè¯å¼€å§‹ï¼Œtokenï¼š{}", token);
        if (token == null || token.isEmpty()) {
            LOG.info("tokenä¸ºç©ºï¼Œè¯·æ±‚è¢«æ‹¦æˆª");
            // è¿”å›ç 401ï¼šæ— æƒé™
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            // ä¸­æ–­è¯·æ±‚
            return exchange.getResponse().setComplete();
        }

        // æ ¡éªŒtokenæ˜¯å¦æœ‰æ•ˆï¼ŒåŒ…æ‹¬tokenæ˜¯å¦è¢«æ”¹è¿‡ï¼Œæ˜¯å¦è¿‡æœŸ
        boolean validate = JwtUtil.validate(token, jwtProperties.getMemberSecretKey());
        if (validate) {
            LOG.info("tokenæœ‰æ•ˆï¼Œæ”¾è¡Œè¯¥è¯·æ±‚");
            return chain.filter(exchange);
        } else {
            LOG.warn("tokenæ— æ•ˆï¼Œè¯·æ±‚è¢«æ‹¦æˆª");
            // è¿”å›ç 401ï¼šæ— æƒé™
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }
    }

    /**
     * æ‹¦æˆªå™¨çš„ä¼˜å…ˆçº§è®¾ç½®
     * å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜
     * @return
     */
    @Override
    public int getOrder() {
        return 0;
    }
}
```





## é…ç½®ç±»

æ˜¯å­¦è‹ç©¹å¤–å–çš„ï¼Œé¡ºä¾¿è®°åœ¨è¿™é‡Œäº†

è¿™æ ·å°±èƒ½è‡ªåŠ¨è¯»å–é…ç½®ä¿¡æ¯ï¼Œç„¶ååœ¨éœ€è¦çš„åœ°æ–¹ç”¨`@Autowired`å¼•å…¥JwtPropertiesï¼Œç”¨getæ–¹æ³•è·å–å¯¹åº”ä¿¡æ¯

```java
@Component
@Data
@ConfigurationProperties("train.jwt")
public class JwtProperties {
    private String memberSecretKey;
    private int memberTtl;
}
```

```properties
# jwtç›¸å…³é…ç½®
train.jwt.member-secret-key=criel12306
# tokenè¿‡æœŸæ—¶é—´ï¼š2å°æ—¶
train.jwt.member-ttl=7200000
```



## ThreadLocal

çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»ï¼Œç”¨ThreadLocalæ¥ç®¡ç†ç”¨æˆ·ä¿¡æ¯ï¼ˆè¿™é‡Œç”¨MemberLoginRespï¼Œä¹Ÿå°±æ˜¯VOæ¥å­˜ï¼Œå…¶å®ç›´æ¥Memberåº”è¯¥ä¹Ÿå¯ä»¥ï¼‰

è¿™é‡Œè·Ÿè‹ç©¹å¤–å–ä¸ä¸€æ ·ï¼Œç›´æ¥å­˜äº†å¯¹è±¡ï¼Œè€Œä¸æ˜¯åªå­˜longç±»å‹çš„æ•°æ®ï¼›åœ¨[æ‹¦æˆªå™¨](#æ‹¦æˆªå™¨HandlerInterceptor)ä¸­ä½¿ç”¨

**æ³¨æ„ï¼š**å½“ä¸€ä¸ª HTTP è¯·æ±‚è¿›å…¥ Spring Boot åº”ç”¨æ—¶ï¼ŒæœåŠ¡å™¨ï¼ˆå¦‚ Tomcatã€Jetty æˆ– Undertowï¼‰ä¼šä»çº¿ç¨‹æ± ä¸­åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¯¥è¯·æ±‚ã€‚

- è¿™ä¸ªçº¿ç¨‹ä¼š**ä¾æ¬¡æ‰§è¡Œæ‹¦æˆªå™¨ã€Controllerã€Service** ç­‰å„ä¸ªç»„ä»¶çš„é€»è¾‘ã€‚
- å› æ­¤ï¼Œåœ¨æ‹¦æˆªå™¨ä¸­è°ƒç”¨ ThreadLocal çš„ set() æ–¹æ³•ä¿å­˜çš„æ•°æ®ï¼Œåç»­åœ¨åŒä¸€è¯·æ±‚é“¾ä¸­çš„ Controller æˆ– Service è°ƒç”¨ get() æ—¶èƒ½å¤Ÿæ‹¿åˆ°æ•°æ®ï¼Œå› ä¸ºå®ƒä»¬å¤„äºåŒä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚

å…¶ä»–å†…å®¹ï¼š

- **å•ä¸ª ThreadLocal å®ä¾‹åªèƒ½å­˜ä¸€ä¸ªæ•°æ®**ï¼ˆæ¯ä¸ªçº¿ç¨‹ä¸­ï¼‰ã€‚
- **å¤šæ¬¡è°ƒç”¨ set() ä¼šè¦†ç›–æ—§å€¼**ã€‚
- **è¦å­˜å¤šä¸ªæ•°æ®ï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ª ThreadLocal å®ä¾‹ï¼ˆå¯ä»¥ä¸åŒæ³›å‹ï¼‰æˆ–è€…å­˜å‚¨ä¸€ä¸ªå®¹å™¨å¯¹è±¡**ã€‚

```java
/**
 * çº¿ç¨‹ä¸Šä¸‹æ–‡
 * ä¸»è¦ç”¨æ¥è·å–ThreadLocalä¸­çš„memberä¿¡æ¯
 */
public class LoginMemberContext {
    private static final Logger LOG = LoggerFactory.getLogger(LoginMemberContext.class);

    private static ThreadLocal<MemberLoginResp> member = new ThreadLocal<>();

    public static MemberLoginResp getMember() {
        return member.get();
    }

    public static void setMember(MemberLoginResp member) {
        LoginMemberContext.member.set(member);
    }

    public static Long getId() {
        try {
            return member.get().getId();
        } catch (Exception e) {
            LOG.error("è·å–ç™»å½•ä¼šå‘˜ä¿¡æ¯å¼‚å¸¸", e);
            throw e;
        }
    }
}
```



## æ‹¦æˆªå™¨HandlerInterceptor

å®ç°HandlerInterceptoræ¥å£ï¼Œé‡å†™æ–¹æ³•ï¼Œè¿™é‡Œé‡å†™çš„æ˜¯åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰è¿›è¡Œè°ƒç”¨çš„æ–¹æ³•ï¼Œæ–¹æ³•é‡Œè§£ætokenï¼Œç„¶åæŠŠç”¨æˆ·idå­˜åˆ°ThreadLocalé‡Œ

```java
/**
 * ç”¨æˆ·ç™»å½•æ‹¦æˆªå™¨
 */
@Component
public class MemberInterceptor implements HandlerInterceptor {

    private static final Logger LOG = LoggerFactory.getLogger(MemberInterceptor.class);

    @Autowired
    private JwtProperties jwtProperties;

    /**
     * åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰è¿›è¡Œè°ƒç”¨ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // è·å–headerçš„tokenå‚æ•°
        String token = request.getHeader("token");
        if (StrUtil.isNotBlank(token)) {
            LOG.info("è·å–ä¼šå‘˜ç™»å½•tokenï¼š{}", token);
            JSONObject loginMember = JwtUtil.getJSONObject(token, jwtProperties.getMemberSecretKey());
            LOG.info("å½“å‰ç™»å½•ä¼šå‘˜ï¼š{}", loginMember);
            MemberLoginResp memberLoginResp = JSONUtil.toBean(loginMember, MemberLoginResp.class);
            LoginMemberContext.setMember(memberLoginResp);
        }
        return true;
    }

}
```



## åˆ†é¡µæŸ¥è¯¢

å¼•å…¥PageHelper

```xml
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper-spring-boot-starter</artifactId>
    <version>1.4.6</version>
</dependency>
```

åœ¨æ­£å¸¸çš„**æŸ¥è¯¢è¯­å¥å‰é¢**åŠ ä¸Š`PageHelper.startPage(é¡µç , é¡µå¤§å°)`ï¼Œç„¶åå¯ä»¥ç”¨`PageInfo`è·å–å¯¹åº”ä¿¡æ¯ï¼›

åŸç†å°±æ˜¯å®ƒä¼šè‡ªåŠ¨åœ¨ä¸‹ä¸€æ¡`select`è¯­å¥åé¢åŠ ä¸Š`limit`

```java
PageHelper.startPage(passengerQueryReq.getPage(), passengerQueryReq.getSize());
List<Passenger> passengerList = passengerMapper.selectByExample(passengerExample);
PageInfo<Passenger> pageInfo = new PageInfo<>(passengerList);

LOG.info("åˆ†é¡µæŸ¥è¯¢ï¼šæ€»æ¡æ•°ï¼š{}, æ€»é¡µæ•°ï¼š{}", pageInfo.getTotal(), pageInfo.getPages());
```



## Springbootå†…ç½®è°ƒåº¦

ä½¿ç”¨`@EnableScheduling`æ³¨è§£å’Œ`@Scheduled`æ³¨è§£å®ç°

**ç¼ºç‚¹ï¼š**

- **é€‚åˆå•ä½“åº”ç”¨ï¼Œä¸é€‚åˆé›†ç¾¤**ï¼Œå…¶ä»»åŠ¡æ‰§è¡Œå®Œå…¨ä¾èµ– **Spring å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ**ï¼Œä¸æ¶‰åŠå¤–éƒ¨çš„ä»»åŠ¡åè°ƒæœºåˆ¶ï¼Œä¹Ÿ **æ²¡æœ‰ä»»åŠ¡æŒä¹…åŒ–** æœºåˆ¶ã€‚
  - ç”±äº `@Scheduled` ä»»åŠ¡æ˜¯**æ¯ä¸ªå®ä¾‹**éƒ½ç‹¬ç«‹è¿è¡Œçš„ï¼Œæ‰€ä»¥**æ¯ä¸ªå®ä¾‹éƒ½ä¼šè§¦å‘å®šæ—¶ä»»åŠ¡**ï¼Œå¯¼è‡´ä»»åŠ¡è¢«**é‡å¤æ‰§è¡Œå¤šæ¬¡**ï¼Œé™¤éç”¨åˆ†å¸ƒå¼é”ã€‚
- æ— æ³•**å®æ—¶æ›´æ”¹**å®šæ—¶ä»»åŠ¡çŠ¶æ€å’Œå®šæ—¶ç­–ç•¥
  - ä¾‹å¦‚éœ€è¦ä¸´æ—¶æš‚åœã€è°ƒæ•´ç­‰

```java
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

@Component
@EnableScheduling
public class MyScheduledTask {

    // æ¯éš”5ç§’æ‰§è¡Œä¸€æ¬¡
    @Scheduled(fixedRate = 5000)
    public void fixedRateTask() {
        System.out.println("fixedRateTask: " + System.currentTimeMillis());
    }

    // ä¸Šä¸€æ¬¡æ‰§è¡Œå®Œæ¯•åç­‰å¾…5ç§’å†æ‰§è¡Œ
    @Scheduled(fixedDelay = 5000)
    public void fixedDelayTask() {
        System.out.println("fixedDelayTask: " + System.currentTimeMillis());
    }

    // ä½¿ç”¨cronè¡¨è¾¾å¼ï¼šæ¯å¤©ä¸­åˆ12ç‚¹æ‰§è¡Œä¸€æ¬¡
    @Scheduled(cron = "0 0 12 * * ?")
    public void cronTask() {
        System.out.println("cronTask: " + System.currentTimeMillis());
    }
}
```



## åˆ†å¸ƒå¼é”

è¶…å–é—®é¢˜ï¼š

åœ¨ä¹°ç¥¨çš„ä»£ç ä¸­ï¼ˆå…·ä½“æ˜¯`ConfrimOrderService`çš„`confirm`æ–¹æ³•ï¼‰ï¼Œé¦–å…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œè·å–`dailyTrainTicket`çš„ä¿¡æ¯ï¼Œé€šè¿‡è¿™é‡Œé¢çš„ä¿¡æ¯æŸ¥è¯¢ä½™ç¥¨æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸è¶³åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åèµ°åˆ°ä¸‹é¢çš„é€‰åº§ä¹°ç¥¨ä»£ç ï¼›

è¿™ä¸ªè¿‡ç¨‹ä¸­ã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›æ¥æŸ¥è¯¢ä½™ç¥¨æ˜¯å¦è¶³å¤Ÿï¼Œå°±ä¼šå‡ºç°è¶…å–çš„æƒ…å†µï¼Œä¾‹å¦‚éƒ½æŸ¥åˆ°ä½™ç¥¨æ•°é‡ä¸º1ï¼Œé‚£ä¹ˆéƒ½è¿›å»é€‰åº§äº†ï¼Œå°±è¶…å–äº†ã€‚

### synchronizedé”

ç»™`confirm`æ–¹æ³•åŠ ä¸Šsynchronizedåï¼Œå¦‚æœæ˜¯å•æœºçš„æƒ…å†µï¼Œå¯ä»¥è§£å†³è¶…å–çš„é—®é¢˜ï¼Œä½†æ˜¯æ•ˆç‡ã€TPSä¼šå˜å¾—å¾ˆä½ï¼›è€Œåœ¨å¤šèŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œsynchronizedå°±æ²¡ç”¨äº†ã€‚

### redisåˆ†å¸ƒå¼é”

æœ¬è´¨ä¸Šå°±æ˜¯redisçš„`setnx`å‘½ä»¤ï¼Œå…«è‚¡é‡Œä¹Ÿæœ‰ï¼Œè¿™é‡Œçš„`setIfAbsent`æ–¹æ³•å°±æ˜¯è¿™ä¸ªå‘½ä»¤ï¼Œè¿”å›æ˜¯å¦setæˆåŠŸ

ä»¥ä¸‹æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”çš„åŸºæœ¬å®ç°ï¼ˆå®é™…å¼€å‘å¹¶ä¸ä¼šè¿™æ ·å†™ï¼Œä»…ä¾›å‚è€ƒï¼‰ï¼š

```java
// åˆ†å¸ƒå¼é”
String lockKey = req.getTrainCode() + req.getDate();
// getLockä¸ºtrueåˆ™æŠ¢åˆ°é”
Boolean getLock = redisTemplate.opsForValue().setIfAbsent(lockKey, "lock", 5, TimeUnit.SECONDS);
if (!getLock) {
    // æ²¡æŠ¢åˆ°é”
    throw new BusinessException(BusinessExceptionEnum.CONFIRM_ORDER_LOCK_FAIL);
}
```

### **Redisson**

è¯¦ç»†å†…å®¹è®°åœ¨*Javaå…«è‚¡ç¬”è®°*é‡Œäº†

```java
public void confirm(ConfirmOrderSaveReq req) {
    // åˆ†å¸ƒå¼é”
    String lockKey = req.getTrainCode() + req.getDate();
    RLock rLock = redissonClient.getLock(lockKey);
    boolean locked = false;
    try {
        // è‡ªå¸¦çœ‹é—¨ç‹—æœºåˆ¶ï¼Œå‚æ•°æ˜¯ï¼ˆæœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå•ä½ï¼‰
        locked = rLock.tryLock(10, TimeUnit.SECONDS);
        if (!locked) {
            throw new BusinessException(BusinessExceptionEnum.CONFIRM_ORDER_LOCK_FAIL);
        }

        // è´­ç¥¨ä»£ç ...
            
    } catch (InterruptedException e) {
        throw new RuntimeException(e);
    } finally {
        // ç¡®ä¿é”è¢«å½“å‰çº¿ç¨‹æŒæœ‰æ—¶æ‰é‡Šæ”¾
        if (locked && rLock.isHeldByCurrentThread()) {
            rLock.unlock();
        }
    }
}
```

å…¶ä¸­ä½¿ç”¨hashç»“æ„ï¼Œhashç»“æ„é‡Œçš„keyæ˜¯**çº¿ç¨‹æ ‡è¯†**ï¼Œvalueæ˜¯é‡å…¥æ¬¡æ•°ï¼›åŒä¸€çº¿ç¨‹é‡å…¥æ—¶+1ï¼Œé‡Šæ”¾é”æ—¶-1ï¼Œå¦‚æœä¸º0ï¼Œåˆ™é‡Šæ”¾é”ï¼Œå‘å¸ƒæ¶ˆæ¯å”¤é†’è¢«é˜»å¡çš„çº¿ç¨‹ï¼ˆè·å–ä¸åˆ°é”çš„çº¿ç¨‹è¢«`Semaphore`é˜»å¡ï¼Œå…¶å®å°±æ˜¯`AQS`ï¼Œå”¤é†’ä¹Ÿæ˜¯é€šè¿‡`Semaphore`æ¥å”¤é†’ï¼‰

**æ³¨æ„**ï¼šçº¿ç¨‹idåœ¨ä¸åŒæœåŠ¡å™¨ä¹‹é—´å¹¶ä¸æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥å¯¹äºhashç»“æ„çš„å¯ä»¥ï¼Œæœ€å¥½åŠ ä¸ŠIPåœ°å€/MACåœ°å€ï¼›å½“ç„¶Redissonè‡ªå·±åšäº†å¤„ç†ï¼šå®¢æˆ·ç«¯UUID+çº¿ç¨‹ID





## ä»¤ç‰Œå¤§é—¸

æ ¡éªŒåº“å­˜ + é˜²è„šæœ¬åˆ·ç¥¨ï¼Œä¸”å¤©ç„¶é˜²è¶…å–ï¼Œé¿å…è¶…å”®é£é™©

- æ•°æ®åº“åˆ›å»ºä¸€ä¸ª`sk_token`è¡¨ï¼Œä¹Ÿå°±æ˜¯ä»¤ç‰Œè¡¨ï¼Œåˆå§‹åŒ–æ—¶ï¼Œä»¤ç‰Œæ•°ä¸ºæœ€å¤§å”®ç¥¨æ•°ï¼Œ
- å½“ä¸€ä¸ªçº¿ç¨‹è¿›æ¥ï¼Œæ€»ä»¤ç‰Œæ•°`-1`ï¼Œç„¶åç»™çº¿ç¨‹åŠ é”ï¼Œä½¿å¾—å½“å‰ç”¨æˆ·åœ¨ä¸€å®šæ—¶é—´å†…ä¸å¯é‡å¤è®¿é—®ã€‚
- è¿™é‡Œçš„ä»¤ç‰Œä¸»è¦æ˜¯é™åˆ¶äº†å¯¹**æŸæ—¥æŸè½¦æ¬¡**çš„è®¿é—®çš„æµé‡ï¼ˆè€Œä¸æ˜¯æ€»ä½“çš„æµé‡ï¼‰ï¼Œè¿™è®©åé¢æ¥çš„çº¿ç¨‹åœ¨**è·å–ä»¤ç‰Œé˜¶æ®µ**å°±è¢«è¸¢å‡ºï¼Œä½†æ˜¯å¹¶ä¸èƒ½åšåˆ°çœŸæ­£çš„é™æµã€é˜»æ­¢è®¿é—®
- ç”¨æˆ·å°è¯•è·å–ä»¤ç‰Œæ—¶ï¼Œä¼šè¢«åˆ†å¸ƒå¼é”é™åˆ¶ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œå°±å»redisä¸­è·å–ä»¤ç‰Œï¼Œåˆ†å¸ƒå¼é”è®¾ç½®ä¸º5sè¿‡æœŸï¼ŒæœŸé—´é‡å¤è¯·æ±‚éƒ½ä¼šå¤±è´¥ï¼Œæœ‰æ•ˆæŠ‘åˆ¶è„šæœ¬æˆ–äººå·¥é«˜é¢‘é‡å¤è¯·æ±‚

  - > æˆåŠŸåˆ™æ‰§è¡Œåé¢è·å–ä»¤ç‰Œçš„ä»£ç ï¼Œä¸æˆåŠŸåˆ™ä¼šè¢«`tryLock`æ–¹æ³•é˜»å¡ä½5sï¼Œç„¶åå†æ‰§è¡Œä¸‹é¢çš„ä»£ç 


å‰ç«¯é‡‡ç”¨loading + éªŒè¯ç ï¼ˆæ¯ä¸ªäººå¡«å†™éªŒè¯ç çš„æ—¶é—´ä¸åŒï¼Œå¯ä»¥åšåˆ°å‰Šå³°çš„æ•ˆæœï¼‰ç”±äºä¸æ˜¯é‡ç‚¹ï¼Œ**éªŒè¯ç å°±å·æ‡’ä¸åšäº†**ã€‚



æ³¨æ„ï¼šè¿™é‡Œæ˜¯ç”¨é”çš„æ–¹å¼è®©ç”¨æˆ·åœ¨**ä¸€æ®µæ—¶é—´å†…**ä¸èƒ½é‡å¤å‘èµ·è¯·æ±‚ï¼Œä½†æ˜¯å¦‚æœæ˜¯è¦é™åˆ¶â€œ**ä¸€äººä¸€å•**â€çš„è¯ï¼ˆæ¯”å¦‚ä¸€äº›ç”µå•†é¡¹ç›®ï¼‰ï¼Œå°±éœ€è¦ç”¨å…¶ä»–æ–¹æ³•ï¼š

- redisä¸­ç¼“å­˜**åº“å­˜ä¿¡æ¯** + **ç”¨æˆ·idçš„seté›†åˆ**
- ç”¨æˆ·è¯·æ±‚è¿›æ¥ï¼Œåœ¨redisä¸­åšåº“å­˜é¢„æ‰£å‡ + seté›†åˆæ ¡éªŒç”¨æˆ·æ˜¯å¦å·²ç»è´­ä¹°è¿‡ï¼ˆè¿™2æ­¥è¦åŸå­æ€§ï¼Œç”¨luaï¼‰
- æˆåŠŸåç›´æ¥è¿”å›ç»™ç”¨æˆ·è¯´â€œä¸‹å•æˆåŠŸâ€ï¼Œç„¶åæŠŠè®¢å•ä¿¡æ¯æ·»åŠ åˆ°**æ¶ˆæ¯é˜Ÿåˆ—**ï¼ˆè¿™é‡Œé™¤äº†åšä¸€äººä¸€å•çš„é™åˆ¶ï¼Œè¿˜åšäº†å¼‚æ­¥å‰Šå³°ï¼‰
- æ¶ˆè´¹è€…è¯»æ¶ˆæ¯åå†åšæ•°æ®åº“çš„è®¢å•å¤„ç†



å…³äº**ä»¤ç‰Œæ¡¶**ï¼š

- ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯ä¸€ç§å¸¸ç”¨çš„æµé‡æ§åˆ¶ï¼ˆé™æµï¼‰ç®—æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³åœ¨äºç»´æŠ¤ä¸€ä¸ªâ€œä»¤ç‰Œæ¡¶â€ï¼Œè¯¥æ¡¶æŒ‰ç…§**å›ºå®šé€Ÿç‡ä¸æ–­äº§ç”Ÿä»¤ç‰Œ**ï¼Œå¹¶ä»¥é¢„è®¾çš„æœ€å¤§å®¹é‡è¿›è¡Œå­˜å‚¨ã€‚
- å®ç°äº†**å¯¹è¯·æ±‚æµé‡çš„å¹³æ»‘æ§åˆ¶**å’Œçªå‘æµé‡çš„çµæ´»å¤„ç†ã€‚è¿™ç§æœºåˆ¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å°¤ä¸ºæœ‰æ•ˆï¼Œå®ƒä¸ä»…**é™åˆ¶äº†ç³»ç»Ÿçš„å¹³å‡æµé‡**ï¼Œé˜²æ­¢è¿‡è½½ï¼Œè€Œä¸”èƒ½å¤Ÿ**åˆ©ç”¨å¹³æ—¶ç§¯ç´¯çš„ä»¤ç‰Œåº”å¯¹çŸ­æ—¶çš„æµé‡é«˜å³°**ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„æ•´ä½“ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚
- è¿™é‡Œçš„ä»¤ç‰Œå¤§é—¸ä¸ä¸€æ ·ï¼Œé¡¹ç›®ä¸­æ˜¯**ä¸€æ¬¡æ€§ç”Ÿæˆ**ä»¤ç‰Œçš„



# å…³é”®ç»„ä»¶

## ç½‘å…³

### åŸºæœ¬å†…å®¹

ä¸»è¦ä½œç”¨ï¼š

- è·¯ç”±è½¬å‘
- èº«ä»½æ ¡éªŒ

![](image/ç½‘å…³æ¦‚è¿°.png)

å¸¸è§2ç§ç½‘å…³ï¼š

![](image/ç½‘å…³ç§ç±».png)

ä¸»æµä½¿ç”¨`Spring Cloud Gateway`



### åŸºæœ¬ä½¿ç”¨

tipï¼šåœ¨æ‰€æœ‰æ¨¡å—ä¸­ï¼Œ**ä»…gatewayæ¨¡å—é…ç½®å…¬ç½‘ip**ï¼Œä¾›å¤–ç•Œï¼ˆå‰ç«¯ï¼‰è®¿é—®ï¼Œå…¶ä»–æ¨¡å—å‡é…ç½®åœ¨å†…ç½‘

ä¸å¼•å…¥å…¶ä»–ä¾èµ–ï¼Œä»…å¼•å…¥ï¼š

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
        <version>4.1.5</version>
    </dependency>
</dependencies>
```

è¿™ä¸ªä¾èµ–åŸºäº**netty**å®ç°çš„ï¼Œå“åº”å¼ç¼–ç¨‹ï¼Œå› æ­¤ä¸éœ€è¦å¼•å…¥`spring-boot-starter-web`ç­‰æ¨¡å—ï¼›

**é…ç½®è·¯ç”±è½¬å‘**ï¼š

å¼•å…¥ä¾èµ–åï¼Œä»…éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨Applicationåï¼Œå³å¯åšåˆ°è·¯ç”±è½¬å‘ï¼š

```properties
# é…ç½®è·¯ç”±è½¬å‘ï¼Œå°†å½¢å¦‚Pathçš„è¯·æ±‚è½¬å‘åˆ°å¯¹åº”æ¨¡å—
# è·¯ç”±id
spring.cloud.gateway.routes[0].id=member 
# ç›®æ ‡å¾®æœåŠ¡ï¼Œlbæ˜¯è´Ÿè½½å‡è¡¡çš„æ„æ€
spring.cloud.gateway.routes[0].uri=lb://member
# è·¯ç”±æ–­è¨€/è·¯ç”±è§„åˆ™ï¼ŒPathè¡¨ç¤ºæŒ‰ç…§è·¯å¾„å»åˆ¤æ–­
spring.cloud.gateway.routes[0].predicates[0]=Path=/member/**
```

ä¸Šè¿°çš„"ç›®æ ‡å¾®æœåŠ¡"ï¼Œå¦‚æœæ²¡æœ‰æ³¨å†Œä¸­å¿ƒï¼Œåˆ™å†™æˆä¸‹é¢è¿™æ ·

```properties
spring.cloud.gateway.routes[0].uri=http://localhost:8001
```

**ä¿®æ”¹JVMå‚æ•°æ‰“å°æ—¥å¿—**ï¼š

åœ¨IDEAçš„Servicesç•Œé¢å³é”®GateWayApplicationï¼Œé€‰æ‹©ç¼–è¾‘é…ç½®ï¼Œæ·»åŠ VM Optionï¼Œå†…å®¹å¦‚ä¸‹`-Dreactor.netty.http.server.accessLogEnabled=true`ï¼Œå³å¯åœ¨æ¥æ”¶å‚æ•°æ—¶æ‰“å°æ—¥å¿—ï¼Œè¿™ä¸ªåº”è¯¥å°±æ˜¯nettyå®ç°çš„



### ç½‘å…³åº•å±‚è¯·æ±‚å¤„ç†æµç¨‹

1. å…ˆç»è¿‡è·¯ç”±æ˜ å°„å™¨ï¼Œåšè·¯ç”±æ–­è¨€
2. å†è¿‡è¯·æ±‚å¤„ç†å™¨ï¼ŒåŠ è½½è¿‡æ»¤å™¨ï¼ˆé™¤äº†è‡ªå·±å†™çš„ï¼Œè¿˜æœ‰è‡ªå¸¦çš„å¾ˆå¤šè¿‡æ»¤å™¨ï¼‰
3. æ‰§è¡Œè¿‡æ»¤å™¨é“¾ï¼Œæœ€åç»è¿‡Nettyè·¯ç”±è¿‡æ»¤å™¨ï¼Œè½¬å‘å¾®æœåŠ¡

![](image/ç½‘å…³-è¯·æ±‚å¤„ç†æµç¨‹.png)



### å…¨å±€è¿‡æ»¤å™¨ï¼ˆGlobalFilterï¼‰

GlobalFilterä¸éœ€è¦é…ç½®ï¼Œå†™äº†å°±ä¼šæŒ‰ç…§ä¼˜å…ˆçº§æ¥ç”Ÿæ•ˆï¼›

ä»¥åš**ç™»å½•æ‹¦æˆª**ä¸ºä¾‹ï¼Œéœ€è¦å®ç°ä¸€ä¸ªåœ¨**PREé˜¶æ®µ**çš„è¿‡æ»¤å™¨ï¼›Gatewayè½¬å‘ä¿¡æ¯æ—¶ç”¨æˆ·ä¿¡æ¯ä¿å­˜åœ¨**è¯·æ±‚å¤´**ä¸­ï¼ˆå‰ç«¯å‘é€çš„æ—¶å€™ä¿å­˜çš„ï¼‰ï¼Œå½“æœåŠ¡é—´é€šè¿‡OpenFeignè¿œç¨‹è°ƒç”¨æ—¶ï¼Œä¹Ÿæ˜¯æ”¾åœ¨**è¯·æ±‚å¤´**ï¼›

åšæ³•ï¼š

å®ç°`GlobalFilter`æ¥å£ï¼Œé‡å†™å…¶æ–¹æ³•ï¼š

```java
@Override
public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
    ...
}
```

**å…¶ä¸­ï¼š**

- `ServerWebExchange`æ˜¯ä¸€ä¸ªç½‘å…³ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œä¿å­˜ç½‘å…³å†…éƒ¨çš„ä¸€äº›å…±äº«æ•°æ®ï¼›
- `GatewayFilterChain`è¿‡æ»¤å™¨é“¾ï¼Œå¯ä»¥ä¸€ä¸ªè¿‡æ»¤å™¨è°ƒç”¨ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼›
- è¿‡æ»¤å™¨çš„ä»£ç ä¸€å¼€å§‹æ˜¯åœ¨PREé˜¶æ®µæ‰§è¡Œçš„ï¼Œç”±äºPOSTé˜¶æ®µä¹Ÿéœ€è¦è¿›å…¥è¿‡æ»¤å™¨ï¼Œæ‰€ä»¥ç½‘å…³åˆ©ç”¨`Mono`å®šä¹‰å›è°ƒå‡½æ•°ï¼Œå®ç°éé˜»å¡å¼ç¼–ç¨‹ï¼Œè¿‡æ»¤å™¨ä¸éœ€è¦ç­‰å¾…ï¼›
  - ç„¶è€Œä¸€èˆ¬å†™çš„éƒ½æ˜¯PREé˜¶æ®µçš„å†…å®¹ï¼ŒPOSTç›¸å…³çš„å¾ˆå°‘è‡ªå·±å†™

ç”¨`exchange`å¯ä»¥è·å–è¯·æ±‚ä¿¡æ¯ï¼š

```java
// è·å–è¯·æ±‚è·¯å¾„
String path = exchange.getRequest().getURI().getPath();

// è·å–headerçš„tokenå‚æ•°
String token = exchange.getRequest().getHeaders().getFirst("token");
```

è¿”å›ï¼š

```java
// æ”¾è¡Œ
return chain.filter(exchange);
// è¿”å›ç 401ï¼šæ— æƒé™
exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
// ä¸­æ–­è¯·æ±‚
return exchange.getResponse().setComplete();
```

**ä¼˜å…ˆçº§é…ç½®**ï¼šå®ç°`Ordered`æ¥å£ï¼Œé‡å†™`getOrder`æ–¹æ³•ï¼Œè¿”å›ä¼˜å…ˆçº§ï¼Œ**æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜**

```java
@Override
public int getOrder() {
    return 0;
}
```

tipï¼š**Nettyè·¯ç”±è¿‡æ»¤å™¨**çš„ä¼˜å…ˆçº§æ˜¯`Integer.MIN_VALUE`ï¼Œå°±æ˜¯`-21äº¿å¤š`ï¼Œä¹Ÿå°±æ˜¯**ä¼˜å…ˆçº§æœ€å°**ï¼Œæ‰€ä»¥åªéœ€è¦ä¿è¯è‡ªå®šä¹‰è¿‡æ»¤å™¨åœ¨å®ƒä¹‹å‰å³å¯



### è‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼ˆGatewayFilterï¼‰

ä¸€èˆ¬æ˜¯ç¼–å†™GatewayFilterå·¥å‚ï¼Œé‡å†™`apply`æ–¹æ³•è¿”å›ä¸€ä¸ª`GatewayFilter`ï¼Œéœ€è¦ç»§æ‰¿`AbstractGatewayFilterFactory`æŠ½è±¡ç±»ï¼›

> ä¼˜å…ˆçº§çš„é…ç½®ä¸èƒ½ç›´æ¥å®ç°`Ordered` æ¥å£ï¼Œå…·ä½“çœ‹ [è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§](#è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§)

tipï¼šå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥åƒ`GlobalFilter`é‚£æ ·ï¼Œç¼–å†™ä¸€ä¸ªå®ç°äº†`GatewayFilter`çš„ç±»ä½œä¸ºè‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼›å¯æ˜¯åœ¨é…ç½®ä¸­ï¼Œå´æ— æ³•ç›´æ¥é…ç½®è¿™æ ·ç¼–å†™çš„ç±»ï¼Œå¹¶ä¸”å‚æ•°ä¹Ÿéš¾ä»¥ä¼ é€’ï¼Œåªèƒ½ç”¨Javaä»£ç æ¥é…ç½®ï¼›è€Œ**ç¼–å†™å·¥å‚**ä¸ä»…å¯ä»¥ç›´æ¥é…ç½®ï¼Œè¿˜å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç”¨`Config`æ¥æ”¶å‚æ•°ï¼›

- **é…ç½®ä¿¡æ¯**ï¼š
  - éœ€è¦åœ¨è‡ªå®šä¹‰çš„å·¥å‚ç±»ä¸­å†™ä¸Š`Config`å­ç±»ï¼Œä½œä¸ºæŠ½è±¡ç±»çš„æ³›å‹ï¼›
- **é…ç½®å‚æ•°**ï¼š
  - é‡å†™`shortcutFieldOrder`æ–¹æ³•ï¼ŒListä¸­æŒ‡æ˜å‚æ•°çš„é¡ºåºï¼Œç„¶ååœ¨é…ç½®æ–‡ä»¶ä¸­ç”¨**é€—å·**éš”å¼€å‚æ•°ï¼Œå¦‚ï¼š`PrintUserHeaderWithPrefix=X-User-Id, "ã€ç”¨æˆ·ä¿¡æ¯ã€‘"`

```java
/**
 * ç¤ºä¾‹ï¼šè·å–è¯·æ±‚å¤´ä¸­çš„å›½å®¶ä¿¡æ¯
 * æœ‰2ä¸ªé…ç½®å‚æ•°ï¼šheaderåç§° å’Œ æ—¥å¿—å‰ç¼€
 */
@Component
public class PrintUserHeaderWithPrefixGatewayFilterFactory
        extends AbstractGatewayFilterFactory<PrintUserHeaderWithPrefixGatewayFilterFactory.Config> {

    private static final Logger log = LoggerFactory.getLogger(PrintUserHeaderWithPrefixGatewayFilterFactory.class);

    public PrintUserHeaderWithPrefixGatewayFilterFactory() {
        super(Config.class);
    }

    @Override
    public List<String> shortcutFieldOrder() {
        // å‚æ•°é¡ºåºï¼šå…ˆ header åç§°ï¼Œå†æ—¥å¿—å‰ç¼€
        return Arrays.asList("userHeaderName", "logPrefix");
    }

    @Override
    public GatewayFilter apply(Config config) {
        // è¿™é‡Œè¿”å›ä¸€ä¸ªlambdaè¡¨è¾¾å¼ï¼Œæ˜¯ä¸‹é¢çš„ç®€å†™ï¼Œå®é™…ä¸Šæ˜¯è¿”å›ä¸€ä¸ªGatewayFilterçš„å®ç°ç±»
        // return new GatewayFilter() {
        //    @Override
        //    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        //      ....
        //    }
        // };
        return (exchange, chain) -> {
            ServerHttpRequest request = exchange.getRequest();

            String headerValue = request.getHeaders().getFirst(config.getUserHeaderName());
            log.info("{}è¯·æ±‚å¤´ [{}] çš„å€¼ï¼š{}", config.getLogPrefix(), config.getUserHeaderName(), headerValue);

            return chain.filter(exchange).then(Mono.fromRunnable(() ->
                    log.info("{}å¤„ç†å®Œæ¯•", config.getLogPrefix())
            ));
        };
    }

    public static class Config {
        private String userHeaderName;
        private String logPrefix;

        public String getUserHeaderName() {
            return userHeaderName;
        }

        public void setUserHeaderName(String userHeaderName) {
            this.userHeaderName = userHeaderName;
        }

        public String getLogPrefix() {
            return logPrefix;
        }

        public void setLogPrefix(String logPrefix) {
            this.logPrefix = logPrefix;
        }
    }
}
```

é…ç½®ç¤ºä¾‹ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: route-print-header-with-prefix
          uri: http://example-service
          predicates:
            - Path=/api/** 
          filters:
          	# filters ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ header åï¼Œç¬¬äºŒä¸ªæ˜¯å‰ç¼€
            - PrintUserHeaderWithPrefix=X-User-Id, "ã€ç”¨æˆ·ä¿¡æ¯ã€‘" 
```

æˆ–

```properties
spring.cloud.gateway.routes[0].id=route-print-header-with-prefix
spring.cloud.gateway.routes[0].uri=http://example-service
spring.cloud.gateway.routes[0].predicates[0]=Path=/api/**
# filters ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ header åï¼Œç¬¬äºŒä¸ªæ˜¯å‰ç¼€
spring.cloud.gateway.routes[0].filters[0]=PrintUserHeaderWithPrefix=X-User-Id, ã€ç”¨æˆ·ä¿¡æ¯ã€‘
```

> å¯¹äºç½‘å…³çš„é…ç½®ï¼Œyamlçœ‹ç€æ›´èˆ’æœä¸€äº›



### è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§

#### GatewayFilterçš„ä¼˜å…ˆçº§

- å¯¹äº`GlobalFilter`ï¼Œå¯ä»¥ç›´æ¥å®ç°`Ordered`æ¥å£æˆ–åŠ ä¸Š`Order`æ³¨è§£æ¥è®¾å®šä¼˜å…ˆçº§ï¼›

- å¯¹äº`GatewayFilter`ï¼Œç”±äºæˆ‘ä»¬ç¼–å†™çš„æ˜¯`GatewayFilter`çš„å·¥å‚ï¼Œå†é‡å†™æ–¹æ³•è¿”å›å‡ºå»ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯ç›´æ¥ç¼–å†™è¿‡æ»¤å™¨å¯¹è±¡ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å¿…é¡»ä¿®æ”¹`apply`æ–¹æ³•çš„å†…å®¹æ¥æŒ‡å®š`GatewayFilter`çš„ä¼˜å…ˆçº§ï¼Œå…·ä½“åŸå› åé¢åˆ†æä¸€ä¸‹æºç ï¼›
  - å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å°†è¿”å›çš„`GatewayFilter`å¯¹è±¡å†åŒ…ä¸€å±‚`OrderedGatewayFilter`ï¼Œå…¶æ„é€ æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯`GatewayFilter`å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¼˜å…ˆçº§å€¼ï¼›

```java
@Override
public GatewayFilter apply(Config config) {

    @Override
    public GatewayFilter apply(Config config) {
        return new OrderedGatewayFilter((exchange, chain) -> {
            ...
        }, 1);
    }
}
```

##### æºç åˆ†æ

è¿™ä¸ª`OrderedGatewayFilter`æ˜¯`GatewayFilter`æ¥å£å’Œ`Ordered`æ¥å£çš„ä¸€ä¸ªå®ç°ç±»ï¼š

```java
public class OrderedGatewayFilter implements GatewayFilter, Ordered {
    ... //çœç•¥å…¶ä»–å†…å®¹
        
    private final int order;

    public int getOrder() {
        return this.order;
    }

}
```

åœ¨ä¸Šé¢çš„ç½‘å…³ç¤ºæ„å›¾ä¸­ï¼Œæœ‰ä¸€ä¸ªè¯·æ±‚å¤„ç†å™¨`FilteringWebHandler`ï¼›

> `FilteringWebHandler`æºç åœ°å€ï¼šhttps://github.com/spring-cloud/spring-cloud-gateway/blob/main/spring-cloud-gateway-server-webflux/src/main/java/org/springframework/cloud/gateway/handler/FilteringWebHandler.java

ç±»ä¸­è®¾ç½®ä¼˜å…ˆçº§çš„ä»£ç å¦‚ä¸‹ï¼Œç®€å•å¥½æ‡‚ï¼š

```java
// è¿™ä¸ªæ–¹æ³•åœ¨æ„é€ æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œå¤„ç†ä¾èµ–æ³¨å…¥çš„filtersé›†åˆï¼ˆåº”è¯¥æ˜¯ç”¨äº†ä¾èµ–æ³¨å…¥å§ï¼Œå¾…å®šï¼‰
private static List<GatewayFilter> loadFilters(List<GlobalFilter> filters) {
    return filters.stream().map(filter -> {
        GatewayFilterAdapter gatewayFilter = new GatewayFilterAdapter(filter);
        // å¦‚æœfilterå®ç°äº†Orderedæ¥å£
        if (filter instanceof Ordered ordered) { 
            // æ‰‹åŠ¨æ‹¿åˆ°orderå€¼
            int order = ordered.getOrder(); 
            // æ‰‹åŠ¨è¿”å›ä¸€ä¸ªOrderedGatewayFilterå¯¹è±¡
            return new OrderedGatewayFilter(gatewayFilter, order); 
        }
        // å¦‚æœfilteråŠ ä¸Šäº†Orderæ³¨è§£
        else {
            Order order = AnnotationUtils.findAnnotation(filter.getClass(), Order.class);
            if (order != null) {
                // æ‰‹åŠ¨è¿”å›ä¸€ä¸ªOrderedGatewayFilterå¯¹è±¡
                return new OrderedGatewayFilter(gatewayFilter, order.value()); 
            }
        }
        // éƒ½æ²¡æœ‰åˆ™è¿”å›æœ¬èº«
        return gatewayFilter;
    }).collect(Collectors.toList());
}
```



#### æ¡†æ¶ä¸­çš„è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§

å®ä¹ ä¸­ï¼Œæˆ‘éœ€è¦ç¼–å†™ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ ¹æ®ç”¨æˆ·çš„å›½å®¶ä¿¡æ¯ï¼Œè·¯ç”±åˆ°ä¸åŒçš„uriï¼Œä¹Ÿå°±æ˜¯ç›´æ¥è¦†ç›–æ‰é…ç½®ä¸­çš„uriï¼›ç„¶è€Œï¼Œæˆ‘å‘ç°æˆ‘é‡å†™çš„uriä¸­çš„hostéƒ¨åˆ†æ€»ä¼šè¢«æ›¿æ¢ä¸ºé…ç½®ä¸­çš„hostéƒ¨åˆ†ï¼›

åæ¥é˜…è¯»æºç å¯ä»¥å‘ç°ä¸€ä¸ªæ¡†æ¶è‡ªå¸¦çš„**GlobalFilter**ï¼š `RouteToRequestUrlFilter`ï¼Œå®ƒç”¨æ¥è§£æé…ç½®æ–‡ä»¶é‡Œçš„uriï¼Œä¿®æ”¹é‡Œé¢çš„hostä¿¡æ¯ç­‰ï¼Œè¿˜æœ‰è¯†åˆ«'"lb"å­—ç¬¦ä¸²åšè´Ÿè½½å‡è¡¡ï¼›

> `RouteToRequestUrlFilter`æºç åœ°å€ï¼šhttps://github.com/spring-cloud/spring-cloud-gateway/blob/main/spring-cloud-gateway-server-webflux/src/main/java/org/springframework/cloud/gateway/filter/RouteToRequestUrlFilter.java

å¯ä»¥çœ‹åˆ°å…¶ä¸­å†™åˆ°ï¼š

```java
/**
 * Order of Route to URL.
 */
public static final int ROUTE_TO_URL_FILTER_ORDER = 10000;
```

> ä¼˜å…ˆçº§ç›´æ¥å†™æ­»åœ¨äº†ä»£ç ä¸­....ğŸ¤” ä¹Ÿæ²¡æœ‰æ–‡æ¡£å¯ä»¥çœ‹ï¼Œæ„Ÿè§‰æœ‰ç‚¹å±å±±

æ€»ä¹‹ï¼Œæˆ‘éœ€è¦ä½¿æˆ‘çš„è‡ªå®šä¹‰Filterçš„ä¼˜å…ˆçº§ >= 10000ï¼Œä¿è¯åœ¨ `RouteToRequestUrlFilter` ä¹‹åæ‰§è¡Œï¼Œè¿™æ ·æˆ‘çš„uriæ‰ä¼šè¦†ç›–è¿™ä¸ªè‡ªå¸¦çš„GlobalFilteré‡Œè®¾å®šçš„uriï¼›



### è·¯ç”±å±æ€§

é…ç½®æœ€ç»ˆéƒ½æ˜¯ç”±javaç±»å»è¯»å–çš„ï¼Œç½‘å…³è·¯ç”±å¯¹åº”çš„Javaç±»å‹æ˜¯`RouteDefinition`ï¼Œå…¶ä¸­å¸¸è§çš„å±æ€§æœ‰:

- idï¼šè·¯ç”±å”¯ä¸€æ ‡ç¤º
- uriï¼šè·¯ç”±ç›®æ ‡åœ°å€
- predicatesï¼šè·¯ç”±æ–­è¨€ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆå½“å‰è·¯ç”±ã€‚
- filtersï¼šè·¯ç”±è¿‡æ»¤å™¨ï¼Œå¯¹è¯·æ±‚æˆ–å“åº”åšç‰¹æ®Šå¤„ç†

**è·¯ç”±æ–­è¨€ï¼š**ä¸€å…±æœ‰12ç§

![](image/ç½‘å…³-è·¯ç”±æ–­è¨€.png)

**è·¯ç”±è¿‡æ»¤å™¨**ï¼šä¸€å…±æœ‰33ç§

![](image/ç½‘å…³-è·¯ç”±è¿‡æ»¤å™¨.png)

æ­¤å¤–æœ‰`default-filters`é…ç½®ï¼Œå®ƒçš„å±‚çº§æ˜¯è·Ÿ`routes`åŒä¸€çº§ï¼Œæ‰€æœ‰è·¯ç”±éƒ½ç”Ÿæ•ˆï¼š

![](image/ç½‘å…³-è·¯ç”±è¿‡æ»¤å™¨-é»˜è®¤è¿‡æ»¤å™¨.png)



## Quartz

è°ƒåº¦æ¡†æ¶

- ç»Ÿè®¡æŠ¥è¡¨
  - æ·±å¤œèµ„æºä½¿ç”¨ç‡ä¸é«˜æ—¶è¿›è¡Œç»Ÿè®¡
- åŠŸèƒ½è¡¥å¿
  - éƒ¨åˆ†æµç¨‹å› æ„å¤–å¤±è´¥ï¼Œè¿˜æœªå®Œæˆçš„ï¼Œå°†å…¶å®Œæˆ
- ä¸ç´§æ€¥çš„å¤§æ‰¹é‡ä»»åŠ¡

æœ¬é¡¹ç›®ä¸­ï¼Œéœ€è¦æ¯å¤©å»ç”Ÿæˆ15å¤©åçš„è½¦æ¬¡æ•°æ®

### åŸºæœ¬ä½¿ç”¨

å¼•å…¥ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-quartz</artifactId>
</dependency>
```

Quartzä¸­çš„ä»»åŠ¡éœ€è¦å®ç°`org.quartz.Job`æ¥å£ï¼Œé‡å†™`execute`æ–¹æ³•

```java
@DisallowConcurrentExecution // ç¦ç”¨å¹¶å‘ï¼ˆé˜²æ­¢ä¸Šä¸€ä¸ªä»»åŠ¡æ²¡æ‰§è¡Œå®Œå°±å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œé»˜è®¤æ˜¯å¯ä»¥å¹¶å‘çš„ï¼‰
@Component
public class MyJob implements Job {

    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        System.out.println("ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼š" + LocalDateTime.now());
    }
}
```

é…ç½®ç±»

```java
@Configuration
public class QuartzConfig {

    // å®šä¹‰JobDetailï¼Œç»‘å®šå…·ä½“çš„ä»»åŠ¡ç±»
    @Bean
    public JobDetail myJobDetail() {
        return JobBuilder.newJob(MyJob.class)
                .withIdentity("myJob")       // ä»»åŠ¡åç§°
                .storeDurably()              // å³ä½¿æ²¡æœ‰Triggerå…³è”ä¹Ÿä¸ä¼šè¢«åˆ é™¤
                .build();
    }

    // å®šä¹‰Triggerï¼ŒæŒ‡å®šæ‰§è¡Œçš„æ—¶é—´è§„åˆ™ï¼ˆæ­¤å¤„é‡‡ç”¨ç®€å•è°ƒåº¦ï¼‰
    @Bean
    public Trigger myJobTrigger(JobDetail myJobDetail) {
        SimpleScheduleBuilder scheduleBuilder = SimpleScheduleBuilder.simpleSchedule()
                .withIntervalInSeconds(10)   // æ¯10ç§’æ‰§è¡Œä¸€æ¬¡
                .repeatForever();

        return TriggerBuilder.newTrigger()
                .forJob(myJobDetail)
                .withIdentity("myJobTrigger")
                .withSchedule(scheduleBuilder)
                .build();
    }
}
```

æ”¯æŒä½¿ç”¨**Cronè¡¨è¾¾å¼**è¿›è¡Œæ›´å¤æ‚çš„è°ƒåº¦ï¼Œéœ€ä½¿ç”¨`CronScheduleBuilder`

```java
@Bean
public Trigger cronJobTrigger(JobDetail myJobDetail) {
    return TriggerBuilder.newTrigger()
            .forJob(myJobDetail)
            .withIdentity("cronJobTrigger")
            .withSchedule(CronScheduleBuilder.cronSchedule("0/10 * * * * ?"))
            .build();
}
```

### ä½¿ç”¨æ•°æ®åº“é…ç½®è°ƒåº¦ä»»åŠ¡

åˆ›å»º12å¼ è¡¨ï¼ˆå®˜æ–¹æä¾›ï¼‰

```
QRTZ_FIRED_TRIGGERS;
QRTZ_PAUSED_TRIGGER_GRPS;
QRTZ_SCHEDULER_STATE;
QRTZ_LOCKS;
QRTZ_SIMPLE_TRIGGERS;
QRTZ_SIMPROP_TRIGGERS;
QRTZ_CRON_TRIGGERS;
QRTZ_BLOB_TRIGGERS;
QRTZ_TRIGGERS;
QRTZ_JOB_DETAILS;
QRTZ_CALENDARS;
```

é…ç½®æ•°æ®åº“è¿æ¥ï¼Œç•™æ„ä¸€ä¸‹è¿™é‡Œæ˜¯`datasource`

```properties
# é…ç½®æ•°æ®åº“è¿æ¥
spring.datasource.url=jdbc:mysql://localhost:3306/train_batch?characterEncoding=utf8&autoReconnect=true&serverTimezone=Asia/Shanghai
spring.datasource.username=train_batch_user
spring.datasource.password=123456
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
```

è‡ªå®šä¹‰å·¥å‚ï¼Œåœ¨é‡å†™çš„ `createJobInstance` æ–¹æ³•ä¸­ï¼Œå…ˆè°ƒç”¨çˆ¶ç±»æ–¹æ³•åˆ›å»º Job å®ä¾‹ï¼Œç„¶ååˆ©ç”¨ `AutowireCapableBeanFactory` å¯¹è¿™ä¸ªå®ä¾‹è¿›è¡Œè‡ªåŠ¨è£…é…ã€‚è¿™ä¸€æ­¥ç¡®ä¿äº†å³ä½¿ Job æ˜¯ç”± Quartz åˆ›å»ºçš„ï¼Œä¹Ÿèƒ½è‡ªåŠ¨æ³¨å…¥ Spring ç®¡ç†çš„ Beanã€‚

```java
import org.springframework.scheduling.quartz.SpringBeanJobFactory;
import ...

@Component
public class MyJobFactory extends SpringBeanJobFactory {

    @Resource
    private AutowireCapableBeanFactory beanFactory;

    /**
     * é‡å†™createJobInstanceæ–¹æ³•ï¼Œå¯¹å…¶åˆ›å»ºå‡ºæ¥çš„ç±»å†è¿›è¡Œautowireã€‚
     */
    @Override
    protected Object createJobInstance(TriggerFiredBundle bundle) throws Exception {
        Object jobInstance = super.createJobInstance(bundle);
        beanFactory.autowireBean(jobInstance);
        return jobInstance;
    }
}
```

é…ç½®ç±»`SchedulerConfig`ï¼Œç”¨`@Qualifier`è¯»å–`dataSource`ï¼Œå³è¯»å–æ•°æ®åº“é…ç½®

```java
import org.springframework.scheduling.quartz.SchedulerFactoryBean;
import ...
    
@Configuration
public class SchedulerConfig {

    @Resource
    private MyJobFactory myJobFactory;

    @Bean
    public SchedulerFactoryBean schedulerFactoryBean(@Qualifier("dataSource") DataSource dataSource) throws IOException {
        SchedulerFactoryBean factory = new SchedulerFactoryBean();
        factory.setDataSource(dataSource); // è¯»å–dataSourceé…ç½®
        factory.setJobFactory(myJobFactory);
        factory.setStartupDelay(2); // å¯åŠ¨åçš„2såå¼€å§‹æ‰§è¡Œ
        return factory;
    }
}
```

æ¥å£éœ€è¦ä¼ å…¥ä¸‹åˆ—å‚æ•°

```java
@Data
public class CronJobReq {
    // ä»»åŠ¡åˆ†ç»„
    private String group;

    // ä»»åŠ¡åç§°(å…¨é™ç±»å)
    private String name;

    // ä»»åŠ¡æè¿°
    private String description;

    // cronè¡¨è¾¾å¼
    private String cronExpression;
}
```

åœ¨`Controller`ä¸­è°ƒç”¨ä¸åŒçš„æ“ä½œ

```java
@Autowired
private SchedulerFactoryBean schedulerFactoryBean;

// ä¸€ã€å¼ºåˆ¶æ‰§è¡Œä»»åŠ¡
schedulerFactoryBean.getScheduler().triggerJob(JobKey.jobKey(jobClassName, jobGroupName));

// äºŒã€æ·»åŠ æ–°ä»»åŠ¡
try {
    // é€šè¿‡SchedulerFactoryè·å–ä¸€ä¸ªè°ƒåº¦å™¨å®ä¾‹
    Scheduler sched = schedulerFactoryBean.getScheduler();
    // å¯åŠ¨è°ƒåº¦å™¨
    sched.start();
    // æ„å»ºjobä¿¡æ¯
    JobDetail jobDetail = JobBuilder
        .newJob((Class<? extends Job>) Class.forName(jobClassName))
        .withIdentity(jobClassName, jobGroupName)
        .build();
    // è¡¨è¾¾å¼è°ƒåº¦æ„å»ºå™¨(å³ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´)
    CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(cronExpression);
    // æŒ‰æ–°çš„cronExpressionè¡¨è¾¾å¼æ„å»ºä¸€ä¸ªæ–°çš„trigger
    CronTrigger trigger = TriggerBuilder
        .newTrigger()
        .withIdentity(jobClassName, jobGroupName)
        .withDescription(description)
        .withSchedule(scheduleBuilder)
        .build();
    
    sched.scheduleJob(jobDetail, trigger);
} catch (SchedulerException e) {
    return CommonResp.error("åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤±è´¥:è°ƒåº¦å¼‚å¸¸");
} catch (ClassNotFoundException e) {
    return CommonResp.error("åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤±è´¥ï¼šä»»åŠ¡ç±»ä¸å­˜åœ¨");
}

// ä¸‰ã€æš‚åœä»»åŠ¡
try {
    schedulerFactoryBean.getScheduler().pauseJob(JobKey.jobKey(jobClassName, jobGroupName));
} catch (SchedulerException e) {
    return CommonResp.error("æš‚åœå®šæ—¶ä»»åŠ¡å¤±è´¥:è°ƒåº¦å¼‚å¸¸");
}

// å››ã€é‡å¯ä»»åŠ¡
try {
    schedulerFactoryBean.getScheduler().resumeJob(JobKey.jobKey(jobClassName, jobGroupName));
} catch (SchedulerException e) {
    return CommonResp.error("é‡å¯å®šæ—¶ä»»åŠ¡å¤±è´¥:è°ƒåº¦å¼‚å¸¸");
}

// äº”ã€é‡ç½®/æ›´æ–°ä»»åŠ¡
try {
    Scheduler scheduler = schedulerFactoryBean.getScheduler();
    TriggerKey triggerKey = TriggerKey.triggerKey(jobClassName, jobGroupName);
    // è¡¨è¾¾å¼è°ƒåº¦æ„å»ºå™¨
    CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(cronExpression);
    CronTriggerImpl trigger1 = (CronTriggerImpl) scheduler.getTrigger(triggerKey);
    trigger1.setStartTime(new Date()); // é‡æ–°è®¾ç½®å¼€å§‹æ—¶é—´
    CronTrigger trigger = trigger1;
    // æŒ‰æ–°çš„cronExpressionè¡¨è¾¾å¼é‡æ–°æ„å»ºtrigger
    trigger = trigger
        .getTriggerBuilder()
        .withIdentity(triggerKey)
        .withDescription(description)
        .withSchedule(scheduleBuilder)
        .build();
    // æŒ‰æ–°çš„triggeré‡æ–°è®¾ç½®jobæ‰§è¡Œ
    scheduler.rescheduleJob(triggerKey, trigger);
} catch (Exception e) {
    LOG.error("æ›´æ–°å®šæ—¶ä»»åŠ¡å¤±è´¥:" + e);
    return CommonResp.error("æ›´æ–°å®šæ—¶ä»»åŠ¡å¤±è´¥:è°ƒåº¦å¼‚å¸¸");
}

// å…­ã€åˆ é™¤ä»»åŠ¡
try {
    Scheduler scheduler = schedulerFactoryBean.getScheduler();
    scheduler.pauseTrigger(TriggerKey.triggerKey(jobClassName, jobGroupName));
    scheduler.unscheduleJob(TriggerKey.triggerKey(jobClassName, jobGroupName));
    scheduler.deleteJob(JobKey.jobKey(jobClassName, jobGroupName));
} catch (SchedulerException e) {
    return CommonResp.error("åˆ é™¤å®šæ—¶ä»»åŠ¡å¤±è´¥:è°ƒåº¦å¼‚å¸¸");
}
```



## OpenFeign

è¿œç¨‹è°ƒç”¨

### åŸºæœ¬ä½¿ç”¨

è¯¥æ–¹æ³•ä¸æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œå¦‚æœå¤šä¸ªæœåŠ¡è¦ä½¿ç”¨ï¼Œé‚£æ¯ä¸ªæœåŠ¡é‡Œé¢éƒ½è¦åšç¼–å†™æ¥å£ç­‰ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼›çœ‹[æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

**è°ƒç”¨æ–¹æ·»åŠ ä¾èµ–ï¼š**

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
<!-- openfeigné»˜è®¤ä½¿ç”¨loadBalanceçš„è´Ÿè½½å‡è¡¡å™¨ -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-loadbalancer</artifactId>
</dependency>
```

**ç¼–å†™feignæ¥å£ï¼š**

- ä¾‹å­æ˜¯åœ¨**batchæ¨¡å—**è°ƒç”¨**businessæ¨¡å—**
  - è¿™é‡Œé€šè¿‡æ³¨è§£å‘Šè¯‰äº†OpenFeignå¾ˆå¤šä¿¡æ¯ï¼šæœåŠ¡åç§°businessã€è¯·æ±‚æ–¹å¼GETã€è¯·æ±‚åœ°å€ï¼Œè¯·æ±‚å‚æ•°ï¼Œè¿”å›å€¼ç­‰

  - OpenFeignä¼šè‡ªåŠ¨åšè´Ÿè½½å‡è¡¡ï¼Œé€‰æ‹©businessçš„æŸä¸ªå®ä¾‹

- è¿™é‡Œçš„`@FeignClient`æ³¨è§£å‚æ•°çš„åº”ç”¨åç§°ï¼Œéœ€è¦é…ç½®åœ¨**æ³¨å†Œä¸­å¿ƒ**ï¼Œå¯ä»¥å®ç°è´Ÿè½½å‡è¡¡
- å¦‚æœè¿˜æ²¡åšæ³¨å†Œä¸­å¿ƒï¼Œå¯ä»¥å…ˆç›´æ¥ç”¨ipæ¥è°ƒç”¨
  - `@FeignClient(name = "business", url = "http://localhost:8002/business")`
- è¿˜æœ‰ä¸€ä¸ª`fallback`å‚æ•°ï¼ŒæŒ‡å®šè°ƒç”¨çš„æœåŠ¡åç§°ï¼Œå¦‚æœæœåŠ¡ä¸å¯ç”¨åˆ™è°ƒç”¨ fallback ç±» `XxxFallback`
  - `@FeignClient(name = "user-service", fallback = XxxFallback.class)`
  - fallbackç±»å³**å®ç°äº†feignæ¥å£**çš„ç±»ï¼Œéœ€è¦åŠ ä¸Š`@Component`ï¼Œé‡å†™å¯¹åº”çš„æ–¹æ³•ï¼ˆä¾‹å¦‚ä¸‹é¢çš„`testConnect()`æ–¹æ³•ï¼‰å³å¯

```java
@FeignClient("business")
public interface BusinessFeign {
    @GetMapping("/test-connect")
    String testConnect();
}
```

**é…ç½®å¯åŠ¨ç±»ï¼š**

éœ€è¦åœ¨`BatchApplication`å¯åŠ¨ç±»ä¸ŠåŠ ä¸Šæ³¨è§£ï¼Œè¯†åˆ«å¯¹åº”çš„åŒ…

```java
@EnableFeignClients("com.criel.train.batch.feign")
```

**ç¼–å†™Controllerï¼š**

businessæ¨¡å—ä¸­çš„Controllerï¼š

- æ­£å¸¸ç¼–å†™å³å¯

```java
@RestController
public class TestController {
    @GetMapping("/test-connect")
    public String testConnect(@RequestParam("str") String str) {
        return "business test success" + str;
    }
}
```

batchæ¨¡å—ä¸­çš„Controllerï¼š

- æ³¨å…¥feignæ¥å£ï¼Œç„¶åè°ƒç”¨ç›¸åº”æ–¹æ³•å³å¯

```java
@RestController
public class TestController {

    private static final Logger LOG = LoggerFactory.getLogger(BatchApplication.class);

    @Autowired
    private BusinessFeign businessFeign;

    @GetMapping("/test-connect")
    public String testConnect() {
        String feignRes = businessFeign.testConnect();
        LOG.info("feignRes: {}", feignRes);
        return "batch test success ";
    }
}
```



### åº•å±‚åŸç†

é»˜è®¤å®ç°ï¼ˆHttpURLConnectionï¼‰ï¼š

1. é¦–å…ˆæ³¨å…¥çš„æ¥å£å°±ä¼šå˜æˆä¸€ä¸ª**ä»£ç†å¯¹è±¡**ï¼Œåº•å±‚å»`invoke`è°ƒç”¨å†™çš„æ–¹æ³•ï¼›

2. é€šè¿‡`RequestTemplate`è·å¾—è¯·æ±‚ç±»å‹&è¯·æ±‚å‚æ•°ï¼Œä¾‹å¦‚`GET /test-connect?str=abc123 HTTP...`ï¼ˆè¿™ä¸ªæ˜¯`RequestTemplate`å¯¹è±¡çš„æ•°æ®ï¼‰ï¼›

3. é€šè¿‡è¯·æ±‚ç±»å‹å’Œå‚æ•°æ„å»º`Request`å¯¹è±¡ï¼Œä¾‹å¦‚`GET http://business/test-connect?str=abc123`ï¼Œæ­¤æ—¶è·¯å¾„é‡Œè¿˜æ˜¯**æœåŠ¡åç§°ï¼›**

4. é€šè¿‡`Request`å¯¹è±¡è·å–`serverId`ï¼Œå³æœåŠ¡åç§°ï¼›

5. é€šè¿‡**è´Ÿè½½å‡è¡¡**æ‹‰å–å®ä¾‹`ServiceInstance`ï¼Œ`instance`å¯¹è±¡åŒ…å«æœåŠ¡çš„ä¿¡æ¯ï¼š`serverId`æœåŠ¡åç§°, `host`æœåŠ¡åœ°å€, `port`æœåŠ¡ç«¯å£ç­‰ï¼›

   - ```java
     ServiceInstance instance = loadBalancerclient.choose(serviceId,lbRequest);
     ```

6. è·å–æœåŠ¡çš„ä¿¡æ¯åå°±å¯ä»¥é‡æ„åœ°å€ï¼Œè·å¾—å®Œæ•´åœ°å€ï¼Œä¾‹å¦‚`http://192.168.150.1:8081/test-connect?str=abc123`

7. æœ€åé€šè¿‡`HttpURLConnection`ï¼ˆJDKè‡ªå¸¦çš„ï¼‰æ¥å‘é€è¯·æ±‚ï¼Œä»£ç ä¸­æ‰‹åŠ¨å»å»ºç«‹è¿æ¥ï¼Œåˆ©ç”¨ioæµåšè¯»å†™æ“ä½œ**ï¼ˆæ•ˆç‡ä¸é«˜ï¼‰**

å‘èµ·httpè¯·æ±‚çš„æ¡†æ¶æœ‰ä»¥ä¸‹3ç§ï¼š

- **HttpURLConnection**ï¼šé»˜è®¤å®ç°ï¼Œä¸æ”¯æŒè¿æ¥æ± 
- **Apache HttpClient**ï¼šæ”¯æŒè¿æ¥æ± 
- **OKHttp**ï¼šæ”¯æŒè¿æ¥æ± 

ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå¯ä»¥**æ”¹ç”¨è¿æ¥æ± **ï¼Œå…·ä½“é…ç½®æ­¥éª¤å¦‚ä¸‹ï¼Œä»¥OKHttpä¸ºä¾‹ï¼š

å¼•å…¥ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-okhttp</artifactId>
</dependency>
```

å¼€å¯è¿æ¥æ± ï¼š

```properties
feign.okhttp.enabled=true
```



### æœ€ä½³å®è·µ

ä»¥é»‘é©¬å•†åŸé‡Œçš„3ä¸ªæœåŠ¡ä¸ºä¾‹ï¼šä¸šåŠ¡ã€è´­ç‰©è½¦ã€è®¢å•

- æ–¹æ¡ˆä¸€ï¼š
  - åœ¨ä¸šåŠ¡æ¨¡å—æ–°å¢3ä¸ªå­æ¨¡å—ï¼Œä¸€ä¸ªå­˜æ”¾feignéœ€è¦ç”¨åˆ°çš„dtoï¼Œä¸€ä¸ªå­˜æ”¾feignæ¥å£ï¼Œä¸€ä¸ªå°±æ˜¯åŸæœ¬çš„ä¸šåŠ¡æ¨¡å—
  - å…¶ä»–æœåŠ¡éœ€è¦åœ¨pomä¸­å¼•å…¥å‰2ä¸ªå­æ¨¡å—
  - ç‰¹ç‚¹ï¼šè€¦åˆåº¦è¾ƒä½ï¼Œfeignç”±ä¸€ä¸ªæœåŠ¡çš„å›¢é˜Ÿæ¥ç»´æŠ¤
  - ![](image/OpenFeign-æœ€ä½³å®è·µ1.png)

- æ–¹æ¡ˆäºŒï¼š
  - æ–°å»ºapiæ¨¡å—ï¼Œé‡Œé¢åŒæ ·å»ç¼–å†™dtoï¼Œfeignæ¥å£
  - å…¶ä»–æœåŠ¡ç›´æ¥åœ¨pomä¸­å¼•ç”¨è¯¥æ¨¡å—
  - ç‰¹ç‚¹ï¼šè€¦åˆåº¦è¾ƒé«˜ï¼Œä½†ä¸ä¼šç ´ååŸæœ¬çš„é¡¹ç›®ç»“æ„
  - ![](image/OpenFeign-æœ€ä½³å®è·µ2.png)



### æ—¥å¿—çº§åˆ«

å¼•å…¥`feign.Logger`ï¼Œç¼–å†™ä¸€ä¸ª`Bean`ï¼Œè®¾ç½®å¯¹åº”çš„æ—¥å¿—çº§åˆ«ï¼Œä»¥`FULL`ä¸ºä¾‹ï¼š

```java
import feign.Logger;
import org.springframework.context.annotation.Bean;

public class DefaultFeignconfig {
    @Bean
    public Logger.Level feignLoggerLevel(){
        return Logger.Level.FULL;
    }
}
```

åŠ åœ¨å¯åŠ¨çš„æ³¨è§£ä¸Šï¼š

```java
@EnableFeignClients(
    basePackages="com.criel.train.batch.feign",
    defaultConfiguration=DefaultFeignconfig.class
)
```



### ç”¨æˆ·ä¿¡æ¯ä¼ é€’

12306é‡Œæ˜¯æŠŠç”¨æˆ·ä¿¡æ¯å½“è¯·æ±‚å‚æ•°äº†ï¼Œè€Œé»‘é©¬å•†åŸæ˜¯ä»**è¯·æ±‚å¤´**è·å–ç”¨æˆ·ä¿¡æ¯ï¼›

æ€è€ƒï¼šå®é™…ä¸Š12306é‡Œï¼Œåœ¨è·¯ç”±è½¬å‘ä¸æ¥æ”¶é‡Œä¹Ÿæœ‰æŠŠç”¨æˆ·ä¿¡æ¯æ”¾è¯·æ±‚å¤´ï¼ˆç½‘å…³å…¶å®å°±æ˜¯æŠŠå‰ç«¯çš„è¯·æ±‚å¤´åŸåŸæœ¬æœ¬åœ°å‘ç»™å¾®æœåŠ¡ï¼‰ï¼Œä½†æ˜¯**è¿œç¨‹è°ƒç”¨æ—¶æ²¡æœ‰**ï¼Œè™½ç„¶æ¯ä¸ªå¾®æœåŠ¡éƒ½å¼•å…¥äº†`common`é‡Œçš„æ‹¦æˆªå™¨æ–¹æ³•ï¼Œä½†æ˜¯å‘é€è¿œç¨‹è°ƒç”¨çš„æ—¶å€™å¹¶æ²¡æœ‰å‘é€åŸæœ¬çš„ç”¨æˆ·ä¿¡æ¯ï¼›

é»‘é©¬å•†åŸçš„è¯·æ±‚æµç¨‹å¦‚ä¸‹ï¼›ä¸12306ä¸åŒçš„æ˜¯ï¼Œå…¶åœ¨ç½‘å…³è§£æjwtåï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°è¯·æ±‚å¤´ï¼Œå‘ç»™å¾®æœåŠ¡ï¼Œå…¶ä»–å¾®æœåŠ¡ä¸éœ€è¦åŒºè§£æjwtäº†ï¼Œè€Œä¸”æœåŠ¡é—´ä¼ é€’ä¹Ÿä¸€æ ·ç”¨è¯·æ±‚å¤´ï¼Œåªéœ€è¦æŠŠThreadLocalé‡Œé¢çš„ç”¨æˆ·ä¿¡æ¯å–å‡ºæ¥æ”¾è¯·æ±‚å¤´å°±å¥½äº†
![](image/é»‘é©¬å•†åŸ-ç”¨æˆ·è¯·æ±‚æµç¨‹.png)

å®ç°OpenFeignæä¾›çš„æ‹¦æˆªå™¨æ¥å£ï¼Œå¯ä»¥ç›´æ¥å†™åœ¨ä¸Šé¢å†™è¿‡çš„é…ç½®ç±»é‡Œï¼Œé€šè¿‡`template`å¯ä»¥å¯¹å‘å‡ºçš„è¯·æ±‚å‚æ•°åšå¤„ç†ï¼š

```java
import feign.Logger;
import org.springframework.context.annotation.Bean;

public class DefaultFeignconfig {
    @Bean
    public Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;
    }

    @Bean
    public RequestInterceptor userInfoRequestInterceptor() {
        return new RequestInterceptor() {
            @0verride
            public void apply(RequestTemplate template) {
                Long userId = UserContext.getUser();
                if(userId != null){
                    template.header("user-info",userId.tostring());
                }
            }
        };
    }
}
```





## Nacos

æ³¨å†Œä¸­å¿ƒä¸é…ç½®ä¸­å¿ƒnacos

### åŸºæœ¬å†…å®¹

å®˜ç½‘è¯´ï¼šNacos `/nÉ‘:kÉ™ÊŠs/` æ˜¯ Dynamic Naming and Configuration Serviceçš„é¦–å­—æ¯ç®€ç§°ï¼ˆè¿™æ ¹æœ¬æ²¡æœ‰å¯¹åº”ä¸Šå¥½å—ï¼‰

**æ³¨å†Œä¸­å¿ƒï¼š**

- å¥åº·æ£€æµ‹
  - æ£€æµ‹æ˜¯å¦æœ‰èŠ‚ç‚¹æŒ‚äº†
  - æ§åˆ¶èŠ‚ç‚¹çš„ä¸Šä¸‹çº¿
- è·¯ç”±è½¬å‘
  - springcloudçš„gatewayæ˜¯æ ¹æ®ipå»è·¯ç”±è½¬å‘ï¼Œä¸é€‚åˆåŠ¨æ€æ‰©å®¹ã€å¤šèŠ‚ç‚¹ç­‰æƒ…å†µ
  - nacosä¸­åªéœ€è¦çŸ¥é“æ¨¡å—çš„åå­—å³å¯è½¬å‘ï¼Œç»“åˆé…ç½®åšè½¬å‘
- è¿œç¨‹è°ƒç”¨
  - æ ¹æ®åå­—å»è·¯ç”±è½¬å‘

**é…ç½®ä¸­å¿ƒï¼š**

- åŠ¨æ€ä¿®æ”¹çº¿ä¸Šçš„é…ç½®ï¼Œä¸éœ€è¦é‡å¯é¡¹ç›®
- é…ç½®å¼€å…³é¡¹ã€é˜ˆå€¼ï¼ˆä¾‹å¦‚è¶…æ—¶æ—¶é—´ï¼‰ã€æšä¸¾é¡¹æ‰©å±•ç­‰

![springcloud-nacos](../Javaå…«è‚¡/springcloud-nacos.png)



ä»¥ä¸‹å†…å®¹æ¥è‡ªGPTï¼š

#### ä¸€è‡´æ€§æ¨¡å¼

åœ¨é›†ç¾¤éƒ¨ç½²ä¸­ï¼ŒNacos æœåŠ¡ç«¯ä¼šé€šè¿‡å†…éƒ¨æ•°æ®åŒæ­¥åè®®æ¥ä¿æŒå„ä¸ªèŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ï¼ŒåŒæ—¶æ”¯æŒ AP ä¸ CP ä¸¤ç§ä¸€è‡´æ€§æ¨¡å¼ï¼š

- **AP æ¨¡å¼**ï¼šé’ˆå¯¹ä¸´æ—¶å®ä¾‹ï¼ˆæœåŠ¡ç«¯ä»…åœ¨å†…å­˜ä¸­ç»´æŠ¤æ•°æ®ï¼‰ï¼Œä¾§é‡é«˜å¯ç”¨ä¸å¿«é€Ÿå“åº”ã€‚
- **CP æ¨¡å¼**ï¼šé’ˆå¯¹æ°¸ä¹…å®ä¾‹ï¼ˆæ•°æ®ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ï¼‰ï¼Œé‡‡ç”¨åŸºäº Raftï¼ˆæˆ– JRaftï¼‰çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œç¡®ä¿æ•°æ®å¼ºä¸€è‡´æ€§ã€‚

#### å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹

- **1.x ç‰ˆæœ¬**
   å®¢æˆ·ç«¯é€šè¿‡ HTTP æ¥å£è°ƒç”¨ Nacos Serverï¼Œå°†è‡ªèº«ä¿¡æ¯ï¼ˆIPã€ç«¯å£ã€æœåŠ¡åç­‰ï¼‰æ³¨å†Œåˆ°æœåŠ¡ç«¯ã€‚æ³¨å†Œæ—¶ä¼šç«‹å³å°†å®ä¾‹ä¿¡æ¯å†™å…¥å†…å­˜æ³¨å†Œè¡¨ï¼ŒåŒæ—¶å¯åŠ¨å¿ƒè·³å®šæ—¶ä»»åŠ¡ï¼Œæ¯ 5 ç§’ä¸ŠæŠ¥ä¸€æ¬¡ï¼›æœåŠ¡ç«¯å®šæ—¶æ£€æŸ¥å¿ƒè·³æ—¶é—´ï¼Œè‹¥è¶…è¿‡ 15 ç§’æ ‡è®°ä¸ºä¸å¥åº·ï¼Œè¶…è¿‡ 30 ç§’åˆ™å‰”é™¤ã€‚
- **2.x ç‰ˆæœ¬**
   ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒNacos å°†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡åè®®ç”± HTTP æ”¹ä¸º gRPC é•¿è¿æ¥ã€‚å®¢æˆ·ç«¯å¯åŠ¨æ—¶å»ºç«‹é•¿è¿æ¥ï¼Œæ‰€æœ‰æ³¨å†Œã€è®¢é˜…ã€å¿ƒè·³ç­‰é€šä¿¡å‡åŸºäºæ­¤é•¿è¿æ¥è¿›è¡Œï¼›æ­¤å¤–è¿˜å¼•å…¥äº† **Redo æœºåˆ¶**ï¼Œåœ¨ç½‘ç»œå¼‚å¸¸æˆ–è¿æ¥æ–­å¼€åï¼Œä¼šè‡ªåŠ¨é‡åšæ³¨å†Œå’Œè®¢é˜…æ“ä½œï¼Œç¡®ä¿æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚

åœ¨ 2.x ä¸­ï¼Œä¸ºæå‡æ³¨å†Œæ€§èƒ½ï¼ŒNacos é‡‡ç”¨äº†**å¼‚æ­¥æ³¨å†Œ**è®¾è®¡ï¼š

å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶é€šè¿‡ Spring Boot çš„è‡ªåŠ¨é…ç½®æœºåˆ¶ï¼ˆä¾‹å¦‚ NacosAutoServiceRegistrationï¼‰è‡ªåŠ¨è§¦å‘æ³¨å†Œæµç¨‹ï¼Œå°†æ³¨å†Œä»»åŠ¡æäº¤åˆ°å†…éƒ¨çš„é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç”±ä¸“é—¨çš„å¼‚æ­¥çº¿ç¨‹å¤„ç†ï¼Œè¿™æ ·å¯ä»¥å¤§å¹…é™ä½æœåŠ¡å¯åŠ¨æ—¶çš„å»¶è¿Ÿã€‚

#### æ³¨å†Œæµç¨‹å…³é”®æ­¥éª¤

1. **å®ä¾‹ä¿¡æ¯ç»„è£…**
   - å®¢æˆ·ç«¯å°†æ³¨å†Œæ—¶çš„å„é¡¹ä¿¡æ¯å°è£…ä¸º Instance å¯¹è±¡ï¼Œè®¾ç½® IPã€ç«¯å£ã€æƒé‡ã€é›†ç¾¤åã€å…ƒæ•°æ®ä»¥åŠä¸´æ—¶æˆ–æ°¸ä¹…æ ‡è¯†ã€‚
2. **è¿æ¥èŠ‚ç‚¹é€‰æ‹©**
   - åœ¨é›†ç¾¤ç¯å¢ƒä¸­ï¼Œå®¢æˆ·ç«¯ä¼šéšæœºä» Nacos é›†ç¾¤ä¸­é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ã€‚
3. **æœåŠ¡æ³¨å†Œ API è°ƒç”¨**
   - è°ƒç”¨ Nacos æä¾›çš„æ³¨å†Œ APIï¼ˆä¾‹å¦‚ `/nacos/v1/ns/instance`ï¼‰ï¼ŒæœåŠ¡ç«¯è§£æè¯·æ±‚åå°†å®ä¾‹ä¿¡æ¯å†™å…¥å†…å­˜æ³¨å†Œè¡¨ï¼ˆAP æ¨¡å¼ï¼‰æˆ–å†™å…¥æŒä¹…åŒ–å­˜å‚¨ï¼ˆCP æ¨¡å¼ï¼‰ã€‚
4. **å¿ƒè·³ä¸å¥åº·æ£€æŸ¥**
   - å®¢æˆ·ç«¯æ³¨å†ŒæˆåŠŸåå¯åŠ¨å¿ƒè·³ä»»åŠ¡ï¼›æœåŠ¡ç«¯åˆ™é€šè¿‡å¿ƒè·³å’Œä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆå¦‚ TCPã€HTTP æˆ–ç‰¹å®šæ•°æ®åº“æ£€æµ‹ï¼‰æ¥åˆ¤æ–­å®ä¾‹å¥åº·ã€‚
5. **å¼‚æ­¥åŒæ­¥ä¸äº‹ä»¶æ¨é€**
   - åœ¨æœåŠ¡ç«¯ï¼Œå®ä¾‹æ³¨å†Œæ›´æ–°æ“ä½œä¼šå°†æ•°æ®åŒæ­¥åˆ°é›†ç¾¤ä¸­ï¼ˆAP æ¶æ„ä¸‹é€šè¿‡è‡ªç ” Distro åè®®ï¼‰ï¼ŒåŒæ—¶é€šè¿‡å¼‚æ­¥ä»»åŠ¡å’Œé€šçŸ¥æœºåˆ¶ï¼ˆåˆ©ç”¨é˜»å¡é˜Ÿåˆ—ï¼‰æ¨é€æ›´æ–°ç»™è®¢é˜…è¯¥æœåŠ¡çš„å®¢æˆ·ç«¯ã€‚

#### é…ç½®ä¸­å¿ƒå®ç°åŸç†

Nacos åŒæ—¶æä¾›äº†åŠ¨æ€é…ç½®ç®¡ç†åŠŸèƒ½ï¼Œå…¶ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š

1. **å®¢æˆ·ç«¯æ‹‰å–ä¸ç¼“å­˜**
   - åº”ç”¨å¯åŠ¨æ—¶ï¼Œé€šè¿‡ SDK è°ƒç”¨é…ç½® APIï¼ˆä¾‹å¦‚ `getConfig`ï¼‰ï¼Œé¦–å…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜åŠ è½½é…ç½®ï¼›è‹¥ç¼“å­˜ä¸ºç©ºï¼Œåˆ™é€šè¿‡ HTTP è¯·æ±‚ä»æœåŠ¡ç«¯è·å–ã€‚
2. **é…ç½®å‘å¸ƒä¸ç›‘å¬**
   - ç”¨æˆ·æˆ–ç³»ç»Ÿé€šè¿‡é…ç½®ä¸­å¿ƒ API å‘å¸ƒé…ç½®ã€‚æœåŠ¡ç«¯æ¥æ”¶åˆ°æ›´æ–°åï¼Œä¼šæŒä¹…åŒ–åˆ°æ•°æ®åº“æˆ–ç£ç›˜ï¼Œå¹¶å°†å˜æ›´é€šçŸ¥æ¨é€ç»™æ‰€æœ‰è®¢é˜…è¯¥é…ç½®çš„å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯é€šè¿‡ `@NacosValue` ç­‰æ³¨è§£è‡ªåŠ¨åˆ·æ–°é…ç½®ï¼Œå®Œæˆæ— ç¼çƒ­æ›´æ–°ã€‚
3. **å¤šç§Ÿæˆ·ä¸åˆ†ç»„ç®¡ç†**
   - é…ç½®æ•°æ®åŒæ ·æŒ‰ç…§ Namespaceã€Group å’Œ DataId è¿›è¡Œç»„ç»‡ï¼Œæ”¯æŒå¤šç¯å¢ƒã€åˆ†å±‚ç®¡ç†ï¼Œæ»¡è¶³ä¼ä¸šçº§åœºæ™¯è¦æ±‚ã€‚



### è¿è¡Œnacos

è¿›å…¥nacosçš„å®‰è£…ç›®å½•ä¸‹çš„`conf/application.properties`é…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹`nacos.core.auth.plugin.nacos.token.secret.key`å­—æ®µï¼Œè¿™é‡Œçš„keyæ˜¯ä¸€ä¸ª**32ä½çš„Base64ç¼–ç **ï¼Œè‡ªå·±å®šä¹‰ï¼Œæˆ‘è¿™é‡Œå°±éšä¾¿å†™äº†ä¸ª

```properties
### worked when nacos.core.auth.system.type=nacos
### The token expiration in seconds:
nacos.core.auth.plugin.nacos.token.cache.enable=false
nacos.core.auth.plugin.nacos.token.expire.seconds=18000
### The default token (Base64 String):
nacos.core.auth.plugin.nacos.token.secret.key=MzJiaXRzY29kZTEyMzQ1Njc4OTAxMjM0NTY3ODkwMTE=
```

æ‰“å¼€cmdï¼Œcdåˆ°nacosçš„å®‰è£…ç›®å½•ä¸‹çš„`bin/`è·¯å¾„ä¸‹ï¼Œå¯åŠ¨å‘½ä»¤ï¼ˆstandaloneä»£è¡¨ç€å•æœºæ¨¡å¼è¿è¡Œï¼Œéé›†ç¾¤æ¨¡å¼ï¼‰ï¼š

```cmd
startup.cmd -m standalone
```

å¯åŠ¨åè¿›å…¥`http://localhost:8848/nacos`ç½‘é¡µå°±å¯ä»¥è®¿é—®å‰ç«¯æ§å°äº†ï¼Œåœ¨æ§å°ä¸­éœ€è¦åˆ›å»ºé¡¹ç›®ä¸­å¯¹åº”çš„é…ç½®ã€‚

å…³äº**å‘½åç©ºé—´**ï¼šä¸€èˆ¬ç”¨äºåšé¡¹ç›®éš”ç¦»ï¼Œä¸€ä¸ªé¡¹ç›®çš„é…ç½®æ–‡ä»¶æ”¾åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­



### åŸºæœ¬ä½¿ç”¨

åœ¨çˆ¶æ¨¡å—å¼•å…¥SpringCloudAlibabaä¾èµ–ï¼š

```xml
<properties>
    <java.version>17</java.version>
    <spring-cloud.version>2024.0.0</spring-cloud.version>
    <spring-cloud-alibaba.version>2022.0.0.0</spring-cloud-alibaba.version>
</properties>

<dependencyManagement>
    <dependencies>
		...
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>${spring-cloud-alibaba.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        ...
    </dependencies>
</dependencyManagement>
```

å­æ¨¡å—å¼•å…¥nacosï¼š

```xml
<!-- Nacos æœåŠ¡å‘ç°ï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰ -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!-- Nacos é…ç½®ä¸­å¿ƒ -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

å­æ¨¡å—æ·»åŠ `bootstrap.properties`ï¼Œè¯»å–è¯¥é…ç½®å‰éœ€è¦æ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š

```properties
# è¯¥æ–‡ä»¶ç”¨äºè¯»springcloudé…ç½®

# åº”ç”¨åç§°
spring.application.name=member
# å¯åŠ¨ç¯å¢ƒ
spring.profiles.active=dev
# nacos serverï¼ˆé…ç½®ä¸­å¿ƒï¼‰çš„åœ°å€
spring.cloud.nacos.config.server-addr=127.0.0.1:8848
# é…ç½®ä¸­å¿ƒæ–‡ä»¶åç¼€
spring.cloud.nacos.config.file-extension=properties
# nacosä¸­çš„å‘½åç©ºé—´
spring.cloud.nacos.config.namespace=02521b8e-52fa-430e-abe7-b73a7d68574e
# æ ¹æ®ä»¥ä¸Šé…ç½®ï¼Œä¼šè¯»å–åˆ°nacosçš„DataIdï¼šmember-dev.properties

# nacos serverï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰çš„åœ°å€
spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848
```

åœ¨nacosä¸­åšå¯¹åº”çš„é…ç½®ï¼ŒDataIdå½¢å¦‚`member-dev.properties`ï¼Œå…¶å†…å®¹çš„æ ¼å¼å’Œ`application.properties`ä¸€æ ·ï¼Œåœ¨javaä»£ç ä¸­å°±å¯ä»¥å»è¯»å–ã€‚

- **æœåŠ¡æ³¨å†Œï¼š**é…ç½®å¥½æ³¨å†Œä¸­å¿ƒåœ°å€åï¼Œé¡¹ç›®å°±ä¼šæ ¹æ®åº”ç”¨åç§°ï¼Œè‡ªåŠ¨æ³¨å†Œåˆ°nacosï¼Œå¯ä»¥åœ¨æ§å°çš„â€œæœåŠ¡åˆ—è¡¨â€æŸ¥çœ‹
- **åŠ¨æ€è¯»å–é…ç½®**ï¼šéœ€è¦åœ¨ç±»ä¸ŠåŠ ä¸Š`@RefreshScope`æ³¨è§£ï¼Œå¯ä»¥å®æ—¶åœ¨nacosä¸­ä¿®æ”¹é…ç½®ï¼Œjavaä»£ç å°±å¯ä»¥è¯»å–åˆ°ï¼Œä¸éœ€è¦é‡å¯é¡¹ç›®



### å¤šç¯å¢ƒé…ç½®

è¿˜æ˜¯ä»¥ä¸Šé¢çš„memberæ¨¡å—ä¸ºä¾‹ï¼Œç°åœ¨éœ€è¦é…ç½®ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒã€‚

é¦–å…ˆåœ¨nacosæ–°å»ºé…ç½®ï¼ŒDataIdä¸º`member-envName.properties`

ç„¶ååœ¨Springbooté¡¹ç›®çš„å¯åŠ¨é…ç½®ä¸­ï¼Œæ·»åŠ JVMå‚æ•°ï¼š`-Dspring.profiles.active=envName`ï¼Œå³å¯ä½¿å¾—è¯¥å¯åŠ¨å®ä¾‹å¯¹åº”ä¸Šç›¸åº”çš„é…ç½®æ–‡ä»¶

ä¸Šé¢çš„`envName`æ˜¯ç¯å¢ƒåç§°ï¼Œä¸€èˆ¬å¯ä»¥æ˜¯`dev`, `prod`ç­‰



### è·¯ç”±è½¬å‘

gatewayç½‘å…³çš„`application.properties`é…ç½®å¦‚ä¸‹ï¼š

å…¶ä¸­`lb`æ˜¯`LoadBalance`è´Ÿè½½å‡è¡¡ï¼Œåé¢è·Ÿä¸Šåº”ç”¨åç§°ï¼›æ³¨é‡Šæ‰çš„å†…å®¹æ˜¯ä½¿ç”¨nacosä¹‹å‰éœ€è¦é…ç½®çš„

```properties
# é…ç½®è·¯ç”±è½¬å‘ï¼Œå°†å½¢å¦‚Pathçš„è¯·æ±‚è½¬å‘åˆ°å¯¹åº”æ¨¡å—
spring.cloud.gateway.routes[0].id=member
#spring.cloud.gateway.routes[0].uri=http://localhost:8001
spring.cloud.gateway.routes[0].uri=lb://member
spring.cloud.gateway.routes[0].predicates[0]=Path=/member/**

spring.cloud.gateway.routes[1].id=business
#spring.cloud.gateway.routes[1].uri=http://localhost:8002
spring.cloud.gateway.routes[1].uri=lb://business
spring.cloud.gateway.routes[1].predicates[0]=Path=/business/**

spring.cloud.gateway.routes[2].id=batch
#spring.cloud.gateway.routes[2].uri=http://localhost:8003
spring.cloud.gateway.routes[2].uri=lb://batch
spring.cloud.gateway.routes[2].predicates[0]=Path=/batch/**
```

gatewayæ¨¡å—ä¹Ÿéœ€è¦é…ç½®nacosï¼ŒåŒæ ·æ–°å¢`bootstrap.properties`æ–‡ä»¶ï¼Œå†…å®¹å’Œä¸Šé¢ç±»ä¼¼ï¼Œä¿®æ”¹åº”ç”¨åç§°ï¼Œç„¶åä¸éœ€è¦é…ç½®ä¸­å¿ƒçš„é…ç½®ï¼Œåªéœ€è¦æ³¨å†Œä¸­å¿ƒçš„é…ç½®

è¿˜éœ€è¦å¼•å…¥**nacosæ³¨å†Œä¸­å¿ƒ**ä¾èµ–å’Œ**è´Ÿè½½å‡è¡¡**ä¾èµ–ï¼š

```xml
<!-- Nacos æœåŠ¡å‘ç°ï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰ -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!-- loadBalanceè´Ÿè½½å‡è¡¡å™¨ -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-loadbalancer</artifactId>
</dependency>
```



### NacosæŒ‚äº†ä¼šæ€ä¹ˆæ ·

å¦‚æœnacosä¸€å¼€å§‹çš„å¯åŠ¨çš„ï¼Œåé¢æŒ‚äº†ï¼Œå…¶å®å¹¶ä¸ä¼šå½±å“è·¯ç”±è½¬å‘ï¼Œå› ä¸ºå„ä¸ªåº”ç”¨å·²ç»ä»nacosè·å–åˆ°å¯¹åº”çš„ipä¿¡æ¯ç­‰ä¿¡æ¯ï¼Œå¯ä»¥æ­£å¸¸å·¥ä½œï¼Œåªä¸è¿‡å¦‚æœæœ‰å˜åŒ–å°±åŒæ­¥ä¸åˆ°äº†ã€‚å…·ä½“å¦‚ä¸‹ï¼š

- **æœ¬åœ°ç¼“å­˜çš„ä½œç”¨**
  - Nacos å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶ä¼šå°†ä» Nacos Server æ‹‰å–åˆ°çš„æœåŠ¡å®ä¾‹å’Œé…ç½®ä¿¡æ¯ç¼“å­˜åˆ°æœ¬åœ°å†…å­˜ä¸­ã€‚è¿™äº›ç¼“å­˜æ•°æ®å¯ä»¥è®©åº”ç”¨åœ¨çŸ­æ—¶é—´å†…ç»§ç»­ä½¿ç”¨ä¸Šä¸€æ¬¡æ³¨å†Œæ—¶è·å–åˆ°çš„ä¿¡æ¯ï¼Œå³ä½¿ Nacos Server ä¸å¯ç”¨ï¼Œå®¢æˆ·ç«¯ä»ç„¶å¯ä»¥ä»æœ¬åœ°ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ‰€éœ€æ•°æ®ã€‚

- **è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶**
  - ä¸ºäº†é˜²æ­¢å› ç½‘ç»œæŠ–åŠ¨æˆ–çŸ­æš‚æ•…éšœå¯¼è‡´å¤§é‡æœåŠ¡å®ä¾‹è¢«é”™è¯¯å‰”é™¤ï¼ŒNacos è®¾è®¡äº†è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‚åœ¨è¿™ç§æœºåˆ¶ä¸‹ï¼Œå³ä½¿å¿ƒè·³å¼‚å¸¸æˆ–çŸ­æœŸå†…æ— æ³•è”ç³»åˆ° Nacos Serverï¼Œæ³¨å†Œä¸­å¿ƒä¹Ÿä¸ä¼šç«‹å³å‰”é™¤æœåŠ¡å®ä¾‹ï¼Œä»è€Œä¿è¯äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚



## Seata

### ç¦»è°±BUG

é¦–å…ˆåŸºæœ¬é…ç½®æ˜¯ï¼šå­˜å‚¨æ¨¡å¼ä¸º`db`ï¼Œç„¶ååˆ›å»º`seata`æ•°æ®åº“ï¼Œé‡Œé¢åˆ›å»º4å¼ å®˜æ–¹æä¾›çš„è¡¨å¹¶åˆå§‹åŒ–ï¼›

å‡è®¾å°±è¿™æ ·ç›´æ¥å¯åŠ¨ï¼Œé‚£ä¹ˆåœ¨**seataçš„æœåŠ¡ç«¯**ä¼šå‡ºç°å¯åŠ¨æ—¥å¿—ï¼š

```cmd
19:49:13.799 ERROR --- [main] [lock.DataBaseDistributedLocker] [<init>] [] : The distribute lock table is not config, please create the target table and config it
```

ä¹Ÿå°±æ˜¯æ‰¾ä¸åˆ°`distribute_lock`è¿™ä¸ªæ•°æ®åº“ï¼Œä¼¼ä¹æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹åªè¯†åˆ«å¦å¤–3ä¸ªæ•°æ®åº“ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®ã€‚ä¸‹é¢çš„nacosé‡Œçš„`seataServer.properties`é‡Œçš„ç›¸å…³é…ç½®ã€‚

```properties
store.db.globalTable=global_table
store.db.branchTable=branch_table
store.db.distributedLockTable=distributed_lock
store.db.lockTable=lock_table
```

è¿™æ ·å°±è§£å†³äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œç¬¬äºŒä¸ªé—®é¢˜å°±æ›´ä¸¥é‡äº†ã€‚

åœ¨æ‰§è¡Œ`@GlobalTransactional`æ–¹æ³•é‡Œçš„æŒä¹…å±‚æ–¹æ³•æ—¶ï¼Œä¼šæŠ¥é”™ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

é¡¹ç›®ä¸­å¦‚ä¸‹ï¼Œé¦–å…ˆæ˜¯ç©ºæŒ‡é’ˆå¼‚å¸¸`java.lang.ArrayIndexOutOfBoundsException`ï¼Œè¿™é‡Œåº”è¯¥æ˜¯è¯·æ±‚seataæœåŠ¡ç«¯æ—¶æœåŠ¡ç«¯æŠ¥é”™äº†ï¼Œè¯·æ±‚å¤±è´¥å¯¼è‡´è®¿é—®ä¸€ä¸ªç©ºæ•°æ®ï¼ˆçŒœçš„ï¼‰

```cmd
2025-04-05 22:52:25.272 ERROR io.seata.core.rpc.netty.AbstractNettyRemoting     :309  NettyClientSelector_RMROLE_1_1                    0104
java.lang.ArrayIndexOutOfBoundsException: Index 0 out of bounds for length 0
	at io.seata.core.rpc.processor.client.ClientOnResponseProcessor.process(ClientOnResponseProcessor.java:103)
	at 
	...
```

ç„¶åæœ‰ï¼š

```cmd
Caused by: io.seata.core.exception.RmTransactionException: branch register timeout, xid:10.252.112.107:8091:7125331517838327809
	at
	...
Caused by: java.util.concurrent.TimeoutException: null ,cost: 15000 ms
	at
	...
```

è¿™æ®µåº”è¯¥å°±æ˜¯**è¿æ¥è¶…æ—¶**å¯¼è‡´çš„å„ç§å¼‚å¸¸ã€‚

è€Œåœ¨é¡¹ç›®è¿™è¾¹è¿æ¥è¶…æ—¶çš„åŒæ—¶ï¼ŒseataæœåŠ¡ç«¯çš„æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š

```cmd
20:27:35.348 ERROR --- [rverHandlerThread_1_7_500] [pc.netty.AbstractNettyRemoting] [bda$processMessage$2]  [10.252.112.107:8091:7845907508262154241] : 0104
==>
java.lang.NoClassDefFoundError: Could not initialize class io.seata.server.cluster.raft.RaftServerFactory$SingletonHandler
        at 
        ...
```

æ³¨æ„è¿™é‡Œçš„`raft`ï¼Œæ˜æ˜é…ç½®çš„æ˜¯`db`æ¨¡å¼ï¼Œå´å‡ºç°äº†`raft`ï¼Œå¼ºåˆ¶ç¦ç”¨ä¹Ÿæ²¡ç”¨ï¼Œä¸€å®šä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ã€‚

**çŒœæµ‹**æ˜¯seataæœåŠ¡ç«¯åœ¨å¹¶è¡Œå¤„ç†æ—¶ï¼Œä¼šå°è¯•åˆå§‹åŒ–Raftï¼Œä½¿ç”¨å…¶æ¥ä¿è¯åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼Œç„¶è€Œæˆ‘ä»¬æ²¡æœ‰ç›¸å…³é…ç½®ï¼Œå¯¼è‡´å‡ºé”™ã€‚

ä¸Šè¿°ä¸€åˆ‡é—®é¢˜çš„**è§£å†³æ–¹æ³•**æ˜¯ï¼š

â€‹	åœ¨nacosé‡Œçš„`seataServer.properties`é‡Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š

```properties
server.enableParallelRequestHandle=false
```

ä¹Ÿå°±æ˜¯ä»åŸæœ¬çš„ï¼š

```
å®¢æˆ·ç«¯è¯·æ±‚ â”€â”€â†’ SeataæœåŠ¡å™¨
                  â”‚
                  â”œâ”€â†’ è¯·æ±‚1 (å¹¶è¡Œå¤„ç†çº¿ç¨‹1)
                  â”œâ”€â†’ è¯·æ±‚2 (å¹¶è¡Œå¤„ç†çº¿ç¨‹2)
                  â””â”€â†’ è¯·æ±‚3 (å¹¶è¡Œå¤„ç†çº¿ç¨‹3)
```

å˜æˆäº†ï¼š

```
å®¢æˆ·ç«¯è¯·æ±‚ â”€â”€â†’ SeataæœåŠ¡å™¨
                  â”‚
                  â””â”€â†’ è¯·æ±‚1 â†’ è¯·æ±‚2 â†’ è¯·æ±‚3 (å•çº¿ç¨‹ä¸²è¡Œå¤„ç†)
```

è¿™æ ·å°±ä¸ä¼šå°è¯•å»åˆå§‹åŒ–Raftäº†ï¼Œå°±è§£å†³äº†ã€‚

è¿™æ¡é…ç½®å…·ä½“çš„ä½œç”¨æ˜¯**ç¦ç”¨å¹¶è¡Œè¯·æ±‚å¤„ç†**ï¼Œä»è€Œé¿å…äº†åœ¨ä¸éœ€è¦ Raft çš„åœºæ™¯ä¸‹è§¦å‘å…¶åˆå§‹åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ çš„åº”ç”¨åœºæ™¯ä¸­å¹¶ä¸éœ€è¦ Raft æ¥åšä¸€è‡´æ€§ä¿è¯æ—¶ï¼Œå…³é—­å¹¶è¡Œè¯·æ±‚å¤„ç†å¯ä»¥æœ‰æ•ˆè§„é¿ç”±äºæœªé…ç½® Raft è€Œå¯¼è‡´çš„å¼‚å¸¸é—®é¢˜ã€‚

**å¦‚æœéœ€è¦raftï¼Œå¯èƒ½éœ€è¦åšä»€ä¹ˆé…ç½®ï¼Œæˆ‘ä¹Ÿä¸æ‡‚...å®åœ¨ä¸è¡Œå°±æ›´æ¢ç‰ˆæœ¬**



### åŸºæœ¬ä»‹ç»

Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ã€‚ï¼ˆé»˜è®¤ä¸º**AT**ï¼‰



**SQLé™åˆ¶ï¼š**Seata äº‹åŠ¡ç›®å‰æ”¯æŒ INSERTã€UPDATEã€DELETE ä¸‰ç±» DML è¯­æ³•çš„éƒ¨åˆ†åŠŸèƒ½ï¼ˆä¸‹é¢å¤åˆ¶è‡ªå®˜ç½‘ï¼‰

https://seata.apache.org/zh-cn/docs/user/sqlreference/sql-restrictions

- ä¸æ”¯æŒ SQL åµŒå¥—
- ä¸æ”¯æŒå¤šè¡¨å¤æ‚ SQL(è‡ª1.6.0ç‰ˆæœ¬ï¼ŒMySQLæ”¯æŒUPDATE JOINè¯­å¥ï¼Œ[è¯¦æƒ…è¯·çœ‹](https://seata.apache.org/zh-cn/docs/user/sqlreference/dml) )
- ä¸æ”¯æŒå­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨
- éƒ¨åˆ†æ•°æ®åº“ä¸æ”¯æŒæ‰¹é‡æ›´æ–°



**ä¸‰å¤§æœ¯è¯­ï¼š**

- **TC** (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€… 
  - ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚
- **TM** (Transaction Manager) - äº‹åŠ¡ç®¡ç†å™¨
  - å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼š**å¼€å§‹**å…¨å±€äº‹åŠ¡ã€**æäº¤æˆ–å›æ»š**å…¨å±€äº‹åŠ¡ã€‚
- **RM** (Resource Manager) - èµ„æºç®¡ç†å™¨
  - å¯ä»¥ç†è§£ä¸º**æŸä¸€ä¸ªå¾®æœåŠ¡/åˆ†æ”¯äº‹åŠ¡**
  - ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

![](image/seata.png)

### 4ç§äº‹åŠ¡æ¨¡å¼

**AT æ¨¡å¼ï¼ˆAutomatic Transactionï¼‰**ï¼ˆCAPä¸­çš„APï¼‰

ä»…éœ€å¢åŠ undo_logè¡¨ï¼Œå…¶ä½™çš„ç”±seataè‡ªåŠ¨å®Œæˆ

- **åŸºæœ¬åŸç†ï¼š**
   AT æ¨¡å¼åŸºäºæ•°æ®åº“çš„**äºŒé˜¶æ®µæäº¤**å’Œ**undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰**å®ç°ã€‚ç³»ç»Ÿåœ¨æ‰§è¡Œæœ¬åœ°äº‹åŠ¡æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ undo logï¼Œåœ¨äº‹åŠ¡æäº¤å‰å¤‡ä»½æ•°æ®å˜æ›´ï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶å¯è‡ªåŠ¨å›æ»šåˆ°åˆå§‹çŠ¶æ€ã€‚
- **æ‰§è¡Œæµç¨‹ï¼š**ï¼ˆåº•å±‚çœ‹[ATæ¨¡å¼çš„æ‰§è¡Œæµç¨‹](#ATæ¨¡å¼çš„æ‰§è¡Œæµç¨‹)ï¼‰
   1. TM å¼€å¯å…¨å±€äº‹åŠ¡ï¼Œç„¶åè°ƒç”¨ RMï¼ŒRM å‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œç„¶åæ‰§è¡ŒSQLæ“ä½œ
   2. RM è®°å½•æ‰§è¡Œå‰åçš„æ•°æ®ï¼ˆä¿å­˜åœ¨`undo_log`è¡¨ä¸­ï¼‰ï¼Œæ‰§è¡Œå®ŒæŠ¥å‘Šäº‹åŠ¡çŠ¶æ€ï¼Œç„¶å**ç›´æ¥æäº¤/å›æ»š**
   3. TM å‡†å¤‡æäº¤/å›æ»šäº‹åŠ¡ï¼ŒTC æ£€æŸ¥åˆ†å¸ƒå¼äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¦‚æœéœ€è¦å›æ»šï¼Œåˆ™æ ¹æ®`undo_log`ç”Ÿæˆå›æ»šçš„SQL

- **å®ç°æœºåˆ¶ï¼š**
  - åˆ©ç”¨**ä»£ç†æŠ€æœ¯**æ‹¦æˆª SQL æ‰§è¡Œï¼Œåœ¨ SQL æ‰§è¡Œå‰ååˆ†åˆ«è®°å½•æ•°æ®å˜åŒ–ä¿¡æ¯ã€‚
  - å…¨å±€äº‹åŠ¡å¯åŠ¨æ—¶ç”Ÿæˆå…¨å±€äº‹åŠ¡IDï¼Œå„ä¸ªå‚ä¸æœåŠ¡åœ¨æ‰§è¡Œæœ¬åœ°äº‹åŠ¡æ—¶æ³¨å†Œä¸ºåˆ†æ”¯äº‹åŠ¡ã€‚
- **é€‚ç”¨åœºæ™¯ï¼š**
  - æ•°æ®åº“æ”¯æŒè‰¯å¥½ï¼ˆå¦‚ MySQLã€Oracle ç­‰ï¼‰ã€‚
  - å¼€å‘è€…å¸Œæœ›å°½é‡å°‘åœ°ä¾µå…¥ä¸šåŠ¡ä»£ç ï¼Œè‡ªåŠ¨ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡ã€‚
- **ä¼˜ç¼ºç‚¹ï¼š**
  - **ä¼˜ç‚¹ï¼š** å¼€å‘é—¨æ§›ä½ï¼Œæ— éœ€ä¿®æ”¹å¤ªå¤šä¸šåŠ¡é€»è¾‘ã€‚
  - **ç¼ºç‚¹ï¼š** å¯¹äºå¤æ‚ SQL æˆ–æŸäº›ç‰¹æ®Šæ•°æ®åº“æ“ä½œå¯èƒ½ä¸å¤ªé€‚ç”¨ï¼Œundo log å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šå½±å“ã€‚



**XA æ¨¡å¼**ï¼ˆCAPä¸­çš„CPï¼‰

å’ŒATç±»ä¼¼ï¼Œç”±seataè‡ªåŠ¨å®Œæˆ

- **åŸºæœ¬åŸç†ï¼š**
   XA æ¨¡å¼éµå¾ªåˆ†å¸ƒå¼äº‹åŠ¡æ ‡å‡†ï¼ˆXA åè®®ï¼‰ï¼Œç”±äº‹åŠ¡ç®¡ç†å™¨åè°ƒå„ä¸ªèµ„æºç®¡ç†å™¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰æ‰§è¡ŒäºŒé˜¶æ®µæäº¤ï¼Œä»è€Œå®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚
- **æ‰§è¡Œæµç¨‹**ï¼š
   1. TM å¼€å¯å…¨å±€äº‹åŠ¡ï¼Œç„¶åè°ƒç”¨ RMï¼ŒRM å‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œç„¶åæ‰§è¡ŒSQLæ“ä½œ
   3. RM æ‰§è¡Œå®ŒæŠ¥å‘Šäº‹åŠ¡çŠ¶æ€**ï¼ˆä¸æäº¤/å›æ»šï¼‰**
   4. TM å‡†å¤‡æäº¤/å›æ»šäº‹åŠ¡ï¼ŒTC æ£€æŸ¥åˆ†å¸ƒå¼äº‹åŠ¡çš„çŠ¶æ€ï¼Œé€šçŸ¥RMå»æäº¤/å›æ»š
- **å®ç°æœºåˆ¶ï¼š**
  - å…¨å±€äº‹åŠ¡ç”±åè°ƒå™¨ç®¡ç†ï¼Œå„ä¸ªå‚ä¸æ•°æ®åº“åœ¨æ¥æ”¶åˆ°å…¨å±€äº‹åŠ¡æŒ‡ä»¤åæ‰§è¡Œå‡†å¤‡ï¼ˆPrepareï¼‰å’Œæäº¤ï¼ˆCommitï¼‰æˆ–å›æ»šï¼ˆRollbackï¼‰æ“ä½œã€‚
  - **äº‹åŠ¡ä¹‹é—´éœ€è¦ç›¸äº’ç­‰å¾…**
  - ä¾èµ–æ•°æ®åº“æœ¬èº«å¯¹ XA åè®®çš„æ”¯æŒã€‚
- **é€‚ç”¨åœºæ™¯ï¼š**
  - ç¯å¢ƒä¸­å„å‚ä¸ç³»ç»Ÿéƒ½æ”¯æŒ XA åè®®ï¼Œä¸”äº‹åŠ¡æ“ä½œè¾ƒå°‘ã€é¢‘ç‡ä¸é«˜ã€‚
  - å¯¹äº‹åŠ¡ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ã€‚
- **ä¼˜ç¼ºç‚¹ï¼š**
  - **ä¼˜ç‚¹ï¼š** æ ‡å‡†åè®®ï¼Œé€‚ç”¨èŒƒå›´å¹¿ï¼Œèƒ½ç¡®ä¿ä¸¥æ ¼çš„ä¸€è‡´æ€§ã€‚
  - **ç¼ºç‚¹ï¼š** æ€§èƒ½å¼€é”€è¾ƒå¤§ï¼Œå¯¹æ•°æ®åº“èµ„æºé”å®šæ—¶é—´è¾ƒé•¿ï¼Œæ‰©å±•æ€§è¾ƒå·®ï¼Œä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚



**TCC æ¨¡å¼ï¼ˆTry-Confirm-Cancelï¼‰**ï¼ˆCAPä¸­çš„APï¼‰

éœ€è¦æ‰‹åŠ¨å®ç°3ä¸ªé˜¶æ®µçš„ä»£ç 

- **åŸºæœ¬åŸç†ï¼š**
   TCC æ¨¡å¼å°†ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡åˆ’åˆ†ä¸ºä¸‰ä¸ªæ˜ç¡®çš„é˜¶æ®µï¼šTryï¼ˆå°è¯•ï¼‰ã€Confirmï¼ˆç¡®è®¤ï¼‰å’Œ Cancelï¼ˆå–æ¶ˆï¼‰ã€‚æ¯ä¸ªä¸šåŠ¡æ–¹æ³•éƒ½éœ€è¦å¼€å‘è€…è‡ªè¡Œå®ç°è¿™ä¸‰ä¸ªé˜¶æ®µçš„é€»è¾‘ï¼Œç¡®ä¿èµ„æºåœ¨æ•´ä¸ªäº‹åŠ¡è¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§ã€‚
- **æ‰§è¡Œæµç¨‹**ï¼š
   1. åŸºæœ¬å’ŒATç›¸åŒï¼Œä½†æ˜¯RMé¦–å…ˆåšèµ„æºé¢„ç•™ï¼Œä¸æ›´æ–°æ•°æ®åº“
   2. æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡é¢„ç•™æˆåŠŸååˆ™æäº¤ï¼Œå¤±è´¥åˆ™æ’¤é”€é¢„ç•™æ“ä½œ

- **å®ç°æœºåˆ¶ï¼š**
  - **Try é˜¶æ®µï¼š** é¢„ç•™èµ„æºæˆ–æ‰§è¡Œä¸šåŠ¡é¢„å¤„ç†ï¼Œä½†ä¸åšæœ€ç»ˆç¡®è®¤ã€‚
  - **Confirm é˜¶æ®µï¼š** å½“æ‰€æœ‰å­äº‹åŠ¡çš„ Try é˜¶æ®µæ‰§è¡ŒæˆåŠŸåï¼Œæ‰§è¡Œå®é™…æäº¤æ“ä½œã€‚
  - **Cancel é˜¶æ®µï¼š** æŸä¸ªå­äº‹åŠ¡å¤±è´¥æ—¶ï¼Œæ‰§è¡Œè¡¥å¿æ“ä½œï¼Œæ’¤é”€å…ˆå‰çš„ Try é˜¶æ®µæ“ä½œã€‚
- **é€‚ç”¨åœºæ™¯ï¼š**
  - ä¸šåŠ¡æ“ä½œæ¯”è¾ƒå¤æ‚ï¼Œä¸”æ¯ä¸ªæ“ä½œéƒ½å¯ä»¥å®šä¹‰æ˜ç¡®çš„è¡¥å¿é€»è¾‘ã€‚
  - å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶äº‹åŠ¡çŠ¶æ€ã€‚
- **ä¼˜ç¼ºç‚¹ï¼š**
  - **ä¼˜ç‚¹ï¼š** çµæ´»æ€§é«˜ï¼Œå¯ä»¥é€‚åº”å¤šç§ä¸šåŠ¡åœºæ™¯ï¼Œå°¤å…¶æ˜¯è·¨ç³»ç»Ÿè°ƒç”¨ã€‚
  - **ç¼ºç‚¹ï¼š** å¼€å‘å·¥ä½œé‡è¾ƒå¤§ï¼Œå¿…é¡»ç¼–å†™å¯¹åº”çš„ç¡®è®¤å’Œå–æ¶ˆé€»è¾‘ï¼›è®¾è®¡ä¸å½“å®¹æ˜“å¼•å…¥è¡¥å¿å¤±è´¥é—®é¢˜ã€‚



**Saga æ¨¡å¼**

- **åŸºæœ¬åŸç†ï¼š**
   Saga æ¨¡å¼é‡‡ç”¨**é•¿äº‹åŠ¡**çš„æ€æƒ³ï¼Œå°†ä¸€ä¸ªå…¨å±€äº‹åŠ¡æ‹†åˆ†ä¸ºä¸€ç³»åˆ—æœ‰åºçš„æœ¬åœ°äº‹åŠ¡ï¼Œæ¯ä¸ªæœ¬åœ°äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿äº‹åŠ¡ã€‚å½“æŸä¸ªæ­¥éª¤å¤±è´¥æ—¶ï¼Œé€šè¿‡æ‰§è¡Œåç»­çš„è¡¥å¿äº‹åŠ¡æ¥è¾¾åˆ°æ•°æ®çš„ä¸€è‡´æ€§ã€‚
- **å®ç°æœºåˆ¶ï¼š**
  - æ¯ä¸ªæœ¬åœ°äº‹åŠ¡ç‹¬ç«‹æäº¤ï¼Œä¸”é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æˆ–çŠ¶æ€æœºåè°ƒå„ä¸ªäº‹åŠ¡é—´çš„æ‰§è¡Œé¡ºåºã€‚
  - å½“å±€éƒ¨äº‹åŠ¡æˆåŠŸåï¼Œè®°å½•äº‹åŠ¡çŠ¶æ€ï¼›è‹¥åç»­äº‹åŠ¡å¤±è´¥ï¼Œåˆ™è§¦å‘è¡¥å¿æ“ä½œã€‚
- **é€‚ç”¨åœºæ™¯ï¼š**
  - ä¸šåŠ¡æµç¨‹è¾ƒé•¿ï¼Œå„ä¸ªäº‹åŠ¡ä¹‹é—´æ¾è€¦åˆï¼Œé€‚åˆå¼‚æ­¥æ‰§è¡Œã€‚
  - ä¸éœ€è¦ä¸¥æ ¼çš„å…¨å±€é”ï¼Œå…è®¸éƒ¨åˆ†ä¸ä¸€è‡´ï¼Œæœ€ç»ˆé€šè¿‡è¡¥å¿è¾¾åˆ°ä¸€è‡´æ€§ã€‚
- **ä¼˜ç¼ºç‚¹ï¼š**
  - **ä¼˜ç‚¹ï¼š** èƒ½å¤„ç†é•¿äº‹åŠ¡åœºæ™¯ï¼Œé€‚åˆå¾®æœåŠ¡æ¶æ„ä¸­è·¨æœåŠ¡çš„ä¸šåŠ¡æµç¨‹ã€‚
  - **ç¼ºç‚¹ï¼š** è¡¥å¿é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œå¯¹ä¸šåŠ¡å»ºæ¨¡è¦æ±‚é«˜ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®çŸ­æš‚ä¸ä¸€è‡´çš„é£é™©ã€‚


### ATæ¨¡å¼çš„æ‰§è¡Œæµç¨‹

é¡¹ç›®ä¸­ä½¿ç”¨ATæ¨¡å¼ï¼Œè¿™é‡ŒæŒ‰ç…§å®˜ç½‘çš„ä¾‹å­ç»™å‡ºå…¶**æ‰§è¡Œæµç¨‹**ï¼š

- æœ‰ä¸€ä¸ªä¸šåŠ¡è¡¨ï¼š`product`

| Field | Type         | Key  |
| ----- | ------------ | ---- |
| id    | bigint(20)   | PRI  |
| name  | varchar(100) |      |
| since | varchar(100) |      |

- æ‰§è¡Œå¦‚ä¸‹è¯­å¥

  - ```sql
    update product set name = 'GTS' where name = 'TXC';
    ```

- **ä¸€é˜¶æ®µï¼š**

  1. **è§£æ SQL**ï¼šå¾—åˆ° SQL çš„ç±»å‹ï¼ˆUPDATEï¼‰ï¼Œè¡¨ï¼ˆproductï¼‰ï¼Œæ¡ä»¶ï¼ˆwhere name = 'TXC'ï¼‰ç­‰ç›¸å…³çš„ä¿¡æ¯ã€‚

  2. **æŸ¥è¯¢å‰é•œåƒ**ï¼šæ ¹æ®è§£æå¾—åˆ°çš„æ¡ä»¶ä¿¡æ¯ï¼Œç”Ÿæˆ**æŸ¥è¯¢è¯­å¥**ï¼Œå®šä½æ•°æ®ã€‚ï¼ˆå‡è®¾æŸ¥è¯¢åˆ°çš„idï¼‰

     - ```sql
       select id, name, since from product where name = 'TXC';
       ```

  3. **æ‰§è¡Œä¸šåŠ¡ SQL**ï¼šæ›´æ–°è¿™æ¡è®°å½•çš„ name ä¸º 'GTS'ã€‚

  4. **æŸ¥è¯¢åé•œåƒ**ï¼šæ ¹æ®å‰é•œåƒçš„ç»“æœï¼Œé€šè¿‡ **ä¸»é”®** å®šä½æ•°æ®ã€‚

     - ```sql
       select id, name, since from product where id = 1;
       ```

  5. **æ’å…¥å›æ»šæ—¥å¿—**ï¼šæŠŠå‰åé•œåƒæ•°æ®ä»¥åŠä¸šåŠ¡ SQL ç›¸å…³çš„ä¿¡æ¯ç»„æˆä¸€æ¡å›æ»šæ—¥å¿—è®°å½•ï¼Œæ’å…¥åˆ° `UNDO_LOG` è¡¨ä¸­ã€‚

     - ```json
       {
           "branchId": 641789253,
           "undoItems": [{
               "afterImage": {
                   "rows": [{
                       "fields": [{
                           "name": "id",
                           "type": 4,
                           "value": 1
                       }, {
                           "name": "name",
                           "type": 12,
                           "value": "GTS"
                       }, {
                           "name": "since",
                           "type": 12,
                           "value": "2014"
                       }]
                   }],
                   "tableName": "product"
               },
               "beforeImage": {
                   "rows": [{
                       "fields": [{
                           "name": "id",
                           "type": 4,
                           "value": 1
                       }, {
                           "name": "name",
                           "type": 12,
                           "value": "TXC"
                       }, {
                           "name": "since",
                           "type": 12,
                           "value": "2014"
                       }]
                   }],
                   "tableName": "product"
               },
               "sqlType": "UPDATE"
           }],
           "xid": "xid:xxx"
       }
       ```

  6. **æäº¤å‰ï¼Œå‘ TC æ³¨å†Œåˆ†æ”¯**ï¼šç”³è¯· `product` è¡¨ä¸­ï¼Œä¸»é”®å€¼ç­‰äº 1 çš„è®°å½•çš„ **å…¨å±€é”** ã€‚

  7. **æœ¬åœ°äº‹åŠ¡æäº¤**ï¼šä¸šåŠ¡æ•°æ®çš„æ›´æ–°å’Œå‰é¢æ­¥éª¤ä¸­ç”Ÿæˆçš„ **UNDO LOG** ä¸€å¹¶æäº¤ã€‚

  8. å°†æœ¬åœ°äº‹åŠ¡æäº¤çš„ç»“æœ**ä¸ŠæŠ¥**ç»™ TCã€‚

- **äºŒé˜¶æ®µâ€”å›æ»šï¼š**

  1. æ”¶åˆ° TC çš„åˆ†æ”¯å›æ»šè¯·æ±‚ï¼Œ**å¼€å¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡**ï¼Œæ‰§è¡Œå¦‚ä¸‹æ“ä½œã€‚

  2. é€šè¿‡ `XID` å’Œ` Branch ID` æŸ¥æ‰¾åˆ°ç›¸åº”çš„ UNDO LOG è®°å½•ã€‚

  3. **æ•°æ®æ ¡éªŒ**ï¼šæ‹¿ **UNDO LOG** ä¸­çš„åé•œåƒä¸å½“å‰æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæœ‰ä¸åŒï¼Œè¯´æ˜æ•°æ®è¢«å½“å‰å…¨å±€äº‹åŠ¡ä¹‹å¤–çš„åŠ¨ä½œåšäº†ä¿®æ”¹ã€‚è¿™ç§æƒ…å†µï¼Œéœ€è¦æ ¹æ®é…ç½®ç­–ç•¥æ¥åšå¤„ç†ï¼Œè¯¦ç»†çš„è¯´æ˜åœ¨å¦å¤–çš„æ–‡æ¡£ä¸­ä»‹ç»ã€‚

  4. æ ¹æ® UNDO LOG ä¸­çš„å‰é•œåƒå’Œä¸šåŠ¡ SQL çš„ç›¸å…³ä¿¡æ¯ç”Ÿæˆå¹¶æ‰§è¡Œå›æ»šçš„è¯­å¥ï¼š

     - ```sql
       update product set name = 'TXC' where id = 1;
       ```

  5. æäº¤æœ¬åœ°äº‹åŠ¡ã€‚å¹¶æŠŠæœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œç»“æœï¼ˆå³åˆ†æ”¯äº‹åŠ¡å›æ»šçš„ç»“æœï¼‰ä¸ŠæŠ¥ç»™ TCã€‚

- **äºŒé˜¶æ®µâ€”æäº¤**ï¼š

  1. æ”¶åˆ° TC çš„åˆ†æ”¯æäº¤è¯·æ±‚ï¼ŒæŠŠè¯·æ±‚æ”¾å…¥ä¸€ä¸ª**å¼‚æ­¥ä»»åŠ¡çš„é˜Ÿåˆ—**ä¸­ï¼Œé©¬ä¸Šè¿”å›æäº¤æˆåŠŸçš„ç»“æœç»™ TCã€‚
  2. å¼‚æ­¥ä»»åŠ¡é˜¶æ®µçš„åˆ†æ”¯æäº¤è¯·æ±‚å°†å¼‚æ­¥å’Œæ‰¹é‡åœ°**åˆ é™¤ç›¸åº” UNDO LOG è®°å½•**ã€‚

  

### ä½¿ç”¨

å¯åŠ¨ï¼šåŒå‡»seataæ ¹ç›®å½•ä¸‹`/bin/seata-server.bat`å³å¯å¯åŠ¨

æœ¬é¡¹ç›®ä¸­ï¼Œåœ¨å¤„ç†è®¢å•çš„æ­¥éª¤æœ€åï¼Œéœ€è¦åœ¨**business**è¿œç¨‹è°ƒç”¨**member**æ¨¡å—ï¼Œæ“ä½œä¼šå‘˜è´­ç¥¨ä¿¡æ¯ticketè¡¨ï¼Œè¿™é‡Œå°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

é¡¹ç›®ä¸­ä½¿ç”¨Seataçš„**ATæ¨¡å¼**ï¼Œéœ€è¦åœ¨ç”¨åˆ°Seataçš„å¾®æœåŠ¡æ¨¡å—ä¸­åˆ›å»º`undo_log`è¡¨ï¼š

```sql
CREATE TABLE `undo_log`
(
    `id`            bigint(20)   NOT NULL AUTO_INCREMENT,
    `branch_id`     bigint(20)   NOT NULL,
    `xid`           varchar(100) NOT NULL,
    `context`       varchar(128) NOT NULL,
    `rollback_info` longblob     NOT NULL,
    `log_status`    int(11)      NOT NULL,
    `log_created`   datetime     NOT NULL,
    `log_modified`  datetime     NOT NULL,
    `ext`           varchar(100) DEFAULT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8;
```

å¼•å…¥seataä¾èµ–ï¼š

```xml
<!-- Seata åˆ†å¸ƒå¼äº‹åŠ¡ -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
</dependency>
```

åœ¨`bootstrap.properties`ä¸­æ–°å¢é…ç½®ï¼Œä¸¤ä¸ªæ¨¡å—éƒ½è¦

```properties
# seataäº‹åŠ¡ç»„åç§°
seata.tx-service-group=train-group
# äº‹åŠ¡ç»„å’Œseataé›†ç¾¤åšå…³è”ï¼Œdefaultæ˜¯é›†ç¾¤å
seata.service.vgroup-mapping.train-group=default
# seataé›†ç¾¤çš„åœ°å€
seata.service.grouplist.default=127.0.0.1:8091
```

åŒæ—¶éœ€è¦ä¿®æ”¹**å¼‚å¸¸æ‹¦æˆªå™¨**ï¼Œä¸æŠ›å‡ºçš„è¯ï¼Œæœ‰å¼‚å¸¸ä¹Ÿä¼šè¿”å›200ï¼Œä¹Ÿç®—æ˜¯è¿”å›æˆåŠŸ

```java
/**
 * æ‰€æœ‰å¼‚å¸¸ç»Ÿä¸€å¤„ç†
 * @param e
 * @return
 */
@ExceptionHandler(value = Exception.class)
@ResponseBody
public CommonResp exceptionHandler(Exception e) throws Exception{
    LOG.error("ç³»ç»Ÿå¼‚å¸¸ï¼š", e);
    
    // å¦‚æœæ˜¯åœ¨ä¸€æ¬¡å…¨å±€äº‹åŠ¡é‡Œå‡ºå¼‚å¸¸äº†ï¼Œå°±ä¸è¦åŒ…è£…è¿”å›å€¼ï¼Œå°†å¼‚å¸¸æŠ›ç»™è°ƒç”¨æ–¹ï¼Œè®©è°ƒç”¨æ–¹å›æ»šäº‹åŠ¡
    if (StrUtil.isNotBlank(RootContext.getXID())) {
        throw e;
    }
    
    return CommonResp.error("ç³»ç»Ÿå‡ºç°å¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
}
```

æ¥ç€åªéœ€è¦åœ¨éœ€è¦æ–¹æ³•ä¸ŠåŠ ä¸Š`@GlobalTransactional`æ³¨è§£å³å¯ç”Ÿæ•ˆã€‚

### é…ç½®

#### é…ç½®nacos

ä¿®æ”¹é…ç½®æ–‡ä»¶`/conf/application.yml`

```yaml
seata:
  config:
    # support: nacos, consul, apollo, zk, etcd3
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      group: SEATA_GROUP
      namespace: 02521b8e-52fa-430e-abe7-b73a7d68574e
      dataId: seataServer.properties
      # nacosæ²¡å¼€å¯é‰´æƒï¼Œä¸‹é¢çš„2ä¸ªå°±ä¸ç”¨åŠ 
      #username: nacos
      #password: nacos
  registry:
    # support: nacos, eureka, redis, zk, consul, etcd3, sofa
    type: nacos
    nacos:
      application: seata-server
      server-addr: 127.0.0.1:8848
      group: SEATA_GROUP
      namespace: 02521b8e-52fa-430e-abe7-b73a7d68574e
      # nacosæ²¡å¼€å¯é‰´æƒï¼Œä¸‹é¢çš„2ä¸ªå°±ä¸ç”¨åŠ 
      #username: nacos
      #password: nacos
```

nacosä¸­æ·»åŠ å¯¹åº”çš„é…ç½®`seataServer.properties`

nacosé…ç½®å®Œåï¼Œ`bootstrap.properties`å°±å¯ä»¥æ”¹ä¸ºå¦‚ä¸‹ï¼š

```properties
# seataäº‹åŠ¡ç»„åç§°
seata.tx-service-group=train-group
# äº‹åŠ¡ç»„å’Œseataé›†ç¾¤åšå…³è”ï¼Œdefaultæ˜¯é›†ç¾¤å
#seata.service.vgroupMapping.train-group=default  -> è¿™ä¸ªæ”¹ä¸ºé…ç½®åˆ°nacosé‡Œ
# seataé›†ç¾¤çš„åœ°å€
#seata.service.grouplist.default=127.0.0.1:8091  -> è¿™ä¸ªæ”¹ä¸ºé…ç½®åˆ°nacosé‡Œ

# seataé…ç½®nacosï¼Œè¦å’Œseataçš„application.ymlé‡Œçš„é…ç½®ä¸€æ ·
seata.registry.type=nacos
seata.registry.nacos.application=seata-server
seata.registry.nacos.server-addr=127.0.0.1:8848
seata.registry.nacos.group=SEATA_GROUP
seata.registry.nacos.namespace=02521b8e-52fa-430e-abe7-b73a7d68574e
# nacosæ²¡å¼€å¯é‰´æƒï¼Œä¸‹é¢çš„2ä¸ªå°±ä¸ç”¨åŠ 
#seata.registry.nacos.username=nacos
#seata.registry.nacos.password=nacos

seata.config.type=nacos
seata.config.nacos.server-addr=127.0.0.1:8848
seata.config.nacos.group=SEATA_GROUP
seata.config.nacos.namespace=02521b8e-52fa-430e-abe7-b73a7d68574e
seata.config.nacos.data-id=seataServer.properties
# nacosæ²¡å¼€å¯é‰´æƒï¼Œä¸‹é¢çš„2ä¸ªå°±ä¸ç”¨åŠ 
#seata.config.nacos.username=nacos
#seata.config.nacos.password=nacos
```



#### é…ç½®æ•°æ®åº“

ä¿®æ”¹é…ç½®æ–‡ä»¶`/conf/application.yml`æˆ–ä¿®æ”¹nacosé‡Œçš„é…ç½®

```properties
store.mode=db
store.db.datasource=druid
store.db.dbType=mysql
store.db.driverClassName=com.mysql.jdbc.Driver
store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&rewriteBatchedStatements=true
store.db.user=seata_user
store.db.password=123456
```

åœ¨é…ç½®çš„æ•°æ®åº“ä¸­ï¼Œæ‰§è¡Œseataæä¾›çš„è¯­å¥ï¼Œè·¯å¾„æ˜¯`/script/server/db/mysql.sql`




## Sentinel

Sentinel æ˜¯é¢å‘åˆ†å¸ƒå¼ã€å¤šè¯­è¨€å¼‚æ„åŒ–æœåŠ¡æ¶æ„çš„æµé‡æ²»ç†ç»„ä»¶ï¼Œä¸»è¦ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡è·¯ç”±ã€æµé‡æ§åˆ¶ã€æµé‡æ•´å½¢ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè‡ªé€‚åº”è¿‡è½½ä¿æŠ¤ã€çƒ­ç‚¹æµé‡é˜²æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥å¸®åŠ©å¼€å‘è€…ä¿éšœå¾®æœåŠ¡çš„ç¨³å®šæ€§

### åŸºæœ¬æ¦‚å¿µ

- **èµ„æº**

  - èµ„æºæ˜¯ Sentinel çš„å…³é”®æ¦‚å¿µã€‚å®ƒå¯ä»¥æ˜¯ Java åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›çš„æœåŠ¡ï¼Œæˆ–ç”±åº”ç”¨ç¨‹åºè°ƒç”¨çš„å…¶å®ƒåº”ç”¨æä¾›çš„æœåŠ¡ï¼Œç”šè‡³å¯ä»¥æ˜¯ä¸€æ®µä»£ç ã€‚åœ¨æ¥ä¸‹æ¥çš„æ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¼šç”¨èµ„æºæ¥æè¿°ä»£ç å—ã€‚

  - åªè¦é€šè¿‡ Sentinel API å®šä¹‰çš„ä»£ç ï¼Œå°±æ˜¯èµ„æºï¼Œèƒ½å¤Ÿè¢« Sentinel ä¿æŠ¤èµ·æ¥ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•ç­¾åï¼ŒURLï¼Œç”šè‡³æœåŠ¡åç§°ä½œä¸ºèµ„æºåæ¥æ ‡ç¤ºèµ„æºã€‚

- **è§„åˆ™**
  - å›´ç»•èµ„æºçš„å®æ—¶çŠ¶æ€è®¾å®šçš„è§„åˆ™ï¼Œå¯ä»¥åŒ…æ‹¬æµé‡æ§åˆ¶è§„åˆ™ã€ç†”æ–­é™çº§è§„åˆ™ä»¥åŠç³»ç»Ÿä¿æŠ¤è§„åˆ™ã€‚æ‰€æœ‰è§„åˆ™å¯ä»¥åŠ¨æ€å®æ—¶è°ƒæ•´ã€‚

### å¸¸è§é™æµç®—æ³•

1. **å›ºå®šçª—å£ç®—æ³•ï¼ˆFixed Windowï¼‰**

   - **åŸç†ï¼š**

     - å°†æ—¶é—´åˆ’åˆ†ä¸ºå›ºå®šé•¿åº¦çš„çª—å£ï¼ˆæ¯”å¦‚æ¯åˆ†é’Ÿã€æ¯ç§’ï¼‰ã€‚

     - åœ¨æ¯ä¸ªæ—¶é—´çª—å£å†…å…è®¸å›ºå®šæ•°é‡çš„è¯·æ±‚ã€‚å½“è¯·æ±‚æ•°é‡è¶…è¿‡è®¾å®šå€¼æ—¶ï¼Œåç»­è¯·æ±‚å°†è¢«æ‹’ç»æˆ–ç­‰å¾…åˆ°ä¸‹ä¸€ä¸ªçª—å£é‡æ–°è®¡æ•°ã€‚

   - **ä¼˜ç‚¹ï¼š**
     - å®ç°ç®€å•ï¼Œé€‚ç”¨äºæµé‡æ³¢åŠ¨ä¸å¤§çš„åœºæ™¯ã€‚

   - **ç¼ºç‚¹ï¼š**
     - çª—å£è¾¹ç•Œå¤„å¯èƒ½å‡ºç°æµé‡çªå¢çš„é—®é¢˜ï¼ˆâ€œçªåˆºâ€é—®é¢˜ï¼‰ï¼Œä¾‹å¦‚åœ¨ä¸¤ä¸ªç›¸é‚»çª—å£äº¤æ›¿ä¹‹é—´åŒæ—¶å…è®¸å¤§é‡è¯·æ±‚ã€‚

2. **æ»‘åŠ¨çª—å£ç®—æ³•ï¼ˆSliding Windowï¼‰**

   - **åŸç†ï¼š**

     - åœ¨å›ºå®šçª—å£åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›ï¼Œè®°å½•æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´æˆ³ï¼ŒåŠ¨æ€è®¡ç®—è¿‡å»ä¸€æ®µæ—¶é—´å†…çš„è¯·æ±‚æ•°ã€‚

     - æ ¹æ®æœ€è¿‘ä¸€æ®µæ—¶é—´ï¼ˆä¾‹å¦‚è¿‡å»60ç§’ï¼‰çš„è¯·æ±‚æ€»æ•°è¿›è¡Œé™æµåˆ¤æ–­ï¼Œä¿è¯é™æµæ›´å¹³æ»‘ã€‚

   - **ä¼˜ç‚¹ï¼š**
     - èƒ½å¤Ÿæ›´å¹³æ»‘åœ°æ§åˆ¶è¯·æ±‚æ•°é‡ï¼Œé¿å…å›ºå®šçª—å£åœ¨è¾¹ç•Œæ—¶å‡ºç°çš„çªåˆºé—®é¢˜ã€‚

   - **ç¼ºç‚¹ï¼š**
     - å®ç°ä¸Šæ¯”å›ºå®šçª—å£å¤æ‚ï¼Œå­˜å‚¨å’Œè®¡ç®—å¼€é”€è¾ƒå¤§ã€‚

3. **ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰**

   - **åŸç†ï¼š**

     - ç³»ç»ŸæŒ‰ç…§å›ºå®šé€Ÿç‡å¾€æ¡¶ä¸­åŠ å…¥ä»¤ç‰Œï¼ŒåŒæ—¶æ¡¶æœ‰å®¹é‡ä¸Šé™ã€‚

     - æ¯ä¸ªè¯·æ±‚éœ€è¦æ¶ˆè€—ä¸€ä¸ªä»¤ç‰Œã€‚å¦‚æœæ¡¶ä¸­æœ‰ä»¤ç‰Œï¼Œåˆ™å…è®¸è¯·æ±‚ï¼›å¦‚æœæ²¡æœ‰ä»¤ç‰Œï¼Œåˆ™æ‹’ç»è¯·æ±‚æˆ–ç­‰å¾…ä»¤ç‰Œè¡¥å……ã€‚

     - å¯ä»¥æ”¯æŒçªå‘æµé‡ï¼Œå› ä¸ºä»¤ç‰Œæ¡¶ä¸­å¯èƒ½å­˜æœ‰å¤šä¸ªä»¤ç‰Œï¼Œå…è®¸åœ¨çŸ­æ—¶é—´å†…å¤„ç†è¾ƒå¤šè¯·æ±‚ã€‚

   - **ä¼˜ç‚¹ï¼š**
     - å¯¹çªå‘æµé‡å‹å¥½ï¼Œå¹³æ»‘åœ°å¤„ç†æµé‡ã€‚

   - **ç¼ºç‚¹ï¼š**
     - éœ€è¦ç²¾ç¡®è®¡æ—¶ä»¥åŠåˆç†é…ç½®ä»¤ç‰Œç”Ÿæˆé€Ÿç‡å’Œæ¡¶çš„å®¹é‡ã€‚

4. **æ»´æ°´/æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰**
   - **åŸç†ï¼š**
   
     - è¯·æ±‚è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆæ¡¶ï¼‰ï¼Œä»¥å›ºå®šé€Ÿç‡ä»é˜Ÿåˆ—ä¸­â€œæ»´å‡ºâ€è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚
       - å½“è¯·æ±‚æ¶Œå…¥æ—¶ï¼Œé˜Ÿåˆ—ä¼šæš‚å­˜ä¸€å®šæ•°é‡çš„è¯·æ±‚ï¼Œè‹¥é˜Ÿåˆ—å·²æ»¡åˆ™åç»­è¯·æ±‚å°†è¢«ä¸¢å¼ƒã€‚
   
     - **ä¼˜ç‚¹ï¼š**
       - æµé‡å‡ºç«™é€Ÿç‡ç¨³å®šï¼Œå¯ä»¥å¹³æ»‘çªå‘æµé‡ï¼Œé˜²æ­¢æµé‡æš´å¢å¯¹ç³»ç»Ÿé€ æˆå†²å‡»ã€‚
   
   - **ç¼ºç‚¹ï¼š**
     - å¯¹çªå‘æµé‡çš„å¤„ç†èƒ½åŠ›ç›¸å¯¹ä»¤ç‰Œæ¡¶ç¨å¼±ï¼Œå› ä¸ºä¸€æ—¦é˜Ÿåˆ—æ»¡å°±ä¼šç›´æ¥ä¸¢å¼ƒè¯·æ±‚ã€‚
   
5. **æ»‘åŠ¨æ—¥å¿—ç®—æ³•**

   - æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´æˆ³éƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œæ¯æ¬¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œéƒ½éå†æ—¥å¿—ï¼Œå°†æ—¶é—´è¶…è¿‡çª—å£é•¿åº¦çš„è®°å½•å‰”é™¤ï¼Œç„¶åç»Ÿè®¡å‰©ä½™è¯·æ±‚æ•°ã€‚è¿™æ ·åšéå¸¸ç²¾ç¡®ï¼Œä½†å½“è¯·æ±‚é‡å¾ˆå¤§æ—¶ï¼Œå†…å­˜å¼€é”€è¾ƒé«˜ã€‚

   - **åŸç†ï¼š**

     - æ¯æ¬¡è¯·æ±‚è®°å½•æ—¶é—´æˆ³ï¼Œå®æ—¶è®¡ç®—åœ¨è¿‡å»ä¸€æ®µæ—¶é—´å†…çš„è¯·æ±‚æ€»æ•°ã€‚

     - åˆ¤æ–­è¯¥æ—¶é—´æ®µå†…çš„è¯·æ±‚æ•°æ˜¯å¦è¶…è¿‡é¢„è®¾é˜ˆå€¼ï¼Œä»è€Œå†³å®šæ˜¯å¦å…è®¸å½“å‰è¯·æ±‚ã€‚

   - **ä¼˜ç‚¹ï¼š**
     - å®ç°åŸç†ç›´è§‚ï¼Œå®æ—¶æ€§å¼ºã€‚

   - **ç¼ºç‚¹ï¼š**
     - å¯¹äºé«˜å¹¶å‘åœºæ™¯ä¸‹éœ€è¦å­˜å‚¨å¤§é‡æ—¥å¿—è®°å½•ï¼Œå†…å­˜å’Œè®¡ç®—å¼€é”€è¾ƒé«˜ã€‚

### é™æµä½¿ç”¨

å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

ä½¿ç”¨`@SentinelResource`æ³¨è§£**å®šä¹‰èµ„æº**ï¼ŒæŒ‡å®šåç§°è¿˜æœ‰æ‹¦æˆªçš„æ–¹æ³•ï¼ˆè¢«æ‹¦æˆªåå»æ‰§è¡Œçš„æ–¹æ³•ï¼‰

```java
@SentinelResource(value = "confirm", blockHandler = "confirmBlockHandler")
public void confirm(ConfirmOrderSaveReq req) {
	...
}
```

å®šä¹‰é™çº§æ–¹æ³•ï¼Œå‚æ•°æ˜¯**åŸæ–¹æ³•çš„å‚æ•°**åŠ ä¸Šä¸€ä¸ª`BlockException`ï¼Œè¿”å›å€¼è¦å’ŒåŸæ–¹æ³•ä¸€è‡´

```java
private void confirmBlockHandler(ConfirmOrderSaveReq req, BlockException e) {
    LOG.info("è¯·æ±‚è¢«é™æµ:{}",req);
    throw new BusinessException(BusinessExceptionEnum.CONFIRM_ORDER_FLOW_EXCEPTION);
    // å¯ä»¥åšå…¶ä»–å¤„ç†
}
```

åœ¨**å¯åŠ¨ç±»**ä¸­å®šä¹‰`initFlowRules`æ–¹æ³•ï¼Œå¹¶åœ¨mainæ–¹æ³•ä¸­è°ƒç”¨

```java
public static void main(String[] args) {
    SpringApplication app = new SpringApplication(BusinessApplication.class);
    
    Environment env = app.run(args).getEnvironment();
    LOG.info("memberå¯åŠ¨æˆåŠŸ...");
    LOG.info("memberåœ°å€:http://127.0.0.1:{}", env.getProperty("server.port"));
    
    initFlowRules();
}

// Sentinel
private static void initFlowRules(){
    List<FlowRule> rules = new ArrayList<>();
    FlowRule rule = new FlowRule();
    rule.setResource("confirm"); // åç§°è¦å’Œæ³¨è§£é‡Œçš„å¯¹åº”ä¸Š
    rule.setGrade(RuleConstant.FLOW_GRADE_QPS); // æŒ‡å®šçº§åˆ«
    rule.setCount(20); // é™åˆ¶QPSä¸ºæ¯ç§’20
    rules.add(rule);
    FlowRuleManager.loadRules(rules);
}
```

ä½¿ç”¨æ§åˆ¶å°ï¼šä¸‹è½½jaråŒ…åï¼Œç›´æ¥è¿è¡Œï¼š

```cmd
java -Dserver.port=18080 -Dcsp.sentinel.dashboard.server=localhost:18080 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.8.8.jar
```

ç„¶åè®¿é—®`localhost:18080`å³å¯ï¼Œç«¯å£æ˜¯è‡ªå·±å®šä¹‰çš„

é¡¹ç›®ä¸­ï¼Œåœ¨`application.properties`ä¸­é…ç½®ä¸‹åˆ—å†…å®¹ï¼Œ`8719`ç«¯å£æ˜¯å›ºå®šçš„ï¼Œ`18080`æ˜¯è‡ªå·±å®šä¹‰çš„æ§åˆ¶å°ç«¯å£ï¼Œå’Œä¸Šé¢çš„è¦åŒ¹é…

```properties
# é…ç½®sentinelæ§å°
spring.cloud.sentinel.transport.port=8719
spring.cloud.sentinel.transport.dashboard=localhost:18080
```

åœ¨æ§åˆ¶å°å°±å¯ä»¥ç›´æ¥é…ç½®ï¼Œè€Œ**ä¸ç”¨å†™ä¸Šé¢çš„`initFlowRules`æ–¹æ³•**äº†ï¼Œä¸è¿‡ç›´æ¥é…ç½®çš„ä¿¡æ¯çš„åœ¨å†…å­˜ä¸­çš„ï¼Œæ— æ³•æŒä¹…åŒ–ï¼Œéœ€è¦é…åˆnacos

**é…åˆnacosçš„æ­¥éª¤å¦‚ä¸‹ï¼š**

å¼•å…¥ä¾èµ–ï¼š

```xml
<!-- sentinel + nacos -->
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

é…ç½®æ–‡ä»¶ä¸­ï¼Œæœ€åçš„`ruleType`å‚æ•°æœ‰`flow`é™æµï¼Œ`degrade`é™çº§/ç†”æ–­...ç­‰å‡ ç§ï¼›

`spring.cloud.sentinel.datasource.flow.nacos`é‡Œçš„`flow`æ˜¯**è‡ªå®šä¹‰çš„åç§°**ï¼›

```properties
# é…ç½®sentinel + nacos
spring.cloud.sentinel.datasource.flow.nacos.serverAddr=localhost:8848
spring.cloud.sentinel.datasource.flow.nacos.namespace=02521b8e-52fa-430e-abe7-b73a7d68574e
spring.cloud.sentinel.datasource.flow.nacos.groupId=TRAIN_GROUP
spring.cloud.sentinel.datasource.flow.nacos.dataId=sentinel-business-flow
spring.cloud.sentinel.datasource.flow.nacos.ruleType=flow
```

åœ¨nacosä¸­åˆ›å»ºå¯¹åº”çš„é…ç½®æ–‡ä»¶`sentinel-business-flow`ï¼Œæ ¼å¼æ˜¯json

å­—æ®µæœ‰ï¼š

- resource èµ„æºåç§°
- limitApp é’ˆå¯¹æ¥æºï¼ˆåº”ç”¨åç§°ï¼‰
- grade é˜ˆå€¼ç±»å‹ï¼ˆ0æ˜¯QPSï¼Œ1æ˜¯å¹¶å‘çº¿ç¨‹æ•°ï¼‰
- count é˜ˆå€¼
- strategy æµæ§æ¨¡å¼ï¼ˆ0ç›´æ¥ï¼Œ1å…³è”ï¼Œ2é“¾è·¯ï¼‰
  - å…³è”æ¨¡å¼ä¸‹ï¼Œéœ€è¦è®¾ç½®å…³è”çš„èµ„æºï¼Œåªæœ‰å…³è”çš„èµ„æºè¢«é™æµäº†ï¼Œå½“å‰èµ„æºæ‰ä¼šå¼€å¯é™æµ
  - é“¾è·¯æ¨¡å¼å°±æ˜¯å¯¹æ¥å£åšé™æµ
- controlBehavior æµæ§æ•ˆæœï¼ˆ0å¿«é€Ÿå¤±è´¥ï¼Œ1é¢„çƒ­warm upï¼Œ2æ’é˜Ÿç­‰å¾…ï¼‰
  - é¢„çƒ­æ¨¡å¼ä¸‹ï¼Œä¸€å¼€å§‹åªç»™è®¾ç½®çš„countçš„1/3çš„æµé‡ï¼Œåç»­æ…¢æ…¢å¢é•¿ï¼Œéœ€è¦è®¾ç½®é¢„çƒ­æ—¶é•¿ï¼ˆé€‚åˆå¯åŠ¨é˜¶æ®µï¼‰
  - æ’é˜Ÿç­‰å¾…éœ€è¦è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´çš„å°±æ‹’ç»äº†ï¼ˆé€‚åˆçŸ­æ—¶é«˜å³°ï¼‰
- clusterMode æ˜¯å¦é›†ç¾¤

```json
[
    {
        "resource":"confirm",
        "limitApp":"default",
        "grade":1,
        "count":100,
        "strategy":0,
        "controlBehavior":0,
        "clusterMode":false
    }
]
```

### ç†”æ–­ä½¿ç”¨

è¿™é‡Œä½¿ç”¨sentinel + feignï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯

```properties
# é…ç½®sentinelæ§å°
spring.cloud.sentinel.transport.port=8719
spring.cloud.sentinel.transport.dashboard=localhost:18080

# é…ç½®sentinel + nacos
spring.cloud.sentinel.datasource.degrade.nacos.serverAddr=localhost:8848
spring.cloud.sentinel.datasource.degrade.nacos.namespace=02521b8e-52fa-430e-abe7-b73a7d68574e
spring.cloud.sentinel.datasource.degrade.nacos.groupId=TRAIN_GROUP
spring.cloud.sentinel.datasource.degrade.nacos.dataId=sentinel-batch-degrade
spring.cloud.sentinel.datasource.degrade.nacos.ruleType=degrade

# å¯ç”¨sentinelç›‘æ§feign
feign.sentinel.enabled=true
# å¯ç”¨feignæ‡’åŠ è½½ï¼ˆå¦åˆ™ä¸Šé¢å¯åŠ¨åå¯èƒ½å‡ºç°æ³¨å…¥å¤±è´¥ï¼‰
spring.cloud.openfeign.lazy-attributes-resolution=true
```

é…ç½®æ–‡ä»¶`sentinel-batch-degrade`

å­—æ®µæœ‰ï¼š

- grade ç†”æ–­ç­–ç•¥ ï¼ˆ0æ…¢è°ƒç”¨æ¯”ä¾‹ï¼Œ1å¼‚å¸¸æ¯”ä¾‹ï¼Œ2å¼‚å¸¸æ•°ï¼‰
  - æ…¢è°ƒç”¨æ¨¡å¼ä¸‹ï¼Œåœ¨statIntervalMsæ—¶é—´å†…ï¼Œæœ‰slowRatioThresholdæ¯”ä¾‹è¾¾åˆ°äº†å“åº”æ—¶é—´countï¼Œåˆ™è§¦å‘ç†”æ–­
  - å¼‚å¸¸æ¯”ä¾‹æ¨¡å¼ä¸‹ï¼Œcount
- count ä¸åŒæ¨¡å¼ä¸‹è¡¨ç¤ºçš„ä¿¡æ¯ä¸åŒ
  - æ…¢è°ƒç”¨ï¼šæœ€å¤§å“åº”æ—¶é—´
  - å¼‚å¸¸æ¯”ä¾‹ï¼šå¼‚å¸¸çš„æ¯”ä¾‹ï¼Œå–å€¼æ˜¯[0.0, 1.0]
  - å¼‚å¸¸æ•°ï¼šå³å¼‚å¸¸æ•°
- statIntervalMs ç»Ÿè®¡æ—¶é•¿
- tieWindow ç†”æ–­æ—¶é•¿
- minRequestAmount æœ€å°è¯·æ±‚æ•°
  - statIntervalMs æ—¶é—´å†…çš„è¯·æ±‚æ•°è¶…è¿‡minRequestAmount æ‰ä¼šè®¡ç®—å…¶ä»–å€¼å»åˆ¤æ–­æ˜¯å¦ç†”æ–­

```json
[
    {
        "resource":"GET:http://business/business/test-connect",
        "grade":0,
        "count":10,
        "tieWindow":10,
        "minRequestAmount":6,
        "statIntervalMs":1000,
        "slowRatioThreshold":0.3
    }
]
```

**é™çº§ç­–ç•¥ï¼š**

- ç¼–å†™feignæ¥å£çš„å®ç°ç±»ï¼Œå®ç°å„ä¸ªæ–¹æ³•ï¼Œåœ¨åŸæ¥å£ä¸ŠåŠ ä¸Šfalbackå‚æ•°`@FeignClient(name = "user-service", fallback = XxxFallback.class)`ï¼Œåœ¨[OpenFeign](#OpenFeign)ä¸­æœ‰è¯´åˆ°
- å½“è¢«ç†”æ–­ï¼Œæˆ–è€…è¢«è°ƒç”¨æ–¹å‡ºç°å¼‚å¸¸ï¼Œéƒ½ä¼šèµ°åˆ°é™çº§çš„æ–¹æ³•



## RocketMQ

ç†è®ºçŸ¥è¯†çœ‹çš„å›¾çµè¯¾å ‚çš„è§†é¢‘ï¼šhttps://www.bilibili.com/video/BV11B2zYVEDd/?p=6&share_source=copy_web&vd_source=184246d521185707999f94e18a91519f



ç”¨äºå®ç°å¯¹è¯·æ±‚æµé‡çš„å¼‚æ­¥å‰Šå³°å¡«è°·ï¼›

- å°†ä»¤ç‰Œè·å–å’Œè´­ç¥¨æ”¾åˆ°ä¸åŒçš„æµç¨‹ï¼Œå¯ä»¥å…ˆå¿«é€Ÿå“åº”æç¤ºï¼Œä¾‹å¦‚â€œæ­£åœ¨è´­ç¥¨ä¸­ï¼Œè¯·ç¨åâ€ï¼Œè€Œä¸æ˜¯åŸæ¥çš„ä¸€ç›´loadingï¼›æ— æ³•å‡å°‘æ’é˜Ÿæ—¶é—´ï¼Œä½†æ˜¯å¯ä»¥ç»™ç”¨æˆ·åŠæ—¶çš„åé¦ˆï¼›
- å‰ç«¯æ”¶åˆ°å¿«é€Ÿçš„å“åº”åï¼Œç­‰å¾…ä¸€å®šæ—¶é—´åå°±é€šè¿‡**è½®è¯¢æŸ¥è¯¢**ï¼ŒæŸ¥è¯¢æ˜¯å¦è´­ä¹°æˆåŠŸï¼Œç›´åˆ°åç«¯å¤„ç†å®Œè´­ç¥¨æµç¨‹ï¼Œå‰ç«¯å°±æŸ¥è¯¢åˆ°æ•°æ®ï¼›è½®è¯¢æŸ¥è¯¢å¯ä»¥æ”¾åœ¨åˆ«çš„æ¨¡å—ä¾‹å¦‚memberï¼Œå‡å°‘businessæ¨¡å—çš„å‹åŠ›;

### MQå¯¹æ¯”

å…³äºMQï¼Œé»‘é©¬å•†åŸçš„è¯¾ç¨‹é‡Œæœ‰ä¸ªMQå¯¹æ¯”å›¾ï¼š

![](image/MQå¯¹æ¯”.png)



### åŸºæœ¬ä½¿ç”¨

#### å¿«é€Ÿä½¿ç”¨

ä¸‹è½½çš„rocketmqç‰ˆæœ¬æ˜¯`5.3.2`ï¼›

é…ç½®ç¯å¢ƒå˜é‡ï¼ˆç³»ç»Ÿå˜é‡ï¼‰

```
NAMESRV_ADDR = localhost:9876
ROCKETMQ_HOME = C:\TOOL1\rocketmq\rocketmq-all-5.3.2-bin-release
```

windowsï¼šå¯åŠ¨`bin`ä¸‹çš„2ä¸ªæœåŠ¡ï¼ˆç›´æ¥åŒå‡»ï¼‰ï¼Œç¬¬ä¸€ä¸ªæ˜¯`mqnamesrv.cmd`ï¼Œç¬¬äºŒä¸ªæ˜¯`mqbroker.cmd`ï¼Œå¯ä»¥ç¼–è¾‘é‡Œé¢çš„å†…å®¹ï¼Œä¿®æ”¹æ‰€éœ€çš„å†…å­˜å¤§å°ç­‰ä¿¡æ¯ï¼›

linuxï¼šå‘½ä»¤ç¤ºä¾‹ï¼š`nohup bin/mqbroker -c é…ç½®æ–‡ä»¶xxx.properties &`

å¼•å…¥ä¾èµ–ï¼ˆå…ˆåœ¨çˆ¶pomä¸­å¼•å…¥å¹¶æŒ‡å®šç‰ˆæœ¬ï¼Œè¿™é‡Œç”¨æœ€æ–°ç‰ˆ`2.3.3`ï¼‰

```xml
<dependency>
    <groupId>org.apache.rocketmq</groupId>
    <artifactId>rocketmq-spring-boot-starter</artifactId>
</dependency>
```

å¯èƒ½åˆæ˜¯ç»å…¸çš„é˜¿é‡Œç‰ˆæœ¬ä¸å…¼å®¹ï¼Œæˆ‘åªå¼•å…¥ä¸Šé¢çš„ä¾èµ–ä¼šå¯åŠ¨å¤±è´¥æŠ¥é”™ï¼Œéœ€è¦é¢å¤–å¼•å…¥ä¸€ä¸ªï¼ˆä¸‹é¢æ˜¯çˆ¶pomä¸­çš„ï¼Œç‰ˆæœ¬ä¸º`5.3.2`ï¼‰ï¼Œæœ€å¥½åŒæ—¶ç”¨`<exclusions>`æŠŠä¸Šé¢çš„ä¾èµ–ä¸­çš„`rocketmq-client`å»æ‰ï¼›

```xml
<dependency>
    <groupId>org.apache.rocketmq</groupId>
    <artifactId>rocketmq-client</artifactId>
    <version>5.3.2</version>
</dependency>
```

å¢åŠ é…ç½®

```properties
# nameServeråœ°å€
rocketmq.name-server=http://localhost:9876
# ç”Ÿäº§è€…ç»„
rocketmq.producer.group=default
```

ç”¨`RocketMQTemplate`å‘é€æ¶ˆæ¯ï¼š

```java
@Autowired
private RocketMQTemplate rocketMQTemplate;

// å‘é€è¯·æ±‚å‚æ•°ï¼Œå‚æ•°(topic,msg)
// convertAndSendå°±æ˜¯å¸®ä½ å°†å­—ç¬¦ä¸²è½¬æˆä¸€ä¸ªRocketMQé‡Œçš„Messageå¯¹è±¡
rocketMQTemplate.convertAndSend("confirm_order", JSON.toJSONString(req));
```

åˆ›å»º**æ¶ˆè´¹è€…ç±»**ï¼Œå®ç°`RocketMQListener`æ¥å£ï¼ŒåŠ ä¸Š`@RocketMQMessageListener`æ³¨è§£ï¼ˆæŒ‡å®šç”Ÿäº§è€…ç»„å’ŒTopicï¼‰ï¼Œé‡å†™`onMessage`æ–¹æ³•

tipï¼šæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ä¸€èˆ¬ä¸æ”¾åœ¨åŒä¸€ä¸ªæ¨¡å—ä¸­ï¼Œä½†æ˜¯è¿™é‡Œä¸ºäº†æ–¹ä¾¿å°±å…¨éƒ¨æ”¾åœ¨`business`æ¨¡å—ä¸­äº†

```java
@Service
@RocketMQMessageListener(consumerGroup = "default", topic = "confirm_order")
public class ConfirmOrderConsumer implements RocketMQListener<MessageExt> {
    
    @Override
    public void onMessage(MessageExt messageExt) {
        byte[] body = messageExt.getBody();
        ....
    }
}
```



#### æ‹‰æ¨¡å¼

`rocketMQTemplate`æœ‰`receive()`æ–¹æ³•ï¼Œå³æ¶ˆè´¹è€…çš„**PULLæ¨¡å¼**ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•éœ€è¦é¢å¤–é…ç½®ä¸Štopicå’Œæ¶ˆè´¹è€…ç»„

```properties
rocketmq.pull-consumer.topic=xxx
rocketmq.pull-consumer.group=xxxx
```

æ³¨æ„ï¼šç‰ˆæœ¬æœ‰å˜åŠ¨ï¼Œå¯èƒ½ä¸ä¸€æ ·ï¼Œæœ€å¥½å»**çœ‹æºç **ï¼ˆæŒ‰ä½ctrlç‚¹å‡»é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥è·³è½¬åˆ°é…ç½®ç±»ï¼Œç„¶åIDEAå·¦è¾¹å®šä½æ–‡ä»¶ä½ç½®ï¼‰é‡Œçš„æ¡ä»¶æ³¨è§£é‡Œçš„å†…å®¹ï¼Œä¾‹å¦‚çœ‹åˆ°é‡Œé¢ï¼š

```java
@Bean({"defaultLitePullConsumer"})
@ConditionalOnMissingBean({DefaultLitePullConsumer.class})
@ConditionalOnProperty(
    prefix = "rocketmq",
    value = {"name-server", "pull-consumer.group", "pull-consumer.topic"}
)
public DefaultLitePullConsumer defaultLitePullConsumer(
    RocketMQProperties rocketMQProperties) throws MQClientException {
    ...
}
```

ä¹Ÿå°±æ˜¯è¯´éœ€è¦é…ç½®**"name-server", "pull-consumer.group", "pull-consumer.topic"** è¿™3é¡¹å†…å®¹



#### äº‹åŠ¡æ¶ˆæ¯

å…³äº**äº‹åŠ¡æ¶ˆæ¯çš„ç›‘å¬**ï¼Œä¸æ˜¯åœ¨ç±»ä¸­å†™2ä¸ªæ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œå†™ä¸€ä¸ªç›‘å¬å™¨ç±»ï¼Œå®ç°`RocketMQLocalTransactionListener`æ¥å£ï¼›

```java
public class Listener implements RocketMQLocalTransactionListener {
    @Override
    public RocketMQLocalTransactionState executeLocalTransaction(Message message, Object o) {
        return null;
    }

    @Override
    public RocketMQLocalTransactionState checkLocalTransaction(Message message) {
        return null;
    }
}
```

æ¶ˆè´¹è€…éœ€è¦å®ç°æ³¨è§£ï¼Œå¦‚æœéœ€è¦å¤šä¸ªç›‘å¬å™¨ï¼Œéœ€è¦å¤šä¸ªtemplateï¼Œé€šè¿‡ç»§æ‰¿`RocketMQTemplate`åˆ›å»ºè‡ªå·±çš„templateï¼Œç±»é‡Œä¸éœ€è¦å†™ä»£ç ï¼›ç„¶åæ³¨è§£å¯ä»¥æŒ‡å®štemplateç±»çš„beanåç§°ï¼Œé»˜è®¤æ˜¯`rocketMQTemplate`

```java
@RocketMQTransactionListener(rocketMQTemplateBeanName = "myRocketMQTemplate")
```



### æ¦‚å¿µ

#### é‡è¦æ¦‚å¿µ

- **ç”Ÿäº§è€…**
  - è´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼Œä¸€èˆ¬ç”±ä¸šåŠ¡ç³»ç»Ÿè´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ã€‚ä¸€ä¸ªæ¶ˆæ¯ç”Ÿäº§è€…ä¼šæŠŠä¸šåŠ¡åº”ç”¨ç³»ç»Ÿé‡Œäº§ç”Ÿçš„æ¶ˆæ¯å‘é€åˆ°brokeræœåŠ¡å™¨ã€‚RocketMQæä¾›å¤šç§å‘é€æ–¹å¼ï¼ŒåŒæ­¥å‘é€ã€å¼‚æ­¥å‘é€ã€é¡ºåºå‘é€ã€å•å‘å‘é€ã€‚ï¼ˆä¸‹é¢çš„æ–¹æ³•åçš„åŸç”ŸAPIçš„ï¼Œå’ŒSpringbootçš„ä¸å¤ªä¸€æ ·ï¼‰
    - **å•å‘å‘é€** `sendOneWay(...)`
      - æ–¹æ³•çš„è¿”å›å€¼æ˜¯`void`ï¼Œå°†æ¶ˆæ¯å‘ç»™brokerï¼Œä¹‹åå°±ä¸å…³å¿ƒäº†ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æˆåŠŸï¼›
      - ç®€å•ï¼Œæ€§èƒ½é«˜ï¼Œä¸å®‰å…¨ï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼›
      - ```java
        rocketMQTemplate.sendOneWay("topic:tag", payload);
        ```
    - **åŒæ­¥å‘é€** `send(...)`
      - æ–¹æ³•çš„è¿”å›å€¼æ˜¯`SendResult`ï¼Œå¯ä»¥è·å¾—æ¶ˆæ¯çš„å‘é€çŠ¶æ€ã€å‘é€åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—ä¿¡æ¯ã€offsetæ¶ˆè´¹ä½ç‚¹ç­‰ï¼Œå°±æ˜¯è·å–ä¸€äº›ä¸Šä¸‹æ–‡
      - å®‰å…¨ï¼Œä½†æ˜¯å¯èƒ½äº§ç”Ÿé˜»å¡ï¼Œå½±å“æ€§èƒ½ï¼›
      - ```java
        SendResult result = rocketMQTemplate.syncSend("topic:tag", payload);
        ```
    - **å¼‚æ­¥å‘é€** `send(msg, new SendCallBack(){é‡å†™æ–¹æ³•})`
      - æ–¹æ³•çš„è¿”å›å€¼æ˜¯`void`ï¼Œç”¨lambdaé‡å†™`onSuccess`å’Œ`onException`æ–¹æ³•ï¼Œæ ¹æ®æˆåŠŸ/å¤±è´¥è§¦å‘å¯¹åº”é€»è¾‘ï¼›
      - æ€§èƒ½ä¸­ç­‰ï¼Œ`producerå¯¹è±¡`ä¸èƒ½ç«‹å³shutdownï¼Œéœ€è¦sleepä¸€æ®µæ—¶é—´ï¼Œæµªè´¹æœåŠ¡å™¨æ€§èƒ½
      - ```java
        rocketMQTemplate.asyncSend(
            "topic:tag",
            payload,
            new SendCallback() {
                @Override public void onSuccess(SendResult sendResult) { /* æˆåŠŸé€»è¾‘ */ }
                @Override public void onException(Throwable e) { /* å¼‚å¸¸é‡è¯•ç­‰ */ }
            }
        );
        ```
- **æ¶ˆè´¹è€…**
  - è´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¸€èˆ¬æ˜¯åå°ç³»ç»Ÿè´Ÿè´£å¼‚æ­¥æ¶ˆè´¹ã€‚ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ä¼šä»BrokeræœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯ã€å¹¶å°†å…¶æä¾›ç»™åº”ç”¨ç¨‹åºã€‚ä»ç”¨æˆ·åº”ç”¨çš„è§’åº¦è€Œè¨€æä¾›äº†ä¸¤ç§æ¶ˆè´¹å½¢å¼ï¼šæ‹‰å–å¼æ¶ˆè´¹ã€æ¨åŠ¨å¼æ¶ˆè´¹ã€‚
  - 2ç§æ¶ˆè´¹æ¨¡å¼
    - **é›†ç¾¤æ¶ˆè´¹æ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰
      - å½“ä½¿ç”¨é›†ç¾¤æ¶ˆè´¹æ¨¡å¼æ—¶ï¼ŒRocketMQ è®¤ä¸ºä»»æ„ä¸€æ¡æ¶ˆæ¯åªéœ€è¦è¢«**æ¶ˆè´¹ç»„å†…**çš„ä»»æ„**ä¸€ä¸ª**æ¶ˆè´¹è€…å¤„ç†å³å¯ã€‚
    - **å¹¿æ’­æ¶ˆè´¹æ¨¡å¼**
      - å½“ä½¿ç”¨å¹¿æ’­æ¶ˆè´¹æ¨¡å¼æ—¶ï¼ŒRocketMQ ä¼šå°†æ¯æ¡æ¶ˆæ¯æ¨é€ç»™**æ¶ˆè´¹ç»„æ‰€æœ‰**çš„æ¶ˆè´¹è€…ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¯ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ä¸€æ¬¡ã€‚
      - å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œ**æ¶ˆè´¹ä½ç‚¹ç”±å®¢æˆ·ç«¯ç®¡ç†**ï¼Œè€Œä¸ç”±æœåŠ¡ç«¯ç®¡ç†ï¼Œé»˜è®¤ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„userç›®å½•ä¸‹ï¼›æ‰€ä»¥åœ¨æœåŠ¡ç«¯ï¼Œæˆ–è€…è¯´dashboardä¸­ï¼Œçœ‹ä¸åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹åˆ°å“ªé‡Œäº†ï¼›
        - ä¿å­˜çš„æ–‡ä»¶åå½¢å¦‚`192.168.2.1@DEFAULT`ï¼Œè¿™ä¸ªæ–‡ä»¶åçš„windowsä¸‹æ— æ³•ä¿å­˜...
      - **æ— æ³•è¿”å›æ¶ˆæ¯å¤„ç†çŠ¶æ€ï¼Œæ— æ³•è§¦å‘é‡è¯•**ï¼›
  - æ¨æ‹‰
    - **Push**
      - æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ï¼Œä¼˜ç‚¹æ˜¯åŠæ—¶æ€§è¾ƒå¥½ï¼Œä½†å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰åšå¥½æµæ§ï¼Œä¸€æ—¦æœåŠ¡ç«¯æ¨é€å¤§é‡æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯æ—¶ï¼Œå°±ä¼šå¯¼è‡´å®¢æˆ·ç«¯æ¶ˆæ¯å †ç§¯ç”šè‡³å´©æºƒã€‚**ï¼ˆä¸€èˆ¬ç”¨æ¨æ¨¡å¼ï¼‰**
      - æ¶ˆè´¹è€…è®¢é˜…æŸä¸€ä¸ªTopicï¼Œ**æ¶ˆæ¯ç›‘å¬å™¨**å»ç­‰æœåŠ¡ç«¯æ¨é€ï¼Œç„¶åæ‰§è¡Œè‡ªå·±å†™çš„ä¸šåŠ¡ä»£ç ï¼›
      - ç›‘å¬å™¨è¿”å›ä¸€ä¸ªæšä¸¾ï¼ŒæˆåŠŸ/é‡è¯•ç­‰ï¼Œå¦‚æœæ˜¯è¿”å›é‡è¯•ï¼Œbrokerä¼šé‡æ–°æŠ•é€’ä¸€æ¬¡æ¶ˆæ¯ï¼›
    - **Pull**
      - å®¢æˆ·ç«¯éœ€è¦ä¸»åŠ¨åˆ°æœåŠ¡ç«¯å–æ•°æ®ï¼Œä¼˜ç‚¹æ˜¯å®¢æˆ·ç«¯å¯ä»¥ä¾æ®è‡ªå·±çš„æ¶ˆè´¹èƒ½åŠ›è¿›è¡Œæ¶ˆè´¹ï¼Œä½†æ‹‰å–çš„é¢‘ç‡ä¹Ÿéœ€è¦ç”¨æˆ·è‡ªå·±æ§åˆ¶ï¼Œæ‹‰å–é¢‘ç¹å®¹æ˜“é€ æˆæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å‹åŠ›ï¼Œæ‹‰å–é—´éš”é•¿åˆå®¹æ˜“é€ æˆæ¶ˆè´¹ä¸åŠæ—¶ã€‚
- **ä¸»é¢˜**
  - è¡¨ç¤ºä¸€ç±»æ¶ˆæ¯çš„é›†åˆï¼Œæ¯ä¸ªä¸»é¢˜åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åªèƒ½å±äºä¸€ä¸ªä¸»é¢˜ï¼Œæ˜¯RocketMQè¿›è¡Œæ¶ˆæ¯è®¢é˜…çš„**åŸºæœ¬å•ä½**ã€‚
  - RocketMQ éƒ¨ç½²å®‰è£…åŒ…é»˜è®¤å¼€å¯äº† **autoCreateTopicEnable** é…ç½®ï¼Œä¼šè‡ªåŠ¨ä¸ºå‘é€çš„æ¶ˆæ¯åˆ›å»º Topicï¼Œä½†è¯¥ç‰¹æ€§ä»…æ¨èåœ¨åˆæœŸæµ‹è¯•æ—¶ä½¿ç”¨ã€‚
    - å®˜ç½‘ï¼š**ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®ç®¡ç†æ‰€æœ‰ä¸»é¢˜çš„ç”Ÿå‘½å‘¨æœŸï¼Œå…³é—­è‡ªåŠ¨åˆ›å»ºå‚æ•°**ï¼Œä»¥é¿å…ç”Ÿäº§é›†ç¾¤å‡ºç°å¤§é‡æ— æ•ˆä¸»é¢˜ï¼Œæ— æ³•ç®¡ç†å’Œå›æ”¶ï¼Œé€ æˆé›†ç¾¤æ³¨å†Œå‹åŠ›å¢å¤§ï¼Œå½±å“ç”Ÿäº§é›†ç¾¤çš„ç¨³å®šæ€§ã€‚



#### æ¶ˆæ¯

**æ¶ˆæ¯æ„æˆ**ï¼š

- **topic**ï¼Œè¡¨ç¤ºè¦å‘é€çš„æ¶ˆæ¯çš„ä¸»é¢˜ã€‚
- **body** è¡¨ç¤ºæ¶ˆæ¯çš„å­˜å‚¨å†…å®¹
- **properties** è¡¨ç¤ºæ¶ˆæ¯å±æ€§
- **transactionId** ä¼šåœ¨äº‹åŠ¡æ¶ˆæ¯ä¸­ä½¿ç”¨ã€‚

**æ¶ˆæ¯ç±»å‹ï¼š**

- æ™®é€šæ¶ˆæ¯
- é¡ºåºæ¶ˆæ¯

  - ```java
    rocketMQTemplate.syncSendOrderly(
        "orderly-topic", 
        MessageBuilder.withPayload(order).build(), 
        order.getUserId().toString()  // ç›¸åŒ key ç¡®ä¿å‘å¾€åŒä¸€é˜Ÿåˆ—
    );
    ```

- å»¶è¿Ÿæ¶ˆæ¯

  - ```java
    rocketMQTemplate.syncSend("topic:tag", msg, timeout, delayLevel);
    ```

- æ‰¹é‡æ¶ˆæ¯
- äº‹åŠ¡æ¶ˆæ¯

  - ```java
    Message<String> msg = MessageBuilder.withPayload("äº‹åŠ¡æ¶ˆæ¯").build();
    rocketMQTemplate.sendMessageInTransaction(
        "tx-producer-group", 
        "tx-topic:tag", 
        msg, 
        bizArg  // ä¸šåŠ¡å‚æ•°ï¼Œå¯åœ¨å›æŸ¥æ—¶ä½¿ç”¨
    );
    ```




#### è¿è¡Œæ¶æ„

- NameServer
  - ç±»ä¼¼æ³¨å†Œä¸­å¿ƒï¼ŒProducer & Consumer å» NameServer è·å–åˆ° Broker æœåŠ¡çš„åœ°å€ä¿¡æ¯ï¼Œç„¶åå‘é€/æ¥æ”¶æ¶ˆæ¯ï¼›
- Broker
  - æ ¸å¿ƒï¼Œè´Ÿè´£æ¶ˆæ¯å­˜å‚¨ã€ä¼ é€’ã€æŸ¥è¯¢ç­‰ï¼›
- Producer & Consumer

![](image/rocketmq-è¿è¡Œæ¶æ„.png)



#### æ¶ˆæ¯æ¨¡å‹

- Producer / Consumer åœ¨ å‘é€æ¶ˆæ¯ / ç›‘å¬æ¶ˆæ¯æ—¶ï¼Œéƒ½éœ€è¦æŒ‡å®š **Topic**ï¼›
- Topic ä¸‹çš„ MessageQueue é˜Ÿåˆ—æ‰æ˜¯çœŸæ­£å­˜å‚¨æ¶ˆæ¯çš„ï¼›

![](image/rocketMQæ¶ˆæ¯æ¨¡å‹.png)

- åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œ**æ¶ˆè´¹ä½ç‚¹(offset)**å¾ˆå…³é”®
  - RocketMQ å®šä¹‰é˜Ÿåˆ—ä¸­æœ€æ—©ä¸€æ¡æ¶ˆæ¯çš„ä½ç‚¹ä¸ºæœ€å°æ¶ˆæ¯ä½ç‚¹ï¼ˆMinOffsetï¼‰ï¼›æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„ä½ç‚¹ä¸ºæœ€å¤§æ¶ˆæ¯ä½ç‚¹ï¼ˆMaxOffsetï¼‰ã€‚
  - è™½ç„¶æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘ä¸Šæ˜¯æ— é™å­˜å‚¨ï¼Œä½†ç”±äºæœåŠ¡ç«¯ç‰©ç†èŠ‚ç‚¹çš„å­˜å‚¨ç©ºé—´æœ‰é™ï¼Œ RocketMQ ä¼šæ»šåŠ¨åˆ é™¤é˜Ÿåˆ—ä¸­å­˜å‚¨æœ€æ—©çš„æ¶ˆæ¯ã€‚å› æ­¤ï¼Œæ¶ˆæ¯çš„æœ€å°æ¶ˆè´¹ä½ç‚¹å’Œæœ€å¤§æ¶ˆè´¹ä½ç‚¹ä¼šä¸€ç›´é€’å¢å˜åŒ–ã€‚
  - ![](image/rocketmq-offset.png)
  - å…¶ä¸­ï¼Œç”¨**æ¶ˆè´¹ä½ç‚¹**æ¥è®°å½•æŸä¸ª**æ¶ˆè´¹è€…ç»„**æ¶ˆè´¹åˆ°å“ªé‡Œï¼›
    - å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­ï¼Œæ¯ä¸ªä¸»é¢˜çš„é˜Ÿåˆ—éƒ½å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…åˆ†ç»„è®¢é˜…ã€‚è‹¥æŸæ¡æ¶ˆæ¯è¢«æŸä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹åç›´æ¥è¢«åˆ é™¤ï¼Œåˆ™å…¶ä»–è®¢é˜…äº†è¯¥ä¸»é¢˜çš„æ¶ˆè´¹è€…å°†æ— æ³•æ¶ˆè´¹è¯¥æ¶ˆæ¯ã€‚
    - å› æ­¤ RocketMQ é€šè¿‡**æ¶ˆè´¹ä½ç‚¹**ç®¡ç†æ¶ˆæ¯çš„æ¶ˆè´¹è¿›åº¦ã€‚æ¯æ¡æ¶ˆæ¯è¢«æŸä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹å®Œæˆåä¸ä¼šç«‹å³åœ¨é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œä¼š**åŸºäºæ¯ä¸ªæ¶ˆè´¹è€…åˆ†ç»„**ç»´æŠ¤ä¸€ä»½æ¶ˆè´¹è®°å½•ï¼Œè¯¥è®°å½•æŒ‡å®šæ¶ˆè´¹è€…åˆ†ç»„æ¶ˆè´¹æŸä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼Œæ¶ˆè´¹è¿‡çš„æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„ä½ç‚¹ï¼Œå³æ¶ˆè´¹ä½ç‚¹ã€‚
    - å½“æ¶ˆè´¹è€…å®¢æˆ·ç«¯ç¦»çº¿ï¼Œåˆå†æ¬¡**é‡æ–°ä¸Šçº¿**æ—¶ï¼Œä¼šä¸¥æ ¼æŒ‰ç…§æœåŠ¡ç«¯ä¿å­˜çš„æ¶ˆè´¹è¿›åº¦ç»§ç»­å¤„ç†æ¶ˆæ¯ã€‚å¦‚æœæœåŠ¡ç«¯ä¿å­˜çš„å†å²ä½ç‚¹ä¿¡æ¯å·²è¿‡æœŸè¢«åˆ é™¤ï¼Œæ­¤æ—¶æ¶ˆè´¹ä½ç‚¹å‘å‰ç§»åŠ¨è‡³æœåŠ¡ç«¯å­˜å‚¨çš„æœ€å°ä½ç‚¹ã€‚
  - ![rocketmq-consumer-offset](rocketmq-consumer-offset.png)





### é›†ç¾¤

#### æ™®é€šé›†ç¾¤

- å›ºå®šé…ç½®ä¸»ä»ï¼ŒMasterè´Ÿè´£è¯»å†™ï¼ŒSlaveåªè´Ÿè´£å¤‡ä»½ï¼›
- ç”±äºæ˜¯å›ºå®šé…ç½®ï¼ŒMasteræŒ‚äº†åSlaveå¹¶ä¸ä¼šè‡ªåŠ¨å˜ä¸ºMasterï¼›

![](image/rocketmq-åˆ†å¸ƒå¼é›†ç¾¤.png)

#### Dledgeré«˜å¯ç”¨é›†ç¾¤

- ä¸æŒ‡å®šMasterï¼Œè€Œæ˜¯è‡ªåŠ¨é€‰ä¸¾ï¼›æ”¹åå«åš Leader å’Œ Followerï¼›
- æ³¨æ„è¿™ç§é›†ç¾¤åªæœ‰åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹æ­£å¸¸å·¥ä½œæ‰ä¼šç”Ÿæ•ˆï¼Œå¦‚æœåŠæ•°ä»¥ä¸ŠæŒ‚äº†ï¼Œå°±ä¸è¡Œäº†ï¼Œä¾‹å¦‚**3å°**æœºå™¨ï¼ŒæŒ‚äº†1å°ï¼Œä¼šè‡ªåŠ¨é€‰ä¸¾æ–°çš„Leaderï¼Œå†æŒ‚1å°å‰©ä¸‹1å°ï¼Œå°±ä¸ä¼šæŠŠè‡ªå·±é€‰ä¸¾ä¸ºLeaderï¼Œå¤±æ•ˆäº†ï¼›
  - è¿™æ ·æƒ³æ¥ï¼Œä¸€èˆ¬æ­å»ºå¥‡æ•°å°æœºå™¨ï¼Œå› ä¸ºä¾‹å¦‚5å’Œ6å°ï¼Œéƒ½æ˜¯å®¹å¿2å°å®•æœºï¼›
- ä¿è¯äº†å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯æ€§èƒ½è¾ƒå·®ï¼Œæ‰€ä»¥ä¸å¸¸ç”¨ï¼›

![](image/rocketmq-Dledgeré›†ç¾¤.png)

ä¸‹è½½ä¸‹æ¥çš„åŒ…ä¸­æœ‰**é…ç½®ç¤ºä¾‹**ï¼Œä¾‹å¦‚`2m-2s`å°±æ˜¯ä¸¤ä¸»ä¸¤ä»ï¼Œdledgerç›®å½•ä¸‹ä¹Ÿæ˜¯ä¸€äº›ç›¸å…³çš„é…ç½®ï¼Œæ”¹ä¸€æ”¹å°±å¯ä»¥ç”¨äº†ï¼›

![](image/rocketmq-conf.png)

#### ä¸»å¤‡è‡ªåŠ¨åˆ‡æ¢æ¨¡å¼éƒ¨ç½²

- å…¶å®å°±æ˜¯å¯¹ç¬¬ä¸€ç§é›†ç¾¤çš„å¢å¼ºï¼Œå¯ä»¥è‡ªåŠ¨åˆ‡æ¢ä¸»ä»ï¼Œéœ€è¦é¢å¤–çš„ç»„ä»¶

- https://rocketmq.apache.org/zh/docs/deploymentOperations/03autofailover/



### æ¶ˆæ¯è¿‡æ»¤

#### Tagè¿‡æ»¤

- ç”Ÿäº§è€…ç”Ÿäº§æ—¶é™¤äº†æŒ‡å®š`topic`ï¼Œè¿˜å¯ä»¥æŒ‡å®š`tag`ï¼Œæ¶ˆè´¹è€…è®¢é˜…æ—¶ä¹Ÿå¯ä»¥æŒ‡å®š`tag`
- ![](image/rocketmq-æ¶ˆæ¯è¿‡æ»¤-tagè¿‡æ»¤.png)

```java
// æ¶ˆè´¹è€…çš„æ³¨è§£å‚æ•°
@RocketMQMessageListener(
    topic = "filter-topic",
    consumerGroup = "consumer06-group",
    selectorType = SelectorType.TAG,
    selectorExpression = "tag1 || tag2 || tag3"
)
```



#### SQLè¿‡æ»¤

- æ³¨æ„ï¼šéœ€è¦ä¿®æ”¹brokeré‡Œçš„é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®`enablePropertyFilter=true`

- ç”¨sqlè¯­å¥æ¥è¿‡æ»¤æ¶ˆæ¯ï¼Œæ³¨æ„å¹¶ä¸æ˜¯æ“ä½œæ•°æ®åº“ï¼Œåªæ˜¯ä»¥sqlçš„å½¢å¼æ¥å†™ï¼Œåº•å±‚ä½¿ç”¨**ANTLR**æ¡†æ¶è§£æSQL

- å¯ä»¥å®ç°ä¾‹å¦‚`price > 30`ï¼Œç”¨Tagè¿‡æ»¤å°±æ— æ³•è¿™æ ·è¿‡æ»¤ï¼›

- ```java
  // å‘é€ï¼š
  Message message = messageBuilder.setTopic("topic")
  // è®¾ç½®æ¶ˆæ¯ç´¢å¼•é”®ï¼Œå¯æ ¹æ®å…³é”®å­—ç²¾ç¡®æŸ¥æ‰¾æŸæ¡æ¶ˆæ¯ã€‚
  .setKeys("messageKey")
  // è®¾ç½®æ¶ˆæ¯Tagï¼Œç”¨äºæ¶ˆè´¹ç«¯æ ¹æ®æŒ‡å®šTagè¿‡æ»¤æ¶ˆæ¯ã€‚
  .setTag("messageTag")
  // æ¶ˆæ¯ä¹Ÿå¯ä»¥è®¾ç½®è‡ªå®šä¹‰çš„åˆ†ç±»å±æ€§ï¼Œä¾‹å¦‚ç¯å¢ƒæ ‡ç­¾ã€åœ°åŸŸã€é€»è¾‘åˆ†æ”¯ã€‚
  // è¯¥ç¤ºä¾‹è¡¨ç¤ºä¸ºæ¶ˆæ¯è‡ªå®šä¹‰ä¸€ä¸ªå±æ€§ï¼Œè¯¥å±æ€§ä¸ºåœ°åŸŸï¼Œå±æ€§å€¼ä¸ºæ­å·ã€‚
  .addProperty("Region", "Hangzhou")
  // æ¶ˆæ¯ä½“ã€‚
  .setBody("messageBody".getBytes())
  .build();
  
  // æ¥æ”¶ï¼šåªè®¢é˜…åœ°åŸŸå±æ€§ä¸ºæ­å·ä¸”ä»·æ ¼å±æ€§å¤§äº30çš„æ¶ˆæ¯ã€‚
  FilterExpression filterExpression = new FilterExpression("Region IS NOT NULL AND price IS NOT NULL AND Region = 'Hangzhou' AND price > 30", FilterExpressionType.SQL92);
  simpleConsumer.subscribe(topic, filterExpression);
  ```

springbootä½¿ç”¨ï¼š

```java
@RocketMQMessageListener(
    topic = "sql-filter-topic",
    consumerGroup = "sql-consumer-group",
    selectorType = SelectorType.SQL92,
    selectorExpression = "age > 30 AND status = 'active'"
)
```



| å¯¹æ¯”é¡¹   | Tagæ ‡ç­¾è¿‡æ»¤                                             | SQLå±æ€§è¿‡æ»¤                                                  |
| -------- | ------------------------------------------------------- | ------------------------------------------------------------ |
| è¿‡æ»¤ç›®æ ‡ | æ¶ˆæ¯çš„Tagæ ‡ç­¾ã€‚                                         | æ¶ˆæ¯çš„å±æ€§ï¼ŒåŒ…æ‹¬ç”¨æˆ·è‡ªå®šä¹‰å±æ€§ä»¥åŠç³»ç»Ÿå±æ€§ï¼ˆTagæ˜¯ä¸€ç§ç³»ç»Ÿå±æ€§ï¼‰ã€‚ |
| è¿‡æ»¤èƒ½åŠ› | ç²¾å‡†åŒ¹é…ï¼Œåªèƒ½ç²¾ç¡®åœ°æŒ‡å®šè¦å“ªäº›Tagï¼Œå¦‚`Tag1||Tag2||Tag3` | SQLè¯­æ³•åŒ¹é…ã€‚                                                |
| é€‚ç”¨åœºæ™¯ | ç®€å•è¿‡æ»¤åœºæ™¯ã€è®¡ç®—é€»è¾‘ç®€å•è½»é‡ï¼ˆæ€§èƒ½æ›´é«˜ï¼‰              | å¤æ‚è¿‡æ»¤åœºæ™¯ã€è®¡ç®—é€»è¾‘è¾ƒå¤æ‚ã€‚ï¼ˆæ€§èƒ½è¾ƒä½ï¼‰                   |



### é¡ºåºæ¶ˆæ¯

RocketMQ é¡ºåºæ¶ˆæ¯çš„é¡ºåºå…³ç³»é€šè¿‡**æ¶ˆæ¯ç»„**ï¼ˆMessageGroupï¼‰åˆ¤å®šå’Œè¯†åˆ«ï¼Œå‘é€é¡ºåºæ¶ˆæ¯æ—¶éœ€è¦ä¸ºæ¯æ¡æ¶ˆæ¯è®¾ç½®å½’å±çš„æ¶ˆæ¯ç»„ï¼Œç›¸åŒæ¶ˆæ¯ç»„çš„å¤šæ¡æ¶ˆæ¯ä¹‹é—´éµå¾ªå…ˆè¿›å…ˆå‡ºçš„é¡ºåºå…³ç³»ï¼Œä¸åŒæ¶ˆæ¯ç»„ã€æ— æ¶ˆæ¯ç»„çš„æ¶ˆæ¯ä¹‹é—´ä¸æ¶‰åŠé¡ºåºæ€§ï¼Œå³ä¿è¯**å±€éƒ¨æœ‰åº**ï¼ˆä¸šåŠ¡ä¸Šï¼Œå…¶å®å¹¶ä¸éœ€è¦ä¿è¯å…¨å±€æœ‰åºï¼Œæ²¡æ„ä¹‰ï¼‰

**tipï¼š**æ¶ˆæ¯ç»„è¿™ä¸ªæ¦‚å¿µåœ¨å®é™…ä»£ç ä¸­å¹¶æ²¡æœ‰ï¼Œéœ€è¦æ‰‹åŠ¨å®ç°ï¼Œå¯ä»¥é€šè¿‡åˆ«çš„æ–¹å¼ï¼Œä¾‹å¦‚ç”¨hashæ˜ å°„æŸç»„æ¶ˆæ¯å‘é€åˆ°æŸä¸ªé˜Ÿåˆ—ï¼›å¯èƒ½åç»­ä¼šæ›´æ–°ï¼Ÿ**æ€»ä¹‹å°±æ˜¯ä¿è¯éƒ½å‘åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—é‡Œ**

é¡ºåºæ¶ˆæ¯çš„å®ç°éœ€è¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ç›¸äº’é…åˆã€‚

å¯¹äº**ç”Ÿäº§è€…**ï¼Œæœ‰ä»¥ä¸‹è§„åˆ™ï¼š

- **ç›¸åŒæ¶ˆæ¯ç»„**çš„æ¶ˆæ¯æŒ‰ç…§å…ˆåé¡ºåºè¢«å­˜å‚¨åœ¨**åŒä¸€ä¸ªé˜Ÿåˆ—**ã€‚
- ä¸åŒæ¶ˆæ¯ç»„çš„æ¶ˆæ¯å¯ä»¥æ··åˆåœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œä¸”ä¸ä¿è¯è¿ç»­ã€‚

**eg**ï¼š1ç¬”è®¢å•æœ‰3ä¸ªæ­¥éª¤ï¼Œå‡è®¾10ä¸ªè®¢å•ï¼Œè¿™10ä¸ªè®¢å•çš„æ¥æ”¶é¡ºåºä¸ä¸€å®šæ˜¯1-1, 1-2, 1-3, 2-1, 2-2, 2-3, 3-1,......ä½†æ˜¯å¯¹äºæ¯ç¬”è®¢å•ï¼Œä¸€å®šæ˜¯å…ˆi-1ï¼Œç„¶åå¯èƒ½ç©¿æ’å…¶ä»–è®¢å•çš„æ¶ˆæ¯ï¼Œç„¶åi-2....i-3ï¼›

![](image/rocketmq-é¡ºåºæ¶ˆæ¯-æ¶ˆæ¯ç»„.png)

å¯¹äº**æ¶ˆè´¹è€…**ï¼šæœ‰ä»¥ä¸‹è§„åˆ™ï¼š

- ä¸èƒ½ä¸€æ¬¡æ‹‰å–å¤šä¸ªé˜Ÿåˆ—çš„å¤šæ¡æ¶ˆæ¯ï¼Œä¸€æ¬¡åªèƒ½æ‹‰ä¸€ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯ï¼›
- åŒæ—¶ï¼ŒåŸæœ¬æ˜¯å¯ä»¥å¤šçº¿ç¨‹æ‹‰å–åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œç°åœ¨éœ€è¦æ”¹ä¸º**å•çº¿ç¨‹**ï¼Œæˆ–è€…è¯´åŠ ä¸Š**é˜Ÿåˆ—é”**ï¼›
- å¤±è´¥é‡è¯•æ—¶è¦**é˜»å¡æ•´ä¸ªé˜Ÿåˆ—**ä¸€æ®µæ—¶é—´
  - é¡ºåºæ¶ˆæ¯æŠ•é€’ä»…åœ¨é‡è¯•æ¬¡æ•°é™å®šèŒƒå›´å†…ï¼Œå³ä¸€æ¡æ¶ˆæ¯å¦‚æœä¸€ç›´é‡è¯•å¤±è´¥ï¼Œè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åå°†ä¸å†é‡è¯•ï¼Œè·³è¿‡è¿™æ¡æ¶ˆæ¯æ¶ˆè´¹ï¼Œä¸ä¼šä¸€ç›´é˜»å¡åç»­æ¶ˆæ¯å¤„ç†ã€‚



#### ä½¿ç”¨å»ºè®®

- **ä¸²è¡Œæ¶ˆè´¹ï¼Œé¿å…æ‰¹é‡æ¶ˆè´¹å¯¼è‡´ä¹±åº**

  - æ¶ˆæ¯æ¶ˆè´¹å»ºè®®ä¸²è¡Œå¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ¶ˆè´¹å¤šæ¡æ¶ˆæ¯ï¼Œå¦åˆ™å¯èƒ½å‡ºç°ä¹±åºæƒ…å†µã€‚

  - ä¾‹å¦‚ï¼šå‘é€é¡ºåºä¸º1->2->3->4ï¼Œæ¶ˆè´¹æ—¶æ‰¹é‡æ¶ˆè´¹ï¼Œæ¶ˆè´¹é¡ºåºä¸º1->23ï¼ˆæ‰¹é‡å¤„ç†ï¼Œå¤±è´¥ï¼‰->23ï¼ˆé‡è¯•å¤„ç†ï¼‰->4ï¼Œæ­¤æ—¶å¯èƒ½ç”±äºæ¶ˆæ¯3çš„å¤±è´¥å¯¼è‡´æ¶ˆæ¯2è¢«é‡å¤å¤„ç†ï¼Œæœ€åå¯¼è‡´æ¶ˆæ¯æ¶ˆè´¹ä¹±åºã€‚

- **æ¶ˆæ¯ç»„å°½å¯èƒ½æ‰“æ•£ï¼Œé¿å…é›†ä¸­å¯¼è‡´çƒ­ç‚¹**
  - RocketMQ ä¿è¯ç›¸åŒæ¶ˆæ¯ç»„çš„æ¶ˆæ¯å­˜å‚¨åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¦‚æœä¸åŒä¸šåŠ¡åœºæ™¯çš„æ¶ˆæ¯éƒ½é›†ä¸­åœ¨å°‘é‡æˆ–ä¸€ä¸ªæ¶ˆæ¯ç»„ä¸­ï¼Œåˆ™è¿™äº›æ¶ˆæ¯å­˜å‚¨å‹åŠ›éƒ½ä¼šé›†ä¸­åˆ°æœåŠ¡ç«¯çš„å°‘é‡é˜Ÿåˆ—æˆ–ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚å®¹æ˜“å¯¼è‡´æ€§èƒ½çƒ­ç‚¹ï¼Œä¸”ä¸åˆ©äºæ‰©å±•ã€‚ï¼ˆä¸èƒ½å……åˆ†åˆ†æ‹…æ¯ä¸ªé˜Ÿåˆ—çš„å‹åŠ›ï¼‰
  - ä¸€èˆ¬å»ºè®®æ¶ˆæ¯ç»„è®¾è®¡é‡‡ç”¨è®¢å•IDã€ç”¨æˆ·IDä½œä¸ºé¡ºåºå‚è€ƒï¼Œå³åŒä¸€ä¸ªç»ˆç«¯ç”¨æˆ·çš„æ¶ˆæ¯ä¿è¯é¡ºåºï¼Œä¸åŒç”¨æˆ·çš„æ¶ˆæ¯æ— éœ€ä¿è¯é¡ºåºã€‚å»ºè®®å°†ä¸šåŠ¡ä»¥æ¶ˆæ¯ç»„ç²’åº¦è¿›è¡Œæ‹†åˆ†ï¼Œä¾‹å¦‚ï¼Œå°†è®¢å•IDã€ç”¨æˆ·IDä½œä¸ºæ¶ˆæ¯ç»„å…³é”®å­—ï¼Œå¯å®ç°åŒä¸€ç»ˆç«¯ç”¨æˆ·çš„æ¶ˆæ¯æŒ‰ç…§é¡ºåºå¤„ç†ï¼Œä¸åŒç”¨æˆ·çš„æ¶ˆæ¯æ— éœ€ä¿è¯é¡ºåºã€‚



### å®šæ—¶/å»¶è¿Ÿæ¶ˆæ¯

ç”Ÿäº§è€…ç»™å®šæ—¶é—´æˆ³ ï¼Œå³æŒ‡å®šæ—¶é—´ç‚¹ï¼Œæäº¤ä»»åŠ¡åä¼šåœ¨è®¾å®šçš„æ—¶é—´ç‚¹æ¨é€ç»™æ¶ˆè´¹è€…ï¼›

åº•å±‚åŸºäºæ—¶é—´è½®ï¼›

tipï¼šå®šæ—¶æ¶ˆæ¯çš„å®ç°é€»è¾‘éœ€è¦å…ˆç»è¿‡å®šæ—¶å­˜å‚¨ç­‰å¾…è§¦å‘ï¼Œå®šæ—¶æ—¶é—´åˆ°è¾¾åæ‰ä¼šè¢«æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚å› æ­¤ï¼Œå¦‚æœå°†å¤§é‡å®šæ—¶æ¶ˆæ¯çš„å®šæ—¶æ—¶é—´è®¾ç½®ä¸ºåŒä¸€æ—¶åˆ»ï¼Œåˆ™åˆ°è¾¾è¯¥æ—¶åˆ»åä¼šæœ‰å¤§é‡æ¶ˆæ¯åŒæ—¶éœ€è¦è¢«å¤„ç†ï¼Œä¼šé€ æˆç³»ç»Ÿå‹åŠ›è¿‡å¤§ï¼Œå¯¼è‡´æ¶ˆæ¯åˆ†å‘å»¶è¿Ÿï¼Œå½±å“å®šæ—¶ç²¾åº¦ã€‚



### äº‹åŠ¡æ¶ˆæ¯

åŸºäºRocketMQå®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯åŠŸèƒ½ï¼Œåœ¨æ™®é€šæ¶ˆæ¯åŸºç¡€ä¸Šï¼Œæ”¯æŒ**äºŒé˜¶æ®µ**çš„æäº¤èƒ½åŠ›ã€‚å°†äºŒé˜¶æ®µæäº¤å’Œæœ¬åœ°äº‹åŠ¡ç»‘å®šï¼Œå®ç°å…¨å±€æäº¤ç»“æœçš„ä¸€è‡´æ€§ã€‚æ³¨æ„äº‹åŠ¡æ¶ˆæ¯æ˜¯é’ˆå¯¹**ç”Ÿäº§è€…**çš„ï¼Œåœ¨æ¶ˆè´¹è€…çœ‹æ¥å’Œæ™®é€šæ¶ˆæ¯ä¸€æ ·ï¼›

æ€æƒ³ï¼šä¿è¯äº†**ç”Ÿäº§è€…çš„äº‹åŠ¡**å’Œ**å‘MQå‘é€æ¶ˆæ¯**åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Œè€Œæ¶ˆè´¹è€…ä¸»è¦æ˜¯é€šè¿‡æœ¬èº«å¸¦æœ‰çš„**é‡è¯•æœºåˆ¶**æ¥å˜ç›¸åœ°ä¿è¯å…¶æˆåŠŸï¼Œå®ç°ä¸€ç§åŸºæœ¬å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„æµç¨‹ï¼ˆå¼±åŒ–ç‰ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰

#### äº‹åŠ¡æµç¨‹

![](image/rocketmq-äº‹åŠ¡æ¶ˆæ¯.png)

1. ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€è‡³RocketMQæœåŠ¡ç«¯ã€‚
2. RocketMQæœåŠ¡ç«¯å°†æ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸä¹‹åï¼Œå‘ç”Ÿäº§è€…è¿”å›**Ack**ç¡®è®¤æ¶ˆæ¯å·²ç»å‘é€æˆåŠŸï¼Œæ­¤æ—¶æ¶ˆæ¯è¢«æ ‡è®°ä¸º"æš‚ä¸èƒ½æŠ•é€’"ï¼Œè¿™ç§çŠ¶æ€ä¸‹çš„æ¶ˆæ¯å³ä¸º**åŠäº‹åŠ¡æ¶ˆæ¯**ï¼ˆåº•å±‚æ˜¯å°†è¿™äº›æ¶ˆæ¯ä¿å­˜åˆ°ä¸€äº›ç³»ç»Ÿçš„TOPICçš„é˜Ÿåˆ—ä¸­ï¼‰
3. ç”Ÿäº§è€…å¼€å§‹æ‰§è¡Œæœ¬åœ°äº‹åŠ¡é€»è¾‘ã€‚
4. ç”Ÿäº§è€…æ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœå‘æœåŠ¡ç«¯æäº¤äºŒæ¬¡ç¡®è®¤ç»“æœï¼ˆ**Commit**æˆ–æ˜¯**Rollback**ï¼‰ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°ç¡®è®¤ç»“æœåå¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š
   - äºŒæ¬¡ç¡®è®¤ç»“æœä¸º**Commit**ï¼šæœåŠ¡ç«¯å°†åŠäº‹åŠ¡æ¶ˆæ¯æ ‡è®°ä¸ºå¯æŠ•é€’ï¼Œå¹¶**æŠ•é€’**ç»™æ¶ˆè´¹è€…ã€‚
   - äºŒæ¬¡ç¡®è®¤ç»“æœä¸º**Rollback**ï¼šæœåŠ¡ç«¯å°†**å›æ»š**äº‹åŠ¡ï¼Œä¸ä¼šå°†åŠäº‹åŠ¡æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚
5. åœ¨æ–­ç½‘æˆ–è€…æ˜¯ç”Ÿäº§è€…åº”ç”¨é‡å¯çš„ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œè‹¥æœåŠ¡ç«¯æœªæ”¶åˆ°å‘é€è€…æäº¤çš„äºŒæ¬¡ç¡®è®¤ç»“æœï¼Œæˆ–æœåŠ¡ç«¯æ”¶åˆ°çš„äºŒæ¬¡ç¡®è®¤ç»“æœä¸º**Unknown**æœªçŸ¥çŠ¶æ€ï¼Œç»è¿‡å›ºå®šæ—¶é—´åï¼ŒæœåŠ¡ç«¯å°†å¯¹æ¶ˆæ¯ç”Ÿäº§è€…å³ç”Ÿäº§è€…é›†ç¾¤ä¸­ä»»ä¸€ç”Ÿäº§è€…å®ä¾‹å‘èµ·æ¶ˆæ¯**å›æŸ¥**ï¼ˆå¦‚æœæŸ¥ä¹‹åè¿˜æ˜¯**Unknown**ï¼Œå°±ç»§ç»­ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå†ä¼šæŸ¥ï¼‰

ç»¼ä¸Šï¼Œç”Ÿäº§è€…éœ€è¦å®ç°2ä¸ªæ–¹æ³•ï¼š

- **æ£€æŸ¥æœ¬åœ°äº‹åŠ¡æ–¹æ³• `executeLocalTransaction(Message msg, Object arg)` **
- **å›æŸ¥æ–¹æ³• `checkLocalTransactionState(MessageExt msg)`**



#### ä¸šåŠ¡ä¾‹å­

ä¸é€šè¿‡å»¶è¿Ÿä»»åŠ¡å»å®ç°å»¶æ—¶ï¼šä¸‹å•ç„¶åäº¤ç»™å¾®ä¿¡/æ”¯ä»˜å®ï¼Œç„¶åæäº¤åŠæ¶ˆæ¯å¹¶è¿”å›Unknownï¼›MQå›æŸ¥æ—¶è°ƒç”¨ç”Ÿäº§è€…çš„æ–¹æ³•ï¼Œé‡Œé¢å»æ£€æŸ¥æ”¯ä»˜ç³»ç»Ÿä¸­æ˜¯å¦æ”¯ä»˜ï¼Œæ²¡æ”¯ä»˜åˆ™è¿˜æ˜¯è¿”å›Unknownï¼Œæœ‰æ”¯ä»˜å°±è¿”å›Commitå°±å¯ä»¥æäº¤äº‹åŠ¡æ¶ˆæ¯ï¼Œåˆ°æ¶ˆè´¹è€…å»æ‰§è¡Œä¸‹æ¸¸æœåŠ¡ï¼›MQå›æŸ¥æœ‰ä¸€å®šçš„æ¬¡æ•°é™åˆ¶ï¼Œå›æŸ¥ä¸€å®šæ¬¡æ•°åå°±ç»“æŸï¼›

![](image/rocketmq-äº‹åŠ¡æ¶ˆæ¯-åº”ç”¨åœºæ™¯.png)



### å¸¸è§é¢è¯•é¢˜

#### MQå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±

å®¹æ˜“ä¸¢æ¶ˆæ¯çš„é˜¶æ®µï¼š

- **ç”Ÿäº§è€…å‘é€ï¼ˆè·¨ç½‘ç»œï¼‰**

  - RocketMQçš„**å•å‘å‘é€**ä¸ç®¡å‘é€ç»“æœï¼›

  - å¯ä»¥ä½¿ç”¨**åŒæ­¥å‘é€**ï¼Œè·å–è¿”å›ç»“æœï¼Œå¤±è´¥ä¼šé‡è¯•ï¼ˆå¥½åƒå¯ä»¥é…ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰ï¼Œä½†æ€§èƒ½è¾ƒä½ï¼›

    - ```java
      // å‚æ•°ï¼šæ¶ˆæ¯ + æœ€å¤§ç­‰å¾…æ—¶é—´
      SendResult res = producer.send(msg, 20 * 1000);
      ```

  - å¯ä»¥ä½¿ç”¨**å¼‚æ­¥å‘é€**ï¼Œå³é‡å†™`onSuccess`å’Œ`onException`æ–¹æ³•ï¼Œå¯ä»¥åœ¨`onException`æ–¹æ³•ä¸­å†™é‡è¯•ï¼Œæ€§èƒ½è¾ƒé«˜ï¼›

    - ä½†æ˜¯å›è°ƒæ˜¯é€šè¿‡å¼€ä¸€ä¸ª**å­çº¿ç¨‹**ï¼Œå ç”¨é«˜ï¼›è€Œä¸”å¦‚æœä¸»çº¿ç¨‹åœ¨å­çº¿ç¨‹æ”¶åˆ°å›è°ƒå‰å°±åœäº†ï¼Œé‚£å­çº¿ç¨‹ä¹Ÿåœäº†ï¼Œæ”¶ä¸åˆ°å›è°ƒä¿¡æ¯ï¼›

  - ä½¿ç”¨**äº‹åŠ¡æ¶ˆæ¯**ä¹Ÿå¯ä»¥

  - > æ‹“å±•ï¼šåœ¨RabbitMQä¸­ï¼Œæœ‰ä¸ª**ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶**ï¼Œå‘é€åå…ˆé˜»å¡ç­‰å¾…Brokerå“åº”ï¼Œæ‹¿åˆ°å“åº”åå†æ‰§è¡Œåç»­æ“ä½œï¼›åŒæ—¶ï¼Œå®ƒä¹Ÿå¯ä»¥æœ‰å¼‚æ­¥è°ƒç”¨ï¼Œè®¾ç½®æˆåŠŸ/å¤±è´¥2ç§å›è°ƒï¼›

- **æ¶ˆè´¹è€…æ‹‰å–ï¼ˆè·¨ç½‘ç»œï¼‰**

  - æœ‰**é‡è¯•**æœºåˆ¶ï¼Œä¸€èˆ¬ä¸¢å¤±çš„å¯èƒ½æ€§è¾ƒå°
  - Consumeræ”¶åˆ°æ¶ˆæ¯ä¼š**ç»™Brokerå“åº”**ï¼Œå“åº”å®Œæ‰æ›´æ–°offsetï¼Œå¦‚æœæ²¡å“åº”ï¼Œä¼šé‡æ–°æ¨é€ï¼Œæˆ–æ¨é€åˆ°å…¶ä»–Consumer

- **Brokerä¸»ä»åŒæ­¥**

  - å¦‚æœæ˜¯**æ™®é€šé›†ç¾¤**ï¼ˆå›ºå®šä¸»ä»è§’è‰²ï¼‰ï¼Œé™ä½äº†é«˜å¯ç”¨æ€§çš„æƒ…å†µä¸‹ï¼Œæé«˜äº†ä¸€å®šçš„å®‰å…¨æ€§ï¼ŒMasterä¸ä¼šåˆ‡æ¢ä¸ºslaveå¯¼è‡´å¯èƒ½åŒæ­¥åä¸¢å¤±æ•°æ®ï¼ˆç±»ä¼¼Redisçš„**è„‘è£‚**åçš„æƒ…å†µï¼‰
  - ç”¨**Dledgeré›†ç¾¤**é™¤éè„‘è£‚ï¼Œå¦åˆ™æ˜¯æ¯”è¾ƒå®‰å…¨çš„ï¼Œä½¿ç”¨äº†RAFT

- **æŒä¹…åŒ–è¿‡ç¨‹å®•æœº/æ–­ç”µ**

  - æ¶ˆæ¯ä¸€å¼€å§‹å…ˆå†™åˆ°ç¼“å­˜ä¸­ï¼ˆå†…å­˜ï¼‰ï¼Œç„¶åè¿‡ä¸€æ®µæ—¶é—´å†åˆ·ç›˜ï¼Œè€Œåœ¨ä¸­é—´è¿‡ç¨‹å¦‚æœå®•æœº/æ–­ç”µï¼Œå°±ä¼šä¸¢å¤±æ¶ˆæ¯ï¼›
  - RocketMQä¸­æœ‰é…ç½®é¡¹`flushDiskType`ï¼Œé€‰é¡¹æœ‰ï¼š
    - **åŒæ­¥åˆ·ç›˜`SYNC_FLUSH`**ï¼ˆç†è®ºä¸Šæ˜¯ä¸€æ¡æ¶ˆæ¯åˆ·ä¸€æ¬¡ç›˜ï¼Œä½†æ˜¯...ï¼‰
    - **å¼‚æ­¥åˆ·ç›˜`ASYNC_FLUSH`**ï¼ˆé»˜è®¤200msé—´éš”ï¼‰
  - åœ¨RocketMQä¸­ï¼Œå°±ç®—æ˜¯åŒæ­¥åˆ·ç›˜ï¼Œå…¶å®ä¹Ÿå¹¶ä¸æ˜¯çœŸçš„å†™ä¸€æ¬¡æ¶ˆæ¯å°±å‰§ç›˜ä¸€æ¬¡ï¼Œè¿™åœ¨æµ·é‡æ¶ˆæ¯çš„åœºæœ€ä¸‹ï¼Œæ“ä½œç³»ç»Ÿæ˜¯æ’‘ä¸ä½çš„ã€‚æ‰€ä»¥RockeMQçš„åŒæ­¥åˆ·ç›˜çš„å®ç°æ–¹å¼å…¶å®ä¹Ÿæ˜¯ä»¥**10æ¯«ç§’**çš„é—´éš”å»è°ƒç”¨åˆ·ç›˜æ“ä½œã€‚ä»ç†è®ºä¸Šæ¥è¯´ï¼Œä¹Ÿè¿˜æ˜¯ä¼šæœ‰éæ­£å¸¸æ–­ç”µé€ æˆæ¶ˆæ¯ä¸¢å¤±çš„å¯èƒ½ï¼Œä½†æ˜¯å¯èƒ½æ€§å¾ˆä½äº†ï¼›

- **MQå…¨æŒ‚äº†**
  
  - è€ƒè™‘ä½¿ç”¨é™çº§ï¼Œæ¯”å¦‚å…ˆç›´æ¥å­˜æ•°æ®åº“ï¼Œåç»­å†æ‹¿å‡ºæ•°æ®åº“çš„è®°å½•ï¼Œå¾€MQå‘æ¶ˆæ¯



#### MQå¦‚ä½•ä¿è¯æ¶ˆæ¯å¹‚ç­‰æ€§

æ¶ˆæ¯å¹‚ç­‰æ€§ï¼šç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯å’Œæ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¶ˆæ¯è¦ä¸€ä¸€åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯ç”Ÿäº§è€…å‘é€1æ¡æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…èƒ½æ­£ç¡®åœ°æ¶ˆè´¹ï¼Œä¸å¤šä¸å°‘ï¼›

**ç”Ÿäº§è€…**ï¼š

- ç”Ÿäº§è€…å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œæœ‰é‡è¯•æœºåˆ¶ï¼Œè€ŒBrokerä¼šåœ¨è¿™ä¸ªè¿‡ç¨‹è‡ªåŠ¨åšå¹‚ç­‰æ€§çš„æ£€æŸ¥
- Brokerä¼šä¸ºæ¯æ¡æ¶ˆæ¯åˆ†é…ä¸€ä¸ªå”¯ä¸€IDï¼Œå¯ä»¥æ ¹æ®IDæ£€æŸ¥æ˜¯å¦é‡å¤å‘é€ï¼›
  - å¯ä»¥åœ¨æ¶ˆè´¹è€…æ¶ˆè´¹çš„`MessageExt`å¯¹è±¡ä¸­ï¼Œçœ‹åˆ°`msgId`å±æ€§
  - ç”Ÿäº§è€…å‘å‡ºå»çš„`Message`å¯¹è±¡ä¸­æ˜¯æ²¡æœ‰çš„ï¼Œä¹Ÿå°±æ˜¯IDæ˜¯åœ¨Brokerç”Ÿæˆçš„

**æ¶ˆè´¹è€…**

- æ¶ˆè´¹è€…çš„é€»è¾‘ä¸€èˆ¬éœ€è¦è‡ªå·±æ¥å†™ï¼Œå…³é”®æ˜¯æ‰¾åˆ°**å”¯ä¸€æ€§æŒ‡æ ‡**ï¼Œæ¥æ ‡è¯†æ¯ä¸ªæ¶ˆæ¯
- å®é™…ä¸ŠRocketMQä¿è¯äº†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯ä¸ä¼šé‡å¤ï¼Œé™¤éé‡åˆ°è¾ƒç‰¹æ®Šçš„ç½‘ç»œæ³¢åŠ¨æƒ…å†µï¼›
- è‡ªå·±ç¼–å†™å¯ä»¥é€šè¿‡è·å–åˆ°`msgId`ï¼Œç¼“å­˜åˆ°æœ¬åœ°è‡ªå·±åšå¹‚ç­‰æ€§æ§åˆ¶
  - ç”šè‡³å¯ä»¥ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¤„ç†è¿‡çš„æ¶ˆæ¯ç›´æ¥æ‹’ç»
- å¦‚æœä¸ºäº†ä¿è¯ä¸‡æ— ä¸€å¤±ï¼Œå¯ä»¥è‡ªå·±çš„æ¶ˆæ¯é‡Œæ·»åŠ ä¸Šè‡ªå·±çš„å”¯ä¸€IDï¼Œä¹Ÿå¯ä»¥åœ¨`Key`ä¸Šæ·»åŠ ä¸Šè¿™ä¸ªå”¯ä¸€ID



#### MQå¦‚ä½•å¿«é€Ÿå¤„ç†ç§¯å‹çš„æ¶ˆæ¯

ä¸€èˆ¬æ¶ˆæ¯ç§¯å‹å°±æ˜¯**æ¶ˆè´¹è€…å¤„ç†é€Ÿåº¦å¤ªæ…¢**å¯¼è‡´çš„ï¼›

##### MQæœ¬èº«

RocketMQæœ¬èº«æ¶ˆæ¯ç§¯å‹èƒ½åŠ›å°±å¼ºï¼Œå› ä¸ºæ¶ˆæ¯éƒ½æ˜¯å­˜åœ¨ç£ç›˜ï¼Œæ¶ˆè´¹è€…æŒ‰ç…§ä¸åŒçš„æ¶ˆè´¹è¿›åº¦ï¼Œå³offsetï¼Œä»é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯ï¼›Kafkaä¹Ÿç±»ä¼¼ï¼›

ä½†æ˜¯ï¼Œéœ€è¦å°½é‡é¿å…æ¶ˆæ¯çš„**é•¿æœŸç§¯å‹**ï¼›

RocketMQå…·æœ‰**æ¶ˆæ¯æ¸…ç†ç­–ç•¥**

- åœ¨ broker çº§åˆ«ç»Ÿä¸€ç®¡ç†**å­˜å‚¨æ—¶é•¿**ï¼Œä¸æ¶ˆè´¹çŠ¶æ€æ— å…³ï¼Œæ—¶é—´ä¸€åˆ°å³æ¸…ç†ï¼Œä¸ç®¡æ¶ˆæ¯æ˜¯å¦è¢«æ¶ˆè´¹è¿‡ï¼›å­˜å‚¨æ—¶é•¿å¯é…ç½®ï¼›
- å½“æœ¬åœ°ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œä¸ºä¿è¯æœåŠ¡ç¨³å®šï¼ŒBroker ä¼š**å¼ºåˆ¶ä»ç‰©ç†æ–‡ä»¶ä¸­æ»šåŠ¨åˆ é™¤æœ€æ—©æ¶ˆæ¯**ï¼Œç›´è‡³ç©ºé—´æ¢å¤ï¼›

> å¯¹äºRabbitMQçš„ Classicç»å…¸é˜Ÿåˆ— å’Œ Quorumä»²è£é˜Ÿåˆ—ï¼Œå¦‚æœæ¶ˆæ¯ç§¯å‹è¿‡å¤šï¼Œä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼›ä¸è¿‡æœ‰ä¸€äº›ç‰¹æ®Šçš„é˜Ÿåˆ—ä¸ä¼šï¼Œæ¯”å¦‚æµå¼é˜Ÿåˆ—ï¼›



##### æ‰‹åŠ¨å¤„ç†

> å¯¹äºRabbitMQï¼Œå¦‚æœç§¯å‹è¿‡å¤šï¼Œå¯ä»¥ç›´æ¥é€‰æ‹©å¢åŠ æ¶ˆè´¹è€…ï¼›è€ŒRocketMQå’ŒKafkaå°±æ²¡æ³•è¿™ä¹ˆç®€å•ï¼›

RocketMQ ä¸­å¯¹äº**åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„**ï¼Œ1ä¸ª*MessageQueue*åªèƒ½ç”±1ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä¸è¿‡1ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹å¤šä¸ª*MessageQueue*ï¼›æ³¨æ„ï¼š**ä¸åŒæ¶ˆè´¹è€…ç»„**çš„æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹åŒä¸€ä¸ª*MessageQueue*ï¼Œå…·ä½“çœ‹[æ¶ˆæ¯æ¨¡å‹](#æ¶ˆæ¯æ¨¡å‹)çš„å›¾ï¼›

è¿™ç§æœºåˆ¶æ˜¯å› ä¸º1ä¸ª`offset`åœ¨ä¸€ä¸ª*MessageQueue*ä¸­ï¼Œæ˜¯ä»£è¡¨1ä¸ª**æ¶ˆè´¹è€…ç»„**çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¦‚æœåŒä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„ä¸åŒæ¶ˆè´¹è€…åŒæ—¶æ¶ˆè´¹1ä¸ª*MessageQueue*ï¼Œé‚£`offset`çš„è®¡ç®—/æäº¤ä¼šå‡ºç°ç«äº‰ï¼Œå½±å“æ€§èƒ½ï¼›

ç»¼ä¸Šï¼Œå¦‚æœå¢åŠ æ¶ˆè´¹è€…ï¼Œæœ€å¤šä¹Ÿå°±åŠ åˆ°å’Œ*MessageQueue*çš„æ•°é‡ä¸€æ ·å¤šï¼›å†å¢åŠ çš„è¯ä¹Ÿæ²¡ç”¨ï¼Œä¸ä¼šå·¥ä½œï¼›Kafkaä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼›

æ‰€ä»¥éœ€è¦è½¬æ¢æ€è·¯ï¼Œ**å¢åŠ MessageQueueçš„æ•°é‡**ï¼š

- ä¸å»ºè®®ç›´æ¥æ‰©å……åŸæœ¬Topicé‡Œçš„*MessageQueue*ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯é‡æ–°åˆ†é…ï¼Œå‡ºç°åˆ†é…ä¸å‡åŒ€ç­‰é—®é¢˜ï¼›
- å»ºè®®**æ–°å»ºä¸€ä¸ªTopic**ï¼Œè®¾ç½®æ›´å¤šçš„*MessageQueue*ï¼Œç„¶åå»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼ŒæŠŠè€Topicä¸Šçš„æ¶ˆæ¯è½¬å‘åˆ°æ–°Topicï¼ˆè½¬å‘æ“ä½œæ²¡æœ‰è¿‡å¤šçš„åŠ¨ä½œï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œæ˜¯å¯ä»¥å¤„ç†è¿‡æ¥çš„ï¼‰ï¼›å¯ä»¥ä½¿ç”¨RocketMQè‡ªå¸¦çš„**Connectç»„ä»¶**åšæ¶ˆæ¯è½¬ç§»ï¼›
  - è¿™ç§æ“ä½œä¸å»ºè®®é•¿æœŸä½¿ç”¨ï¼Œå› ä¸ºå¢åŠ äº†æ¶ˆæ¯é“¾è·¯ï¼Œä¸ç¡®å®šæ€§æ›´é«˜äº†ï¼›
  - å¯ä»¥åœ¨æ¯”å¦‚ä¿ƒé”€æ´»åŠ¨çš„æ—¶å€™ç”¨ï¼Œä¸´æ—¶åšä¸Šé¢çš„å¤„ç†ï¼Œæ´»åŠ¨ç»“æŸæ¢å¤æˆåŸæ¥çš„ï¼›
